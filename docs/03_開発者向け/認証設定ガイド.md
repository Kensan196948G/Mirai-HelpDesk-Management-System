# 認証設定ガイド

## Azure AD アプリケーション登録

### 1. アプリケーション登録

```
1. Azure Portal (https://portal.azure.com) にアクセス
2. Azure Active Directory > App registrations > New registration
3. 名前: Mirai-HelpDesk-API
4. サポートされているアカウントの種類:
   「この組織ディレクトリのみのアカウント」
5. Register
```

### 2. API権限設定

```
1. API permissions > Add a permission
2. Microsoft Graph > Application permissions
3. 以下の権限を追加:
   - User.ReadWrite.All
   - Group.ReadWrite.All
   - Directory.ReadWrite.All
   - Mail.ReadWrite
   - Sites.ReadWrite.All
4. Grant admin consent（管理者の同意）
```

### 3. クライアントシークレット作成

```
1. Certificates & secrets > New client secret
2. Description: HelpDesk API Secret
3. Expires: 24 months
4. Add
5. シークレット値をコピー（この画面でしか表示されません）
```

### 4. 環境変数設定

```bash
# backend/.env
AZURE_TENANT_ID=xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx
AZURE_CLIENT_ID=xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx
AZURE_CLIENT_SECRET=your-client-secret-value
```

## JWT認証設定

### JWT シークレット生成

```bash
# 安全なランダム文字列を生成
node -e "console.log(require('crypto').randomBytes(64).toString('hex'))"
```

### 環境変数

```bash
# backend/.env
JWT_SECRET=your-generated-secret-here
JWT_EXPIRES_IN=24h
JWT_REFRESH_EXPIRES_IN=7d
```

## よくあるエラー

### エラー1: AADSTS7000215: Invalid client secret

**原因**: クライアントシークレットが間違っている

**解決方法**: Azure Portalで新しいシークレットを作成し、環境変数を更新

### エラー2: Insufficient privileges

**原因**: API権限に管理者の同意がない

**解決方法**: Azure Portal > App registrations > API permissions > Grant admin consent

### エラー3: Token expired

**原因**: アクセストークンの有効期限切れ

**解決方法**: Refresh tokenを使用して新しいアクセストークンを取得

## セキュリティベストプラクティス

```
1. シークレットをGitにコミットしない
2. 定期的にシークレットをローテーション
3. 最小権限の原則を遵守
4. アクセスログを監視
```
