# データベーススキーマ

## 主要テーブル

### users（ユーザー）
```sql
CREATE TABLE users (
    user_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    email VARCHAR(255) UNIQUE NOT NULL,
    display_name VARCHAR(255) NOT NULL,
    department VARCHAR(100),
    role VARCHAR(50) NOT NULL,
    status VARCHAR(20) DEFAULT 'active',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### tickets（チケット）
```sql
CREATE TABLE tickets (
    ticket_id SERIAL PRIMARY KEY,
    ticket_number VARCHAR(20) UNIQUE NOT NULL,
    type VARCHAR(50) NOT NULL,
    subject VARCHAR(500) NOT NULL,
    description TEXT,
    status VARCHAR(50) NOT NULL DEFAULT 'new',
    priority VARCHAR(10) NOT NULL,
    impact VARCHAR(50) NOT NULL,
    urgency VARCHAR(50) NOT NULL,
    category_id INT REFERENCES categories(category_id),
    requester_id UUID REFERENCES users(user_id),
    assignee_id UUID REFERENCES users(user_id),
    sla_policy_id INT REFERENCES sla_policies(sla_policy_id),
    due_at TIMESTAMP,
    resolved_at TIMESTAMP,
    closed_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### ticket_history（履歴 - 追記専用）
```sql
CREATE TABLE ticket_history (
    history_id SERIAL PRIMARY KEY,
    ticket_id INT REFERENCES tickets(ticket_id),
    actor_id UUID REFERENCES users(user_id),
    action VARCHAR(100) NOT NULL,
    before_value TEXT,
    after_value TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 追記専用トリガー（UPDATE/DELETE禁止）
CREATE TRIGGER prevent_ticket_history_modification
BEFORE UPDATE OR DELETE ON ticket_history
FOR EACH ROW EXECUTE FUNCTION prevent_modification();
```

### approvals（承認）
```sql
CREATE TABLE approvals (
    approval_id SERIAL PRIMARY KEY,
    ticket_id INT REFERENCES tickets(ticket_id),
    requester_id UUID REFERENCES users(user_id),
    approver_id UUID REFERENCES users(user_id),
    approval_type VARCHAR(100),
    requested_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    responded_at TIMESTAMP,
    status VARCHAR(20) DEFAULT 'requested',
    reason TEXT,
    conditions TEXT
);
```

### m365_execution_logs（M365実施ログ - 追記専用）
```sql
CREATE TABLE m365_execution_logs (
    log_id SERIAL PRIMARY KEY,
    ticket_id INT REFERENCES tickets(ticket_id),
    task_id INT REFERENCES m365_tasks(task_id),
    operator_id UUID REFERENCES users(user_id),
    task_type VARCHAR(100) NOT NULL,
    target_upn VARCHAR(255),
    target_resource_id VARCHAR(255),
    method VARCHAR(50),
    command_or_screen TEXT,
    result VARCHAR(50) NOT NULL,
    result_detail TEXT,
    evidence_attachment_id INT REFERENCES ticket_attachments(attachment_id),
    rollback_procedure TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 追記専用トリガー
CREATE TRIGGER prevent_m365_log_modification
BEFORE UPDATE OR DELETE ON m365_execution_logs
FOR EACH ROW EXECUTE FUNCTION prevent_modification();
```

## ER図

```
users 1---* tickets (requester_id)
users 1---* tickets (assignee_id)
tickets 1---* ticket_comments
tickets 1---* ticket_attachments
tickets 1---* ticket_history
tickets 1---* approvals
tickets 1---* m365_tasks
m365_tasks 1---* m365_execution_logs
```

## インデックス

```sql
-- チケット検索用
CREATE INDEX idx_tickets_status ON tickets(status);
CREATE INDEX idx_tickets_priority ON tickets(priority);
CREATE INDEX idx_tickets_assignee ON tickets(assignee_id);
CREATE INDEX idx_tickets_created_at ON tickets(created_at DESC);

-- 履歴検索用
CREATE INDEX idx_ticket_history_ticket ON ticket_history(ticket_id);
CREATE INDEX idx_ticket_history_created ON ticket_history(created_at DESC);

-- M365ログ検索用
CREATE INDEX idx_m365_logs_ticket ON m365_execution_logs(ticket_id);
CREATE INDEX idx_m365_logs_operator ON m365_execution_logs(operator_id);
CREATE INDEX idx_m365_logs_created ON m365_execution_logs(created_at DESC);
```

完全なスキーマは `/database/migrations/` を参照してください。
