# セキュリティベストプラクティス

## 認証・認可

### JWT トークン管理

```javascript
// ✅ 良い例
const token = localStorage.getItem('token');
axios.defaults.headers.common['Authorization'] = `Bearer ${token}`;

// ❌ 悪い例：トークンをURLパラメータで送信
axios.get(`/api/tickets?token=${token}`); // 絶対にしない
```

### パスワード保存

```javascript
// ✅ 良い例：bcrypt使用
const bcrypt = require('bcrypt');
const saltRounds = 10;
const hashedPassword = await bcrypt.hash(password, saltRounds);

// ❌ 悪い例：平文保存
const password = 'password123'; // 絶対にしない
```

## 入力検証

### SQLインジェクション対策

```javascript
// ✅ 良い例：パラメータ化クエリ
const result = await pool.query(
  'SELECT * FROM tickets WHERE ticket_id = $1',
  [ticketId]
);

// ❌ 悪い例：文字列連結
const query = `SELECT * FROM tickets WHERE ticket_id = ${ticketId}`; // 脆弱
```

### XSS対策

```javascript
// ✅ 良い例：エスケープ処理
import DOMPurify from 'dompurify';
const clean = DOMPurify.sanitize(userInput);

// ❌ 悪い例：直接HTML挿入
element.innerHTML = userInput; // 脆弱
```

## PIIデータの取り扱い

### マスキング

```javascript
// メールアドレスのマスキング
function maskEmail(email) {
  const [local, domain] = email.split('@');
  return `${local[0]}${'*'.repeat(local.length - 2)}${local.slice(-1)}@${domain}`;
}

// 例: tanaka@company.com → t****a@company.com
```

### ログ記録

```javascript
// ✅ 良い例：機密情報を除外
logger.info('User login', { userId, email: maskEmail(email) });

// ❌ 悪い例：パスワードをログに記録
logger.info('User login', { email, password }); // 絶対にしない
```

## セキュアな環境変数管理

### .env ファイル

```bash
# ✅ 良い例
# .gitignoreに追加
echo ".env" >> .gitignore

# ❌ 悪い例
git add .env  # 絶対にしない
```

### シークレット管理

```javascript
// ✅ 良い例
const jwtSecret = process.env.JWT_SECRET;
if (!jwtSecret) {
  throw new Error('JWT_SECRET is not defined');
}

// ❌ 悪い例
const jwtSecret = 'hardcoded-secret-123'; // 絶対にしない
```

## セキュリティヘッダー

### Helmet.js 使用

```javascript
const helmet = require('helmet');
app.use(helmet());

app.use(helmet.contentSecurityPolicy({
  directives: {
    defaultSrc: ["'self'"],
    styleSrc: ["'self'", "'unsafe-inline'"],
    scriptSrc: ["'self'"]
  }
}));
```

## レート制限

### express-rate-limit

```javascript
const rateLimit = require('express-rate-limit');

const limiter = rateLimit({
  windowMs: 15 * 60 * 1000, // 15分
  max: 100 // 最大100リクエスト
});

app.use('/api/', limiter);
```

## CORS設定

```javascript
const cors = require('cors');

app.use(cors({
  origin: process.env.FRONTEND_URL || 'http://localhost:5173',
  credentials: true
}));
```

## 監査ログ

### 重要操作の記録

```javascript
async function logSecurityEvent(action, userId, details) {
  await pool.query(
    `INSERT INTO security_logs (action, user_id, details, created_at)
     VALUES ($1, $2, $3, NOW())`,
    [action, userId, JSON.stringify(details)]
  );
}

// 使用例
await logSecurityEvent('M365_LICENSE_CHANGE', operatorId, {
  target: userPrincipalName,
  license: 'E5',
  approved: true
});
```

## セキュリティチェックリスト

開発時に以下を確認:

```
□ 認証トークンは安全に保存されている
□ パスワードはハッシュ化されている
□ SQLクエリはパラメータ化されている
□ ユーザー入力はバリデーションされている
□ 機密情報はログに記録されていない
□ 環境変数は.gitignoreに含まれている
□ セキュリティヘッダーが設定されている
□ レート制限が実装されている
□ CORSが適切に設定されている
□ 重要操作は監査ログに記録されている
```

## 脆弱性スキャン

```bash
# npm audit
npm audit

# 高リスクの脆弱性のみ表示
npm audit --audit-level=high

# 自動修正
npm audit fix
```

## 参考リソース

- OWASP Top 10: https://owasp.org/www-project-top-ten/
- Node.js Security Best Practices: https://nodejs.org/en/docs/guides/security/
