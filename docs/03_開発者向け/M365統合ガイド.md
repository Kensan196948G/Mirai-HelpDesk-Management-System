# M365統合ガイド

> **Note**: 詳細な実装ガイドは [/M365_INTEGRATION_GUIDE.md](../../M365_INTEGRATION_GUIDE.md) を参照してください。

## Graph API統合パターン

### 認証方式

**Client Credentials Flow（非対話型）**を使用します。

```javascript
// backend/src/services/m365Service.js
const { Client } = require("@microsoft/microsoft-graph-client");
require("isomorphic-fetch");

const getGraphClient = () => {
  return Client.init({
    authProvider: (done) => {
      // Azure ADからアクセストークンを取得
      const tokenRequest = {
        scopes: ["https://graph.microsoft.com/.default"],
      };

      confidentialClientApplication
        .acquireTokenByClientCredential(tokenRequest)
        .then((response) => {
          done(null, response.accessToken);
        });
    },
  });
};
```

### 必要な権限

```
User.ReadWrite.All
Group.ReadWrite.All
Directory.ReadWrite.All
```

## 実装例

### ライセンス付与

```javascript
async function assignLicense(userPrincipalName, skuId) {
  const client = getGraphClient();

  try {
    await client
      .api(`/users/${userPrincipalName}/assignLicense`)
      .post({
        addLicenses: [{ skuId: skuId }],
        removeLicenses: []
      });

    return { success: true };
  } catch (error) {
    console.error('License assignment failed:', error);
    throw error;
  }
}
```

### パスワードリセット

```javascript
async function resetPassword(userPrincipalName) {
  const client = getGraphClient();

  const temporaryPassword = generateSecurePassword();

  try {
    await client
      .api(`/users/${userPrincipalName}`)
      .update({
        passwordProfile: {
          forceChangePasswordNextSignIn: true,
          password: temporaryPassword
        }
      });

    return { success: true, temporaryPassword };
  } catch (error) {
    console.error('Password reset failed:', error);
    throw error;
  }
}
```

### グループメンバー追加

```javascript
async function addGroupMember(groupId, userId) {
  const client = getGraphClient();

  try {
    await client
      .api(`/groups/${groupId}/members/$ref`)
      .post({
        "@odata.id": `https://graph.microsoft.com/v1.0/users/${userId}`
      });

    return { success: true };
  } catch (error) {
    console.error('Add group member failed:', error);
    throw error;
  }
}
```

## トラブルシューティング

### エラー1: 403 Forbidden

**原因**: 権限不足

**解決方法**:
```
1. Azure Portal > App registrations > API permissions
2. 必要な権限を追加
3. 管理者の同意を付与
```

### エラー2: Token取得失敗

**原因**: 環境変数が未設定

**解決方法**:
```bash
# .env
AZURE_TENANT_ID=your-tenant-id
AZURE_CLIENT_ID=your-client-id
AZURE_CLIENT_SECRET=your-client-secret
```

完全な実装ガイドは [/M365_INTEGRATION_GUIDE.md](../../M365_INTEGRATION_GUIDE.md) を参照してください。
