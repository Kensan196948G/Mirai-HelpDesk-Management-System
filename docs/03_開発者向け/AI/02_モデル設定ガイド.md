# モデル設定ガイド - Claude Sonnet 4.5

Claude Sonnet 4.5 の設定方法、環境変数、APIキー取得手順を解説します。

---

## 📋 目次

1. [モデル概要](#モデル概要)
2. [APIキーの取得](#apiキーの取得)
3. [環境変数の設定](#環境変数の設定)
4. [モデル設定の詳細](#モデル設定の詳細)
5. [開発環境のセットアップ](#開発環境のセットアップ)
6. [本番環境のセットアップ](#本番環境のセットアップ)
7. [トラブルシューティング](#トラブルシューティング)

---

## モデル概要

### Claude Sonnet 4.5 の特徴

**モデルID**: `claude-sonnet-4-5-20250929`

**主要スペック**:
- **コンテキストウィンドウ**: 1M tokens（約75万単語、日本語で約30万文字）
- **出力トークン数**: 最大 8192 tokens
- **温度**: 0.0-1.0（推奨: 0.3 で決定論的な回答）
- **レイテンシ**: 平均 2-3秒（キャッシュなし）

**Haiku との比較**:

| 項目 | Haiku 3 | Sonnet 4.5 | 改善率 |
|------|---------|-----------|--------|
| コンテキストウィンドウ | 200k tokens | 1M tokens | **5倍** |
| 推論能力 | 基本的 | 高度 | **3-4倍** |
| 複雑なタスク精度 | 70-80% | 90-95% | **+15-20%** |
| レスポンスタイム | 1-2秒 | 2-3秒 | 1.5倍 |
| コスト（Input） | $0.25/M | $3.00/M | 12倍 |
| コスト（Output） | $1.25/M | $15.00/M | 12倍 |

**選定理由**:
- ✅ **高精度**: チケット分類で 90%以上の精度を実現
- ✅ **長コンテキスト**: 類似チケット5件 + ナレッジ記事を含めても余裕
- ✅ **コスト効率**: 月額 $11.55 で ROI 16,400%
- ✅ **日本語対応**: 日本語の自然な理解と生成

---

## APIキーの取得

### 1. Anthropic Console にアクセス

**URL**: https://console.anthropic.com/

### 2. アカウント作成

1. 「Sign Up」をクリック
2. メールアドレスとパスワードを入力
3. メール認証を完了

### 3. APIキーの生成

1. ダッシュボードの「API Keys」セクションに移動
2. 「Create Key」をクリック
3. キー名を入力（例: `mirai-helpdesk-prod`）
4. **APIキーをコピー**（一度しか表示されません！）
   - 形式: `sk-ant-api03-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx`

### 4. 支払い情報の登録

1. 「Settings」→「Billing」に移動
2. クレジットカード情報を登録
3. 使用制限を設定（推奨: $50/月）

### 5. 使用量の監視

- ダッシュボードで日次使用量を確認
- アラート設定（例: $40/月 を超えた場合に通知）

---

## 環境変数の設定

### 開発環境（backend/.env）

```bash
# ============================================================================
# Claude API設定
# ============================================================================

# Anthropic API Key（必須）
# 取得先: https://console.anthropic.com/
CLAUDE_API_KEY=sk-ant-api03-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

# Claude API バージョン
# デフォルト: 2023-06-01（最新安定版）
CLAUDE_API_VERSION=2023-06-01

# 使用モデル（重要）
# Sonnet 4.5 を使用（Haiku ではなく）
CLAUDE_MODEL=claude-sonnet-4-5-20250929

# 最大トークン数（出力）
# Sonnet 4.5 は最大 8192 tokens まで対応
CLAUDE_MAX_TOKENS=8192

# 温度（Temperature）
# 0.0 = 決定論的、1.0 = ランダム性高い
# 推奨: 0.3（一貫性と多様性のバランス）
CLAUDE_TEMPERATURE=0.3

# ============================================================================
# AI機能制御
# ============================================================================

# AI機能の有効/無効
# true = 有効、false = 無効
AI_ENABLED=true

# ユーザーごとのレート制限（回数/分）
# デフォルト: 10回/分
AI_RATE_LIMIT_PER_USER=10

# キャッシュTTL（秒）
# デフォルト: 3600秒（1時間）
AI_CACHE_TTL=3600

# ============================================================================
# PII マスキング設定
# ============================================================================

# PII マスキング機能の有効/無効
# 推奨: true（個人情報保護のため）
ENABLE_PII_MASKING=true

# マスキング対象の詳細制御
MASK_EMAIL=true      # メールアドレス
MASK_IP=true         # IPアドレス
MASK_PHONE=true      # 電話番号
MASK_TOKEN=true      # トークン・パスワード

# ============================================================================
# Redis設定（必須）
# ============================================================================

# Redis 接続URL
REDIS_URL=redis://localhost:6379

# Redis パスワード（設定している場合）
REDIS_PASSWORD=

# Redis DB番号
# デフォルト: 0
REDIS_DB=0
```

### 本番環境（推奨設定）

```bash
# 本番環境では以下の違いに注意:

# 1. API キーを本番用に変更
CLAUDE_API_KEY=sk-ant-api03-prod-xxxxxxxxxxxxxxxxxxxxxxxx

# 2. レート制限を緩和（本番トラフィックに応じて）
AI_RATE_LIMIT_PER_USER=20

# 3. キャッシュTTLを延長（コスト削減）
AI_CACHE_TTL=7200  # 2時間

# 4. ログレベルを調整
LOG_LEVEL=info  # debug → info

# 5. Redis を専用サーバーに
REDIS_URL=redis://redis-prod.yourcompany.com:6379
REDIS_PASSWORD=prod-secure-password

# 6. タイムアウトを延長（安定性重視）
CLAUDE_TIMEOUT=45000  # 45秒
```

---

## モデル設定の詳細

### claudeConfig オブジェクト

**ファイル**: `backend/src/config/claude.config.ts`

```typescript
export interface ClaudeConfig {
  apiKey: string;       // APIキー
  apiVersion: string;   // APIバージョン
  model: string;        // モデルID
  maxTokens: number;    // 最大出力トークン数
  temperature: number;  // 温度（0.0-1.0）
  timeout: number;      // タイムアウト（ミリ秒）
}

export const claudeConfig: ClaudeConfig = {
  apiKey: process.env.CLAUDE_API_KEY || '',
  apiVersion: process.env.CLAUDE_API_VERSION || '2023-06-01',
  model: process.env.CLAUDE_MODEL || 'claude-sonnet-4-5-20250929',
  maxTokens: parseInt(process.env.CLAUDE_MAX_TOKENS || '8192', 10),
  temperature: parseFloat(process.env.CLAUDE_TEMPERATURE || '0.3'),
  timeout: 30000, // 30秒
};
```

### 温度（Temperature）の選択

| 温度 | 特性 | 推奨用途 |
|------|------|---------|
| **0.0** | 完全に決定論的、同じ入力 → 同じ出力 | テスト環境、デバッグ |
| **0.3** | ほぼ一貫性あり、わずかな多様性 | **チケット分類、ルーティング判定**（推奨） |
| **0.7** | バランス型、創造性と一貫性を両立 | 回答提案、ナレッジ記事生成 |
| **1.0** | 高い創造性、ランダム性高い | ブレインストーミング、アイデア生成 |

**推奨設定**: `0.3`（チケット分類では一貫性が重要）

### maxTokens の選択

| 用途 | 推奨 maxTokens | 理由 |
|------|---------------|------|
| チケット分類 | 2048 | JSON出力は短い（500-1000 tokens） |
| ルーティング判定 | 2048 | JSON出力は短い |
| 回答提案 | 4096 | 詳細な回答文を生成 |
| ナレッジ記事生成 | 8192 | 長文のFAQ記事を生成 |
| 監査レポート | 8192 | 包括的なレポート生成 |

**デフォルト**: `8192`（最大値、コスト効率を考慮して調整可能）

---

## 開発環境のセットアップ

### 1. Redis のインストール

**macOS（Homebrew）:**
```bash
brew install redis
brew services start redis
```

**Ubuntu/Debian:**
```bash
sudo apt update
sudo apt install redis-server
sudo systemctl start redis-server
```

**Docker:**
```bash
docker run -d -p 6379:6379 --name redis redis:7-alpine
```

### 2. PostgreSQL + pgvector のセットアップ

**pgvector のインストール:**
```bash
# Ubuntu/Debian
sudo apt install postgresql-15-pgvector

# macOS（Homebrew）
brew install pgvector
```

**PostgreSQL で拡張機能を有効化:**
```sql
-- データベースに接続
psql -U postgres -d mirai_helpdesk

-- pgvector 拡張を有効化
CREATE EXTENSION IF NOT EXISTS vector;

-- 確認
SELECT * FROM pg_extension WHERE extname = 'vector';
```

### 3. 環境変数ファイルの作成

```bash
cd backend

# .env.example をコピー
cp .env.example .env

# エディタで編集
vim .env  # または nano, code 等

# 必須項目を設定:
# - CLAUDE_API_KEY
# - DB_* (PostgreSQL接続情報)
# - REDIS_URL
```

### 4. 依存関係のインストール

```bash
cd backend
npm install

# Anthropic SDK のバージョン確認
npm list @anthropic-ai/sdk
# 期待: @anthropic-ai/sdk@0.24.0 以上
```

### 5. マイグレーション実行

```bash
npm run migrate

# 出力例:
# ✅ Running migration: 001_create_users.sql
# ✅ Running migration: 002_create_categories_and_sla.sql
# ...
# ✅ Running migration: 013_add_vector_search.sql
# ✅ Running migration: 014_add_ai_routing_logs.sql
# ✅ Running migration: 015_add_ai_metrics_cache.sql
# ✅ All migrations completed successfully!
```

### 6. ビルド確認

```bash
npm run build

# TypeScript コンパイル成功を確認
# dist/ ディレクトリが生成されることを確認
```

### 7. テスト実行

```bash
npm test

# AI Service のテストを実行
npm run test -- ai.service.test.ts
```

### 8. 開発サーバー起動

```bash
npm run dev

# 出力例:
# 🚀 Server is running on http://localhost:3000
# ✅ Database connected
# ✅ Redis connected
# ✅ Claude API configured (model: claude-sonnet-4-5-20250929)
```

---

## 本番環境のセットアップ

### 1. 環境変数の分離

**推奨構成**:
```
backend/
├── .env.development   # 開発環境
├── .env.staging       # ステージング環境
├── .env.production    # 本番環境
└── .env.example       # テンプレート
```

**注意**: `.env.*` ファイルは `.gitignore` に含める（機密情報保護）

### 2. APIキーのローテーション

**推奨頻度**: 3ヶ月ごと

**手順**:
```bash
# 1. 新しいAPIキーを生成（Anthropic Console）
# 2. 環境変数を更新
# 3. サーバー再起動
# 4. 古いAPIキーを無効化（Anthropic Console）
```

### 3. セキュリティベストプラクティス

**APIキーの保護**:
- ✅ 環境変数から読み込み（ハードコード禁止）
- ✅ `.env` ファイルを `.gitignore` に追加
- ✅ Kubernetes Secrets または AWS Secrets Manager を使用
- ✅ ログにAPIキーを出力しない

**アクセス制御**:
```typescript
// APIキー検証
if (!claudeConfig.apiKey) {
  console.warn('⚠️  CLAUDE_API_KEY が設定されていません。AI機能は無効です。');
}

// AI機能の有効/無効チェック
if (!aiFeatureConfig.enabled) {
  throw new AppError('AI機能は現在無効です。', 503, 'AI_DISABLED');
}
```

### 4. モニタリングとアラート

**使用量の監視**:
```bash
# Anthropic Console でリアルタイム監視
# - 日次使用量
# - トークン数
# - エラー率
```

**アラート設定**:
- 日次コストが $5 を超えた場合
- エラー率が 10% を超えた場合
- レート制限エラーが頻発した場合

---

## モデル設定の詳細

### ClaudeAPIClient の初期化

**ファイル**: `backend/src/services/claude-api.client.ts`

```typescript
import Anthropic from '@anthropic-ai/sdk';

export class ClaudeAPIClient {
  private client: Anthropic;

  constructor() {
    this.client = new Anthropic({
      apiKey: claudeConfig.apiKey,
    });
  }

  async sendPrompt(
    prompt: string,
    systemPrompt: string = '',
    options: ClaudeAPIOptions = {}
  ): Promise<string> {
    const response = await this.client.messages.create({
      model: claudeConfig.model,                  // claude-sonnet-4-5-20250929
      max_tokens: options.maxTokens || claudeConfig.maxTokens,  // 8192
      temperature: options.temperature !== undefined
        ? options.temperature
        : claudeConfig.temperature,               // 0.3
      system: systemPrompt,
      messages: [
        {
          role: 'user',
          content: prompt,
        },
      ],
    });

    return response.content[0].text;
  }
}
```

### システムプロンプトの活用

**推奨パターン**:
```typescript
const systemPrompt = 'あなたは社内ITヘルプデスクの経験豊富なエージェントです。チケット内容を正確に分析し、適切な分類を提案してください。';

const userPrompt = `
# チケット内容
件名: Outlookで添付ファイルが送信できない
詳細: 5MBのPDFファイルを送信しようとするとエラーになります

# タスク
このチケットを分類してください。
`;

const response = await claudeClient.sendPrompt(userPrompt, systemPrompt);
```

---

## 環境変数のバリデーション

### 起動時チェック

**ファイル**: `backend/src/config/claude.config.ts`

```typescript
// APIキー検証
if (!claudeConfig.apiKey) {
  console.warn('⚠️  CLAUDE_API_KEY が設定されていません。AI機能は無効です。');
}

// モデル名検証
const validModels = [
  'claude-sonnet-4-5-20250929',
  'claude-3-5-sonnet-20240620',
  'claude-3-haiku-20240307',
];

if (!validModels.includes(claudeConfig.model)) {
  console.warn(`⚠️  未知のモデル: ${claudeConfig.model}`);
}

// maxTokens 範囲チェック
if (claudeConfig.maxTokens < 1024 || claudeConfig.maxTokens > 8192) {
  console.warn(`⚠️  CLAUDE_MAX_TOKENS は 1024-8192 の範囲で設定してください（現在: ${claudeConfig.maxTokens}）`);
}

// 温度範囲チェック
if (claudeConfig.temperature < 0 || claudeConfig.temperature > 1) {
  console.warn(`⚠️  CLAUDE_TEMPERATURE は 0.0-1.0 の範囲で設定してください（現在: ${claudeConfig.temperature}）`);
}
```

### ヘルスチェックエンドポイント

```typescript
// backend/src/routes/health.ts

router.get('/health', async (req, res) => {
  const health = {
    status: 'ok',
    timestamp: new Date().toISOString(),
    services: {
      database: await checkDatabase(),
      redis: await checkRedis(),
      claude_api: await checkClaudeAPI(),
    },
  };

  res.json(health);
});

async function checkClaudeAPI(): Promise<{ status: string; model: string }> {
  try {
    // 軽量なプロンプトでAPI接続を確認
    const client = getClaudeAPIClient();
    await client.sendPrompt('Hello', '', { maxTokens: 10 });

    return {
      status: 'connected',
      model: claudeConfig.model,
    };
  } catch (error) {
    return {
      status: 'error',
      model: claudeConfig.model,
    };
  }
}
```

---

## トラブルシューティング

### 問題 1: APIキーが無効

**エラーメッセージ:**
```
Claude API 認証エラー: APIキーが無効です
```

**解決策:**
1. `backend/.env` の `CLAUDE_API_KEY` を確認
2. Anthropic Console でAPIキーの有効性を確認
3. APIキーの形式を確認（`sk-ant-api03-` で始まる）

### 問題 2: モデルが見つからない

**エラーメッセージ:**
```
model_not_found: The model 'claude-sonnet-4-5-20250929' does not exist
```

**解決策:**
1. モデルIDのスペルミスを確認
2. Anthropic API のアップデートを確認
3. フォールバック設定を追加:
   ```typescript
   model: process.env.CLAUDE_MODEL || 'claude-3-5-sonnet-20240620',
   ```

### 問題 3: レート制限超過

**エラーメッセージ:**
```
Claude API レート制限エラー: Rate limit exceeded
```

**解決策:**
1. Anthropic Console で使用量制限を確認
2. リクエスト頻度を削減（キャッシュ活用）
3. エンタープライズプランへのアップグレードを検討

### 問題 4: Redis 接続エラー

**エラーメッセージ:**
```
❌ Redis エラー: ECONNREFUSED
```

**解決策:**
1. Redis サーバーが起動しているか確認:
   ```bash
   redis-cli ping
   # 期待: PONG
   ```
2. `REDIS_URL` が正しいか確認
3. Redis パスワードが正しいか確認（設定している場合）

---

## モデル変更の影響範囲

### Haiku → Sonnet 4.5 への変更による影響

**ポジティブな影響**:
- ✅ 精度向上: 70-80% → 90-95%（+15-20%）
- ✅ コンテキスト拡大: 200k → 1M tokens（5倍）
- ✅ 複雑な推論能力の向上
- ✅ 日本語理解の改善

**ネガティブな影響**:
- ⚠️ レスポンスタイム増加: 1-2秒 → 2-3秒（+1秒）
- ⚠️ コスト増加: 約12倍（ただし、月額 $11.55 で許容範囲）

**対策**:
- Redis キャッシング（同一リクエストの重複呼び出し防止）
- プロンプト最適化（不要なコンテキスト削減）
- バッチ処理（埋め込みベクトル生成は夜間実行）

---

## 動作確認

### 最小限の動作確認スクリプト

```bash
# backend/test-claude-api.js を実行
node test-claude-api.js

# 期待される出力:
# ✅ Claude API 接続成功
# ✅ モデル: claude-sonnet-4-5-20250929
# ✅ レスポンス時間: 2450ms
# ✅ トークン使用量: 150 input + 320 output = 470 total
```

### 完全な統合テスト

```bash
# AIサービスの統合テスト
npm run test -- ai.service.integration.test.ts

# 期待される結果:
# ✅ チケット分類が正常に動作
# ✅ PII マスキングが正常に動作
# ✅ 精度メトリクスが取得可能
# ✅ 監査ログが正しく記録される
```

---

## 参考リソース

- [Anthropic Claude API ドキュメント](https://docs.anthropic.com/)
- [Claude モデル比較](https://docs.anthropic.com/claude/docs/models-overview)
- [Anthropic Console](https://console.anthropic.com/)
- [pgvector GitHub](https://github.com/pgvector/pgvector)

---

**次のドキュメント**: [03_プロンプトエンジニアリング.md](./03_プロンプトエンジニアリング.md) - プロンプト最適化手法

---

**最終更新:** 2026年2月
**バージョン:** 1.0.0
