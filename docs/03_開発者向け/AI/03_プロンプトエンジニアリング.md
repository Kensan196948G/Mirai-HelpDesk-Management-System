# プロンプトエンジニアリング

AI機能の精度を最大化するためのプロンプト設計・最適化手法を解説します。

---

## 📋 目次

1. [基本原則](#基本原則)
2. [構造化プロンプト設計](#構造化プロンプト設計)
3. [日本語最適化](#日本語最適化)
4. [精度向上テクニック](#精度向上テクニック)
5. [プロンプトテンプレート詳解](#プロンプトテンプレート詳解)
6. [Few-shot Learning](#few-shot-learning)
7. [Chain-of-Thought](#chain-of-thought)
8. [評価と改善](#評価と改善)

---

## 基本原則

### 1. 明確な役割定義

**Good ✅:**
```
あなたは社内ITヘルプデスクの経験豊富なエージェントです。
10年以上のインシデント対応経験があり、Microsoft 365 の専門知識を持っています。
```

**Bad ❌:**
```
チケットを分類してください。
```

**理由**: 役割を明確にすることで、AIが適切なコンテキストで回答を生成します。

---

### 2. タスクの具体化

**Good ✅:**
```
以下のチケット内容を分析し、JSON形式で以下を予測してください：
1. category_id: 最も適切なカテゴリのUUID
2. priority: P1（最高）からP4（最低）
3. confidence_score: 各予測の信頼度（0.0-1.0）
```

**Bad ❌:**
```
このチケットについて教えてください。
```

**理由**: 期待する出力形式を明示することで、パース可能な構造化データを取得できます。

---

### 3. 出力形式の強制

**Good ✅:**
```
# 出力形式（必ずこの形式で回答してください）
\`\`\`json
{
  "category": {
    "value": "uuid",
    "confidence": 0.92,
    "reasoning": "..."
  }
}
\`\`\`

**重要**: JSON以外の説明文は不要です。必ず上記フォーマットの JSON のみを返してください。
```

**Bad ❌:**
```
結果を教えてください。
```

**理由**: JSON形式を強制することで、フロントエンドでのパースエラーを防止します。

---

## 構造化プロンプト設計

### 推奨テンプレート構造

```typescript
const prompt = `
# 役割定義
あなたは[専門分野]の[役割]です。

# 入力データ
[コンテキスト情報]

# 参考情報（オプション）
[類似ケース、ルール、ナレッジベース等]

# タスク
[具体的な指示]

# 制約条件（オプション）
- [制約1]
- [制約2]

# 出力形式
\`\`\`json
{
  // 期待する構造
}
\`\`\`

**重要**: [追加の注意事項]
`;
```

### 実装例: チケット分類プロンプト

```typescript
export const promptTemplates = {
  ticketClassification: `あなたは社内ITヘルプデスクの経験豊富なエージェントです。
以下のチケット内容を分析し、適切な分類を提案してください。

# チケット内容
件名: {subject}
詳細: {description}

# 利用可能なカテゴリ
{categories}

# 過去の類似チケット（参考）
{similar_tickets}

# タスク
以下の項目を予測し、JSON形式で回答してください：

1. **category_id**: 最も適切なカテゴリのUUID
2. **priority**: P1（最高）からP4（最低）の優先度
3. **impact**: individual（個人）/ department（部署）/ company_wide（全社）/ external（対外影響）
4. **urgency**: low（低）/ medium（中）/ high（高）/ immediate（即時）
5. **suggested_assignee_id**: 推奨担当者のUUID
6. **confidence_score**: 各予測の信頼度（0.0-1.0）
7. **reasoning**: なぜその判断に至ったかの説明（日本語、簡潔に）

# 出力形式（必ずこの形式で回答してください）
\`\`\`json
{
  "category": {
    "value": "category-uuid-here",
    "confidence": 0.92,
    "reasoning": "キーワード「Outlook」「添付ファイル」から、Exchange Online の問題と判断しました。"
  },
  "priority": {
    "value": "P3",
    "confidence": 0.85,
    "reasoning": "個人の業務に影響があるが、回避策が存在するため P3 と判断しました。"
  },
  "impact": {
    "value": "individual",
    "confidence": 0.88
  },
  "urgency": {
    "value": "medium",
    "confidence": 0.83
  },
  "assignee": {
    "value": "assignee-uuid-here",
    "confidence": 0.78,
    "reasoning": "Exchange Online 設定は M365 Operator の担当領域です。"
  }
}
\`\`\`

**重要**: JSON以外の説明文は不要です。必ず上記フォーマットの JSON のみを返してください。`,
};
```

---

## 日本語最適化

### 1. 敬語の統一

**推奨**: ビジネス文書として適切な敬語を使用

```typescript
// Good ✅
"Outlookキャッシュをクリアすることで解決できます。"

// Bad ❌
"Outlookキャッシュをクリアしてください！！"（ビジネス文書として不適切）
```

### 2. 専門用語の統一

**用語集を事前に定義**:
```
Microsoft 365 → M365（略称使用時）
Exchange Online → Exchange（文脈が明確な場合）
Multi-Factor Authentication → MFA
Service Level Agreement → SLA
```

**プロンプトに含める**:
```
# 用語の定義
- M365: Microsoft 365
- MFA: Multi-Factor Authentication（多要素認証）
- SLA: Service Level Agreement（サービスレベル契約）
```

### 3. 文化的コンテキスト

**日本のビジネス文化を考慮**:
```
# 回答文生成時の注意事項
- 丁寧語を使用（です・ます調）
- クッション言葉を適度に使用（「恐れ入りますが」「お手数ですが」）
- 断定を避け、柔らかい表現を使用（「〜と思われます」「〜の可能性があります」）
- 謝罪を適切に含める（障害時: 「ご不便をおかけして申し訳ございません」）
```

---

## 精度向上テクニック

### 1. Chain-of-Thought（思考の連鎖）

**概要**: AI に推論過程を明示的に要求することで、精度を向上

**実装例**:
```typescript
const prompt = `
# タスク
以下のチケットを分類してください。

**重要**: ステップバイステップで考えてください：

1. まず、チケット内容からキーワードを抽出してください
2. 次に、各キーワードがどのカテゴリに関連するか分析してください
3. 最後に、最も適切なカテゴリを選択してください

# 出力形式
\`\`\`json
{
  "思考過程": {
    "step1_キーワード": ["Outlook", "添付ファイル", "エラー"],
    "step2_分析": "Outlook は Exchange Online、添付ファイルはメール送受信に関連",
    "step3_結論": "Exchange Online > メール送受信"
  },
  "category": {
    "value": "uuid",
    "confidence": 0.92
  }
}
\`\`\`
`;
```

**効果**: 精度が 5-10% 向上（ただし、トークン数が増加）

---

### 2. Few-shot Learning（少数例学習）

**概要**: 成功例を 2-3個 提示することで、期待する出力形式を学習

**実装例**:
```typescript
const prompt = `
# タスク
チケットを分類してください。

# 例1（成功例）
入力:
  件名: "Outlookで送信できない"
  詳細: "エラーコード 0x800CCC0F が表示されます"

出力:
\`\`\`json
{
  "category": {
    "value": "exchange-online-uuid",
    "confidence": 0.94,
    "reasoning": "エラーコード 0x800CCC0F は Exchange Server 接続エラーです。"
  },
  "priority": {
    "value": "P3",
    "confidence": 0.88
  }
}
\`\`\`

# 例2（成功例）
入力:
  件名: "Teamsの画面共有ができない"
  詳細: "会議中に画面共有ボタンがグレーアウトしています"

出力:
\`\`\`json
{
  "category": {
    "value": "teams-uuid",
    "confidence": 0.91,
    "reasoning": "Teams の画面共有機能に関する問題です。"
  },
  "priority": {
    "value": "P3",
    "confidence": 0.85
  }
}
\`\`\`

# 実際のチケット
入力:
  件名: {subject}
  詳細: {description}

出力:
（上記の形式で回答してください）
`;
```

**効果**: 出力形式の一貫性が向上、パースエラーが減少

---

### 3. コンテキストの最適化

**原則**: 必要最小限のコンテキストで最大の精度を実現

**Good ✅ - 簡潔なコンテキスト:**
```
# 利用可能なカテゴリ（11個）
- Microsoft 365 > Exchange Online
- Microsoft 365 > Teams
- Microsoft 365 > OneDrive
- ...
```

**Bad ❌ - 冗長なコンテキスト:**
```
# 利用可能なカテゴリ（詳細説明付き）
1. Microsoft 365 > Exchange Online
   説明: Microsoft Exchange Online は、クラウドベースのメールサービスです。Outlook クライアントと連携し、メールの送受信、予定表管理、連絡先管理などの機能を提供します。一般的な問題として、送信エラー、受信エラー、添付ファイルの問題、予定表の同期エラーなどがあります。対応するAgentはExchange Onlineの専門知識を持つM365 Operatorです。SLAはP3で、初動対応4時間以内、解決3営業日以内です。
   ... (200単語の説明が続く)
```

**理由**: 長いコンテキストは、レスポンスタイムとコストを増加させ、精度も低下させる可能性があります。

---

### 4. 信頼度スコアの校正

**推奨**: 信頼度スコアの範囲と意味を明示

```
# 信頼度スコアの定義
- 0.9以上: 高信頼度（過去の類似ケースと完全一致）
- 0.7-0.9: 中信頼度（キーワードから推測可能）
- 0.5-0.7: 低信頼度（あいまいな情報）
- 0.5未満: 不確実（手動確認推奨）

**重要**: 信頼度が 0.7 未満の場合は、その旨を reasoning に記載してください。
```

**効果**: 信頼度スコアの分布が校正され、自動適用の閾値（0.7）との整合性が向上

---

## プロンプトテンプレート詳解

### ticketClassification（チケット自動分類）

**目的**: カテゴリ、優先度、影響度、緊急度、担当者を予測

**重要なポイント**:

1. **カテゴリ一覧の動的生成**:
   ```typescript
   const categoriesResult = await query(`
     SELECT category_id, name, path, description
     FROM categories
     WHERE is_active = true
     ORDER BY path
   `);

   const categoriesText = categoriesResult.rows
     .map(cat => `- ID: ${cat.category_id}\n  名前: ${cat.name}\n  パス: ${cat.path}`)
     .join('\n\n');
   ```

2. **類似チケットの活用**:
   ```typescript
   const similarTicketsResult = await query(`
     SELECT ticket_id, ticket_number, subject, category_id, priority
     FROM tickets
     WHERE subject ILIKE $1
       AND status IN ('resolved', 'closed')
     ORDER BY created_at DESC
     LIMIT 5
   `, [`%${input.subject.split(' ')[0]}%`]);
   ```

3. **優先度計算ロジックの説明**:
   ```
   # 優先度計算ルール
   Impact × Urgency から自動計算：
   - P1: 全社停止、対外影響
   - P2: 部門影響、高緊急度
   - P3: 個人影響、通常業務
   - P4: 問い合わせ、低緊急度
   ```

---

### serviceRequestRouting（ルーティング判定）

**目的**: 承認必要性を判定し、担当者・承認者を提案

**重要なポイント**:

1. **承認ルールの明示**:
   ```
   # 承認ルール（必ず確認してください）
   - ライセンス変更: Manager承認必須
   - 権限付与（管理者権限）: Manager承認必須
   - 特権アカウント操作: Manager承認必須
   - 財務影響のある変更: Approver承認必須
   - 通常のサービス要求: Agent対応可能（承認不要）
   ```

2. **M365操作テンプレートの参照**:
   ```typescript
   const m365TemplatesResult = await query(`
     SELECT task_type, requires_approval, default_approver_role
     FROM m365_operation_templates
     ORDER BY task_type
   `);

   const m365TemplatesText = m365TemplatesResult.rows
     .map(t => `- ${t.task_type}: 承認=${t.requires_approval}`)
     .join('\n');
   ```

3. **matched_rules の出力**:
   ```
   # 出力形式
   {
     "rationale": {
       "reasoning": "...",
       "matched_rules": ["RULE_LICENSE_CHANGE", "RULE_M365_OPERATOR"]
     }
   }
   ```

   **効果**: どのルールが適用されたかをトレース可能にし、監査証跡を強化

---

### escalationRiskDetection（エスカレーションリスク検知）

**目的**: SLA違反リスクを予測し、エスカレーションを推奨

**重要なポイント**:

1. **リスク要因の定量化**:
   ```
   # リスク要因の評価基準
   - SLA残り時間 < 30分: severity = 0.9
   - SLA残り時間 < 1時間: severity = 0.7
   - SLA残り時間 < 4時間: severity = 0.5
   - 担当者変更回数 >= 3回: severity = 0.7
   - コメント数 < 2（長時間放置）: severity = 0.6
   ```

2. **時系列分析**:
   ```typescript
   const elapsedTime = Date.now() - new Date(ticket.created_at).getTime();
   const slaRemaining = new Date(ticket.due_at).getTime() - Date.now();

   const prompt = `
   # チケット情報
   作成日時: ${ticket.created_at}
   経過時間: ${Math.floor(elapsedTime / 60000)}分
   SLA残り時間: ${Math.floor(slaRemaining / 60000)}分
   `;
   ```

3. **推奨アクションの具体性**:
   ```
   # 推奨アクション（以下から選択してください）
   - "即座にManager にエスカレーション"
   - "一時回避策の提案を検討"
   - "利用者への状況説明コメントを追加"
   - "担当者を変更（より経験豊富なAgent に）"
   - "関連するナレッジ記事を参照"
   ```

---

## Few-shot Learning

### いつ使うべきか

**使用シーン**:
- 新しいプロンプトテンプレートの初回実装
- 出力形式が複雑な場合
- AIが期待する形式で回答しない場合

**不要なシーン**:
- シンプルな JSON 出力
- 既に安定している機能

### 実装パターン

```typescript
const fewShotExamples = [
  {
    input: {
      subject: "Outlookで送信できない",
      description: "エラーコード 0x800CCC0F が表示されます",
    },
    output: {
      category: { value: "exchange-uuid", confidence: 0.94 },
      priority: { value: "P3", confidence: 0.88 },
    },
  },
  {
    input: {
      subject: "Teamsの画面共有ができない",
      description: "会議中に画面共有ボタンがグレーアウトしています",
    },
    output: {
      category: { value: "teams-uuid", confidence: 0.91 },
      priority: { value: "P3", confidence: 0.85 },
    },
  },
];

const fewShotText = fewShotExamples
  .map(
    (ex, i) => `
# 例${i + 1}
入力:
  件名: "${ex.input.subject}"
  詳細: "${ex.input.description}"

出力:
\`\`\`json
${JSON.stringify(ex.output, null, 2)}
\`\`\`
`
  )
  .join('\n');

const prompt = `
${fewShotText}

# 実際のチケット
入力:
  件名: "${input.subject}"
  詳細: "${input.description}"

出力:
（上記の形式で回答してください）
`;
```

**注意点**:
- 例は 2-3個 が最適（多すぎるとコンテキストを圧迫）
- 成功例だけでなく、エラーケースも含める
- 多様なカテゴリを網羅する

---

## Chain-of-Thought

### 基本パターン

```
# タスク
以下のチケットを分類してください。

**ステップバイステップで考えてください**:

1. **キーワード抽出**: チケット内容から重要なキーワードを抽出
2. **カテゴリ分析**: 各キーワードがどのカテゴリに関連するか分析
3. **優先度判定**: Impact と Urgency を評価
4. **最終判断**: 最も適切な分類を選択

# 出力形式
\`\`\`json
{
  "思考過程": {
    "keywords": ["Outlook", "添付ファイル", "5MB"],
    "category_analysis": "Outlook → Exchange Online、添付ファイル → メール送受信",
    "priority_analysis": "個人影響（Impact: individual）、業務継続可（Urgency: medium）",
    "conclusion": "Exchange Online > メール送受信、P3"
  },
  "category": { ... },
  "priority": { ... }
}
\`\`\`
```

**効果**:
- 精度向上: +5-10%
- 説明可能性: AI判断の根拠が明確に
- デバッグしやすい: 思考過程を確認可能

**トレードオフ**:
- トークン数増加: 約 +20-30%
- レスポンスタイム増加: 約 +0.5-1秒

---

## 評価と改善

### プロンプトのA/Bテスト

**手順**:
```typescript
// 2つのプロンプトバリエーションを用意
const promptA = '...（従来版）';
const promptB = '...（改善版）';

// ランダムに振り分け
const prompt = Math.random() < 0.5 ? promptA : promptB;
const promptVersion = Math.random() < 0.5 ? 'A' : 'B';

// 結果をログに記録
await query(`
  INSERT INTO ai_predictions (...)
  VALUES (..., $extra_data)
`, [..., JSON.stringify({ prompt_version: promptVersion })]);

// 精度を比較
const metricsA = await getMetricsForPromptVersion('A', 30); // 過去30日
const metricsB = await getMetricsForPromptVersion('B', 30);

console.log(`Prompt A 精度: ${metricsA.accuracy}%`);
console.log(`Prompt B 精度: ${metricsB.accuracy}%`);
```

### フィードバックループ

**実装**:
```typescript
// ユーザーが提案を採用/却下した際のフィードバック記録
await AIPredictionModel.updateEvaluation(
  predictionId,
  actualValue,     // 実際の値
  wasAccepted      // 採用されたか
);

// 月次でフィードバックを分析
const feedback = await query(`
  SELECT
    prediction_type,
    AVG(confidence_score) FILTER (WHERE was_accepted = true) as avg_confidence_accepted,
    AVG(confidence_score) FILTER (WHERE was_accepted = false) as avg_confidence_rejected
  FROM ai_predictions
  WHERE created_at >= $1
  GROUP BY prediction_type
`, [thirtyDaysAgo]);

// 結果を基にプロンプトを改善
```

### 精度低下の検知

**自動アラート**:
```typescript
// 日次バッチで精度をチェック
const dailyAccuracy = await AIService.getAccuracyMetrics('category', 1);

if (dailyAccuracy.accuracy < 85) {
  // Slack通知
  await sendSlackAlert(
    `⚠️ AI分類精度が低下しています: ${dailyAccuracy.accuracy}%（目標: 90%）`
  );

  // プロンプトの見直しを推奨
  console.warn('プロンプトテンプレートの見直しが必要です');
}
```

---

## ベストプラクティス

### 1. プロンプトのバージョン管理

**推奨**:
```typescript
export const promptTemplates = {
  ticketClassification_v1: `...`,  // 初期版
  ticketClassification_v2: `...`,  // 改善版（2025-01-15）
  ticketClassification: `...`,     // 現在使用中（エイリアス）
};

// プロンプトバージョンを DB に記録
await query(`
  INSERT INTO ai_predictions (model_version, ...)
  VALUES ($1, ...)
`, ['claude-sonnet-4-5-20250929:prompt-v2', ...]);
```

### 2. プロンプトの再利用

**DRY原則**:
```typescript
// 共通部分を抽出
const commonInstructions = `
# 出力形式
\`\`\`json
{
  "value": "...",
  "confidence": 0.0-1.0,
  "reasoning": "日本語で簡潔に"
}
\`\`\`
`;

export const promptTemplates = {
  ticketClassification: `
    ${roleDefinition}
    ${ticketContext}
    ${commonInstructions}
  `,
  serviceRequestRouting: `
    ${roleDefinition}
    ${routingContext}
    ${commonInstructions}
  `,
};
```

### 3. プロンプトのテスト

**単体テスト**:
```typescript
describe('Prompt Templates', () => {
  it('ticketClassification は有効なJSONを返す', async () => {
    const prompt = promptTemplates.ticketClassification
      .replace('{subject}', 'テスト件名')
      .replace('{description}', 'テスト詳細')
      .replace('{categories}', 'テストカテゴリ')
      .replace('{similar_tickets}', 'なし');

    const response = await claudeClient.sendPrompt(prompt, '');

    // JSON パース可能であることを確認
    expect(() => JSON.parse(response)).not.toThrow();

    // 必須フィールドが含まれることを確認
    const parsed = JSON.parse(response);
    expect(parsed.category).toBeDefined();
    expect(parsed.category.value).toBeDefined();
    expect(parsed.category.confidence).toBeGreaterThan(0);
  });
});
```

---

## 改善例

### Before（精度 75%）

```typescript
const prompt = `
チケットを分類してください。

件名: {subject}
詳細: {description}
`;
```

**問題点**:
- 役割定義なし
- 出力形式が曖昧
- コンテキスト不足

---

### After（精度 92%）

```typescript
const prompt = `
# 役割
あなたは社内ITヘルプデスクの経験豊富な分類エキスパートです。

# チケット内容
件名: {subject}
詳細: {description}

# 利用可能なカテゴリ
{categories}

# 過去の類似チケット
{similar_tickets}

# タスク
ステップバイステップで分析してください：

1. キーワードを抽出
2. 各カテゴリとの関連性を分析
3. 最も適切なカテゴリを選択
4. 信頼度を評価（0.0-1.0）

# 出力形式
\`\`\`json
{
  "category": {
    "value": "uuid",
    "confidence": 0.92,
    "reasoning": "キーワード「Outlook」から Exchange Online と判断"
  }
}
\`\`\`

**重要**: JSON以外の説明文は不要です。
`;
```

**改善ポイント**:
- ✅ 役割定義を追加
- ✅ コンテキスト情報を充実（カテゴリ一覧、類似チケット）
- ✅ Chain-of-Thought を導入
- ✅ 出力形式を厳密に指定

**結果**: 精度が 75% → 92%（+17%）に向上

---

## プロンプト最適化チェックリスト

### 設計時

- [ ] 役割定義が明確か
- [ ] タスクが具体的か
- [ ] 出力形式が構造化されているか
- [ ] 必要十分なコンテキストが含まれているか
- [ ] Few-shot Examples が適切か（2-3個）
- [ ] Chain-of-Thought が必要か
- [ ] 日本語として自然か
- [ ] JSON のパース可能性を確認したか

### 実装後

- [ ] 単体テストが合格するか
- [ ] 精度目標（90%以上）を達成しているか
- [ ] レスポンスタイム（3秒以内）を満たすか
- [ ] トークン数が適切か（過剰に長くないか）
- [ ] フィードバックを収集しているか
- [ ] A/Bテストで改善効果を測定したか

---

## 次のステップ

- [04_API仕様.md](./04_API仕様.md) - 全エンドポイントの詳細仕様
- [05_精度改善ガイド.md](./05_精度改善ガイド.md) - フィードバックループの活用

---

**最終更新:** 2026年2月
**バージョン:** 1.0.0
