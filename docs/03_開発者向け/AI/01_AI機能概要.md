# AI機能概要

Mirai-HelpDesk-Management-SystemにおけるAI機能の全体像、アーキテクチャ、主要ユースケースを解説します。

---

## 📋 目次

1. [概要](#概要)
2. [5つの主要ユースケース](#5つの主要ユースケース)
3. [アーキテクチャ](#アーキテクチャ)
4. [データフロー](#データフロー)
5. [技術スタック](#技術スタック)
6. [セキュリティとコンプライアンス](#セキュリティとコンプライアンス)
7. [成功指標（KPI）](#成功指標kpi)

---

## 概要

### ビジョン

AI機能は、社内ITヘルプデスクの業務効率を最大95%向上させ、Agent（一次対応担当者）とManager（運用管理者）の生産性を劇的に改善します。

### コアバリュー

- **高精度な自動分類**: 90%以上の精度でチケットを自動分類
- **インテリジェントルーティング**: 95%以上の精度で適切な担当者に自動アサイン
- **ナレッジの再利用**: ベクトル検索により、過去の解決策を瞬時に発見
- **監査証跡の維持**: すべてのAI操作を追記専用テーブルに記録
- **説明可能性**: AI判断の根拠を明示し、信頼性を確保

### ビジネスインパクト

| 指標 | 改善目標 | 年間削減効果 |
|------|---------|------------|
| チケット処理時間 | 30%削減 | 720時間/年 |
| SLA達成率 | +10% | クレーム件数 -40% |
| Agent生産性 | +25% | 処理チケット数 +300件/年 |
| 利用者満足度 | 4.5/5.0以上 | NPS +15ポイント |

---

## 5つの主要ユースケース

### 1. チケット自動分類（Ticket Classification）

**目的**: チケット作成時に、カテゴリ・優先度・影響度・緊急度・担当者を自動提案

**削減時間**: 3-5分 → 数秒（90-95%削減）

**精度目標**: 90%以上

**フロー**:
```
1. ユーザーが件名・詳細を入力
   ↓
2. AI が以下を予測:
   - カテゴリ（例: Exchange Online）
   - 優先度（P1-P4）
   - 影響度（individual/department/company_wide/external）
   - 緊急度（low/medium/high/immediate）
   - 担当者（例: M365 Operator）
   ↓
3. 各予測に信頼度スコア（0.0-1.0）を付与
   ↓
4. Agent が採用/却下を選択
   ↓
5. フィードバックを DB に記録（精度改善に活用）
```

**技術実装**:
- **エンドポイント**: `POST /api/ai/classify-ticket`
- **プロンプトテンプレート**: `ticketClassification`
- **データベース**: `ai_predictions` テーブル

**使用例**:
```typescript
const result = await AIService.classifyTicket({
  subject: "Outlookで添付ファイルが送信できない",
  description: "5MBのPDFファイルを送信しようとするとエラーになります",
  requester_id: "user-uuid"
});

// レスポンス:
// {
//   predictions: {
//     category: { value: "cat-uuid", confidence: 0.92, reasoning: "..." },
//     priority: { value: "P3", confidence: 0.85, reasoning: "..." },
//     impact: { value: "individual", confidence: 0.88 },
//     urgency: { value: "medium", confidence: 0.83 },
//     assignee: { value: "agent-uuid", confidence: 0.78, reasoning: "..." }
//   },
//   processing_time_ms: 2450,
//   model_version: "claude-sonnet-4-5-20250929",
//   pii_masked: false
// }
```

---

### 2. サービス要求ルーティング（Service Request Routing）

**目的**: 承認必要性を自動検出し、適切な担当者・承認者にアサイン

**削減時間**: 5分 → 10秒（97%削減）

**精度目標**: 95%以上

**判定ルール**:
```
承認が必要な操作:
├─ ライセンス変更（M365 E3/E5等）
├─ 権限付与（管理者権限）
├─ 特権アカウント操作
├─ 財務影響のある変更
└─ セキュリティリスクを伴う操作

承認不要な操作:
├─ 通常のパスワードリセット
├─ 一般的な問い合わせ
├─ FAQ に記載された標準手順
└─ 低リスクのサービス要求
```

**フロー**:
```
1. サービス要求のチケットが作成される
   ↓
2. AI がチケット内容を分析:
   - 承認必要性を判定（true/false）
   - 承認理由を生成（承認必要時）
   - 推奨承認者を提案（Manager等）
   - 推奨担当者を提案（M365 Operator等）
   ↓
3. Agent が提案を確認・採用
   ↓
4. 承認フローが自動で開始
   ↓
5. SOD（職務分離）チェック: 承認者 ≠ 実施者
```

**技術実装**:
- **エンドポイント**: `POST /api/ai/route-ticket`
- **プロンプトテンプレート**: `serviceRequestRouting`
- **データベース**: `ai_routing_logs` テーブル

**使用例**:
```typescript
const result = await AIRoutingService.routeServiceRequest({
  type: "service_request",
  subject: "Microsoft 365 E5ライセンス追加",
  description: "新入社員用にE5ライセンスを5つ追加したい",
  category_id: "license-category-uuid",
  requester_id: "user-uuid"
});

// レスポンス:
// {
//   routing: {
//     requires_approval: true,
//     approval_reason: "ライセンス変更は財務影響があるため、Manager承認が必要です。",
//     suggested_approver: {
//       user_id: "manager-uuid",
//       display_name: "IT Manager",
//       confidence: 0.95
//     },
//     suggested_assignee: {
//       user_id: "operator-uuid",
//       display_name: "M365 Operator",
//       role: "m365_operator",
//       confidence: 0.92
//     },
//     rationale: {
//       reasoning: "...",
//       matched_rules: ["RULE_LICENSE_CHANGE", "RULE_M365_OPERATOR"]
//     }
//   }
// }
```

---

### 3. 優先度自動判定（Priority Calculation）

**目的**: Impact × Urgency から P1-P4 を自動計算

**削減時間**: 2-3分 → 即時（100%削減）

**精度目標**: 85%以上

**計算ロジック**:
```
Impact × Urgency マトリクス:

             Urgency
             Low    Medium   High    Immediate
Impact
Individual   P4     P3       P3      P2
Department   P3     P3       P2      P1
Company-wide P3     P2       P1      P1
External     P2     P1       P1      P1
```

**AI強化ポイント**:
- **コンテキスト理解**: チケット内容から真の影響度を推測
  - 例: "Outlookが使えない" → 個人影響に見えるが、全社的な障害の可能性
- **過去の類似ケース**: 同様のチケットの優先度を参考
- **SLA リスク予測**: 期限超過リスクを考慮した優先度調整

**技術実装**:
- 既存の `classifyTicket` エンドポイントに統合
- Impact と Urgency を個別に予測し、自動計算

---

### 4. 類似チケット検索（Similar Ticket Search）

**目的**: ベクトル検索により、過去の類似チケットから最適解を推測

**削減時間**: 10-15分 → 数秒（95-98%削減）

**精度目標**: 類似度 0.8以上のチケットを5件以内に発見

**仕組み**:
```
1. チケットの件名・詳細をベクトル化（1024次元）
   ↓
2. pgvector の HNSW インデックスで高速検索
   ↓
3. コサイン類似度でランキング
   ↓
4. 解決済み・クローズ済みチケットから最適解を抽出
   ↓
5. 解決方法・有用なコメントを提示
```

**技術実装**:
- **エンドポイント**: `POST /api/ai/search-similar-tickets`
- **データベース**: `ticket_embeddings` テーブル（pgvector）
- **インデックス**: HNSW（Hierarchical Navigable Small World）

**使用例**:
```typescript
const result = await VectorSearchService.searchSimilarTickets({
  query: "Outlookで添付ファイルが送信できない",
  limit: 5,
  min_similarity: 0.7
});

// レスポンス:
// {
//   similar_tickets: [
//     {
//       ticket_id: "uuid-1",
//       ticket_number: "HD-2025-00123",
//       subject: "Outlook添付ファイルエラー",
//       similarity_score: 0.94,
//       resolution_summary: "Outlookキャッシュをクリアして解決しました。",
//       helpful_comments: [
//         "ファイル → オプション → 詳細設定 → Outlookデータファイル → 今すぐクリア"
//       ]
//     },
//     { ... }
//   ],
//   processing_time_ms: 850,
//   search_method: "vector"
// }
```

---

### 5. 監査レポート自動生成（Audit Report Generation）

**目的**: AI精度メトリクスを自動集計し、月次レポートを生成

**削減時間**: 1時間 → 5分（92%削減）

**出力形式**: JSON, CSV, PDF

**レポート種別**:
```
1. accuracy: 精度メトリクス
   - カテゴリ分類精度、優先度精度、ルーティング精度
   - 信頼度スコア分布
   - 採用/却下率

2. usage: 使用量メトリクス
   - API呼び出し回数
   - トークン数（input/output）
   - キャッシュヒット率

3. performance: パフォーマンスメトリクス
   - 平均レスポンスタイム
   - p90/p99 パーセンタイル
   - 最大レスポンスタイム

4. cost: コストメトリクス
   - Claude API コスト（月次・累計）
   - リクエスト単価
   - コスト削減額

5. comprehensive: 包括的レポート
   - 上記すべてを統合
   - トレンド分析（月次推移）
   - 改善提案
```

**技術実装**:
- **エンドポイント**: `POST /api/ai/generate-report`
- **データベース**: `ai_metrics_cache` テーブル
- **バッチ処理**: 月次で自動集計・キャッシュ更新

---

## アーキテクチャ

### システム全体図

```
┌─────────────────────────────────────────────────────────────┐
│                    フロントエンド（React + TypeScript）       │
├─────────────────────────────────────────────────────────────┤
│  AIClassificationWidget    │ チケット自動分類UI              │
│  AIRoutingWidget           │ ルーティング提案UI              │
│  AISimilarTicketsWidget    │ 類似チケット検索UI              │
│  AIAnswerSuggestion        │ 回答提案UI                      │
│  AIMetricsDashboard        │ メトリクスダッシュボードUI      │
│  AIEscalationAlert         │ エスカレーションアラートUI      │
└───────────────────┬─────────────────────────────────────────┘
                    │ HTTP REST API
┌───────────────────▼─────────────────────────────────────────┐
│              バックエンド（Express + TypeScript）             │
├─────────────────────────────────────────────────────────────┤
│  ┌────────────────────────────────────────────────────┐     │
│  │ Routes Layer (ai.routes.ts)                        │     │
│  │ - /api/ai/classify-ticket                          │     │
│  │ - /api/ai/route-ticket                             │     │
│  │ - /api/ai/search-similar-tickets                   │     │
│  │ - /api/ai/suggest-answer                           │     │
│  │ - /api/ai/detect-escalation-risk                   │     │
│  │ - /api/ai/generate-report                          │     │
│  └────────────────┬───────────────────────────────────┘     │
│                   │                                          │
│  ┌────────────────▼───────────────────────────────────┐     │
│  │ Controller Layer (ai.controller.ts)                │     │
│  │ - 入力検証（express-validator）                     │     │
│  │ - 認証・認可チェック（JWT + RBAC）                  │     │
│  │ - エラーハンドリング（AppError）                    │     │
│  └────────────────┬───────────────────────────────────┘     │
│                   │                                          │
│  ┌────────────────▼───────────────────────────────────┐     │
│  │ Service Layer                                      │     │
│  │ ┌──────────────────────────────────────────────┐   │     │
│  │ │ AIService (ai.service.ts)                    │   │     │
│  │ │ - classifyTicket()                           │   │     │
│  │ │ - getAccuracyMetrics()                       │   │     │
│  │ └──────────────────────────────────────────────┘   │     │
│  │ ┌──────────────────────────────────────────────┐   │     │
│  │ │ AIRoutingService (ai-routing.service.ts)     │   │     │
│  │ │ - routeServiceRequest()                      │   │     │
│  │ └──────────────────────────────────────────────┘   │     │
│  │ ┌──────────────────────────────────────────────┐   │     │
│  │ │ VectorSearchService (vector-search.service)  │   │     │
│  │ │ - searchSimilarTickets()                     │   │     │
│  │ │ - generateEmbedding()                        │   │     │
│  │ └──────────────────────────────────────────────┘   │     │
│  │ ┌──────────────────────────────────────────────┐   │     │
│  │ │ AIAnalyticsService (ai-analytics.service)    │   │     │
│  │ │ - generateReport()                           │   │     │
│  │ └──────────────────────────────────────────────┘   │     │
│  └────────────────┬───────────────────────────────────┘     │
│                   │                                          │
│  ┌────────────────▼───────────────────────────────────┐     │
│  │ Claude API Client (claude-api.client.ts)           │     │
│  │ - sendPrompt()                                     │     │
│  │ - Redis キャッシング                                │     │
│  │ - レート制限（10回/分/ユーザー）                     │     │
│  │ - PII マスキング                                    │     │
│  └────────────────┬───────────────────────────────────┘     │
└───────────────────┼─────────────────────────────────────────┘
                    │
┌───────────────────▼─────────────────────────────────────────┐
│              Claude API (Anthropic)                         │
│  Model: claude-sonnet-4-5-20250929                         │
│  Context Window: 1M tokens                                  │
│  Temperature: 0.3（決定論的）                               │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│              データベース（PostgreSQL + pgvector）            │
├─────────────────────────────────────────────────────────────┤
│  tickets                │ チケット主テーブル                 │
│  ticket_embeddings      │ ベクトル検索用（pgvector）         │
│  ai_predictions         │ AI予測履歴（追記専用）             │
│  ai_routing_logs        │ ルーティング履歴（追記専用）       │
│  ai_metrics_cache       │ メトリクスキャッシュ               │
│  ticket_history         │ 監査証跡（追記専用）               │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│              Redis（キャッシュ・レート制限）                  │
│  ai-cache:*             │ Claude API レスポンスキャッシュ    │
│  ai-rate-limit:*        │ ユーザー別レート制限カウンター     │
└─────────────────────────────────────────────────────────────┘
```

---

## データフロー

### チケット自動分類のデータフロー

```
┌─────────────┐
│   ユーザー   │
└──────┬──────┘
       │ 1. 件名・詳細入力
       ▼
┌─────────────────────────┐
│ AIClassificationWidget  │
└──────┬──────────────────┘
       │ 2. POST /api/ai/classify-ticket
       ▼
┌─────────────────────────┐
│ AIController            │
│ - 認証チェック          │
│ - 入力検証              │
└──────┬──────────────────┘
       │ 3. AIService.classifyTicket()
       ▼
┌─────────────────────────┐
│ AIService               │
│ ┌─────────────────────┐ │
│ │ 1. PII マスキング   │ │ PIIMasking.maskForAI()
│ └─────────────────────┘ │
│ ┌─────────────────────┐ │
│ │ 2. DB取得           │ │ カテゴリ一覧、類似チケット
│ └─────────────────────┘ │
│ ┌─────────────────────┐ │
│ │ 3. プロンプト生成   │ │ テンプレート置換
│ └─────────────────────┘ │
└──────┬──────────────────┘
       │ 4. claudeClient.sendPrompt()
       ▼
┌─────────────────────────┐
│ ClaudeAPIClient         │
│ ┌─────────────────────┐ │
│ │ キャッシュチェック  │ │ Redis GET
│ └─────────────────────┘ │
│ ┌─────────────────────┐ │
│ │ レート制限チェック  │ │ Redis INCR
│ └─────────────────────┘ │
└──────┬──────────────────┘
       │ 5. messages.create()
       ▼
┌─────────────────────────┐
│ Claude API              │
│ (Anthropic)             │
└──────┬──────────────────┘
       │ 6. AI Response (JSON)
       ▼
┌─────────────────────────┐
│ ClaudeAPIClient         │
│ ┌─────────────────────┐ │
│ │ キャッシュ保存      │ │ Redis SETEX
│ └─────────────────────┘ │
└──────┬──────────────────┘
       │ 7. レスポンス返却
       ▼
┌─────────────────────────┐
│ AIService               │
│ ┌─────────────────────┐ │
│ │ レスポンスパース    │ │ JSON抽出
│ └─────────────────────┘ │
│ ┌─────────────────────┐ │
│ │ ラベル取得          │ │ カテゴリ名、担当者名
│ └─────────────────────┘ │
│ ┌─────────────────────┐ │
│ │ DB保存              │ │ ai_predictions テーブル
│ └─────────────────────┘ │
│ ┌─────────────────────┐ │
│ │ 監査ログ記録        │ │ ticket_history テーブル
│ └─────────────────────┘ │
└──────┬──────────────────┘
       │ 8. 結果返却
       ▼
┌─────────────────────────┐
│ AIController            │
└──────┬──────────────────┘
       │ 9. JSON Response
       ▼
┌─────────────────────────┐
│ AIClassificationWidget  │
│ - 信頼度バッジ表示      │
│ - 採用/却下ボタン       │
└──────┬──────────────────┘
       │ 10. ユーザーが採用/却下
       ▼
┌─────────────────────────┐
│ フィードバック記録      │
│ was_accepted = true/false│
└─────────────────────────┘
```

---

## 技術スタック

### フロントエンド
- **フレームワーク**: React 18
- **言語**: TypeScript
- **UI ライブラリ**: Ant Design 5
- **状態管理**: Zustand
- **API 通信**: Axios, TanStack Query
- **ルーティング**: React Router v6

### バックエンド
- **ランタイム**: Node.js 18+
- **フレームワーク**: Express 4
- **言語**: TypeScript
- **AI SDK**: Anthropic SDK (@anthropic-ai/sdk)
- **認証**: JWT (jsonwebtoken)
- **検証**: express-validator

### データベース
- **RDBMS**: PostgreSQL 15+
- **ベクトル検索**: pgvector
- **マイグレーション**: カスタムスクリプト（ts-node）

### インフラ
- **キャッシュ**: Redis 7+
- **ロギング**: Winston
- **監視**: （未実装）

### AI・ML
- **モデル**: Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)
- **コンテキストウィンドウ**: 1M tokens
- **温度**: 0.3（決定論的）
- **埋め込み次元**: 1024

---

## セキュリティとコンプライアンス

### PII（個人情報）保護

**マスキング対象**:
- メールアドレス → `[EMAIL_MASKED]`
- 電話番号 → `[PHONE_MASKED]`
- パブリックIPアドレス → `[IP_MASKED]`

**実装**: `backend/src/utils/pii-masking.ts`

**マスキングタイミング**: Claude API 送信前（必須）

### 監査証跡

**追記専用テーブル**:
- `ai_predictions` - AI予測履歴
- `ai_routing_logs` - ルーティング履歴
- `ticket_history` - 全操作履歴

**保護機構**:
- DELETE 禁止トリガー
- UPDATE 禁止トリガー（フィードバック用フィールド除く）

### アクセス制御

**RBAC（Role-Based Access Control）**:
```
canClassify:      全ロール（Requester以上）
canUseSuggestions: Agent以上
canUseM365Guide:  M365 Operator以上
canViewMetrics:   Manager, Auditor のみ
```

**認証**: JWT（JSON Web Token）

**認可**: ミドルウェア（`ai-auth.middleware.ts`）

### レート制限

- **デフォルト**: 10回/分/ユーザー
- **実装**: Redis ベースのトークンバケット
- **設定**: `AI_RATE_LIMIT_PER_USER` 環境変数

---

## 成功指標（KPI）

### 精度メトリクス

| 機能 | 目標精度 | 測定方法 |
|------|---------|---------|
| カテゴリ分類 | 90%以上 | `was_accepted = true` の割合 |
| ルーティング判定 | 95%以上 | 実際の担当者との一致率 |
| 優先度判定 | 85%以上 | 実際の優先度との一致率 |
| 類似チケット検索 | 80%以上 | ユーザー評価（5段階）の平均4.0以上 |

### パフォーマンスメトリクス

| 機能 | 目標レスポンスタイム | 測定方法 |
|------|---------------------|---------|
| チケット分類 | 3秒以内（p90） | `processing_time_ms` の p90 |
| ルーティング判定 | 2秒以内（p90） | `processing_time_ms` の p90 |
| 類似チケット検索 | 1秒以内（p90） | データベースクエリ時間 + AI処理 |
| レポート生成 | 5秒以内 | 非同期ジョブの完了時間 |

### ビジネスメトリクス

| 指標 | 目標値 | 測定方法 |
|------|--------|---------|
| チケット処理時間削減 | 30%削減 | 平均解決時間の比較（AI導入前後） |
| SLA達成率向上 | +10% | SLA違反率の比較（AI導入前後） |
| 利用者満足度 | 4.5/5.0以上 | チケット解決後のアンケート |
| Agent生産性向上 | +25% | 処理チケット数/日の比較 |
| AI採用率 | 80%以上 | 提案採用回数 / 総提案回数 |

---

## 次のステップ

- [02_モデル設定ガイド.md](./02_モデル設定ガイド.md) - Claude Sonnet 4.5 のセットアップ
- [03_プロンプトエンジニアリング.md](./03_プロンプトエンジニアリング.md) - プロンプト最適化手法
- [04_API仕様.md](./04_API仕様.md) - 全エンドポイントの詳細

---

**最終更新:** 2026年2月
**バージョン:** 1.0.0
