# ç²¾åº¦æ”¹å–„ã‚¬ã‚¤ãƒ‰

AIæ©Ÿèƒ½ã®ç²¾åº¦ã‚’ç¶™ç¶šçš„ã«æ”¹å–„ã™ã‚‹ãŸã‚ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒ«ãƒ¼ãƒ—ã€ç²¾åº¦ãƒ¡ãƒˆãƒªã‚¯ã‚¹åˆ†æã€ãƒ¢ãƒ‡ãƒ«ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°æ‰‹æ³•ã‚’è§£èª¬ã—ã¾ã™ã€‚

---

## ğŸ“‹ ç›®æ¬¡

1. [ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒ«ãƒ¼ãƒ—ã®ä»•çµ„ã¿](#ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒ«ãƒ¼ãƒ—ã®ä»•çµ„ã¿)
2. [ç²¾åº¦ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã®æ¸¬å®š](#ç²¾åº¦ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã®æ¸¬å®š)
3. [ä¿¡é ¼åº¦ã‚¹ã‚³ã‚¢ã®åˆ†æ](#ä¿¡é ¼åº¦ã‚¹ã‚³ã‚¢ã®åˆ†æ)
4. [ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°](#ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°)
5. [ãƒ‡ãƒ¼ã‚¿å“è³ªã®æ”¹å–„](#ãƒ‡ãƒ¼ã‚¿å“è³ªã®æ”¹å–„)
6. [A/Bãƒ†ã‚¹ãƒˆæˆ¦ç•¥](#abãƒ†ã‚¹ãƒˆæˆ¦ç•¥)
7. [ç¶™ç¶šçš„æ”¹å–„ãƒ—ãƒ­ã‚»ã‚¹](#ç¶™ç¶šçš„æ”¹å–„ãƒ—ãƒ­ã‚»ã‚¹)

---

## ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒ«ãƒ¼ãƒ—ã®ä»•çµ„ã¿

### æ¦‚è¦

AIç²¾åº¦ã‚’ç¶™ç¶šçš„ã«æ”¹å–„ã™ã‚‹ãŸã‚ã€**ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯**ã‚’åé›†ã—ã€ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæœ€é©åŒ–ã‚„ãƒ¢ãƒ‡ãƒ«ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ã«æ´»ç”¨ã—ã¾ã™ã€‚

### ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã®ç¨®é¡

| ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ | åé›†ã‚¿ã‚¤ãƒŸãƒ³ã‚° | ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ |
|--------------|--------------|------------|
| **æš—é»™çš„ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯** | ãƒã‚±ãƒƒãƒˆå€¤ç¢ºå®šæ™‚ï¼ˆè‡ªå‹•ï¼‰ | `ai_predictions.was_accepted` |
| **æ˜ç¤ºçš„ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯** | ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ¡ç”¨/å´ä¸‹ã‚’é¸æŠ | `ai_predictions.was_accepted` |
| **è©³ç´°ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯** | ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ  | `ai_feedback` ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆå°†æ¥å®Ÿè£…ï¼‰ |

---

### è‡ªå‹•è©•ä¾¡ãƒˆãƒªã‚¬ãƒ¼

**å®Ÿè£…**: `database/migrations/012_create_ai_predictions.sql`

```sql
CREATE OR REPLACE FUNCTION update_ai_prediction_evaluation()
RETURNS TRIGGER AS $$
BEGIN
  -- ã‚«ãƒ†ã‚´ãƒªè©•ä¾¡
  IF (OLD.category_id IS DISTINCT FROM NEW.category_id) AND (NEW.category_id IS NOT NULL) THEN
    UPDATE ai_predictions
    SET actual_value = NEW.category_id::TEXT,
        was_accepted = (predicted_value = NEW.category_id::TEXT)
    WHERE ticket_id = NEW.ticket_id
      AND prediction_type = 'category'
      AND actual_value IS NULL;
  END IF;

  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_update_ai_prediction_evaluation
AFTER UPDATE ON tickets
FOR EACH ROW
EXECUTE FUNCTION update_ai_prediction_evaluation();
```

**ä»•çµ„ã¿**:
1. ãƒã‚±ãƒƒãƒˆã®ã‚«ãƒ†ã‚´ãƒªãŒç¢ºå®šï¼ˆAgent ãŒé¸æŠï¼‰
2. ãƒˆãƒªã‚¬ãƒ¼ãŒè‡ªå‹•å®Ÿè¡Œ
3. `ai_predictions` ãƒ†ãƒ¼ãƒ–ãƒ«ã® `was_accepted` ã‚’è‡ªå‹•æ›´æ–°
4. `was_accepted = (predicted_value = actual_value)`

**åŠ¹æœ**: äººé–“ã®æ‰‹ã‚’ä»‹ã•ãšã«ç²¾åº¦è©•ä¾¡ãŒå¯èƒ½

---

### æ˜ç¤ºçš„ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã®åé›†

**ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å®Ÿè£…**:
```typescript
// AIClassificationWidget.tsx

const handleAcceptAIPredictions = (predictions: AIClassificationResult['predictions']) => {
  // ä¿¡é ¼åº¦ >= 0.7 ã®äºˆæ¸¬ã®ã¿æ¡ç”¨
  if (predictions.category && predictions.category.confidence >= 0.7) {
    form.setFieldValue('category_id', predictions.category.value);

    // ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯è¨˜éŒ²ï¼ˆæš—é»™çš„ã« was_accepted = trueï¼‰
  }

  if (predictions.priority && predictions.priority.confidence >= 0.7) {
    form.setFieldValue('priority', predictions.priority.value);
  }

  // ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆã‚’éè¡¨ç¤º
  setShowAIWidget(false);
};

const handleRejectAIPredictions = () => {
  // ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯è¨˜éŒ²: was_accepted = false
  // ï¼ˆå°†æ¥å®Ÿè£…: APIå‘¼ã³å‡ºã—ã§æ˜ç¤ºçš„ã«è¨˜éŒ²ï¼‰

  setShowAIWidget(false);
};
```

---

## ç²¾åº¦ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã®æ¸¬å®š

### åŸºæœ¬ãƒ¡ãƒˆãƒªã‚¯ã‚¹

**å®Ÿè£…**: `backend/src/models/ai-prediction.model.ts`

```typescript
static async getAccuracyMetrics(
  predictionType: PredictionType,
  startDate: Date,
  endDate: Date
): Promise<{
  total: number;
  accepted: number;
  rejected: number;
  pending: number;
  accuracy: number;
  avgConfidence: number;
}> {
  const result = await query(`
    SELECT
      COUNT(*) as total,
      SUM(CASE WHEN was_accepted = true THEN 1 ELSE 0 END) as accepted,
      SUM(CASE WHEN was_accepted = false THEN 1 ELSE 0 END) as rejected,
      SUM(CASE WHEN was_accepted IS NULL THEN 1 ELSE 0 END) as pending,
      AVG(confidence_score) as avg_confidence
    FROM ai_predictions
    WHERE prediction_type = $1
      AND created_at >= $2
      AND created_at <= $3
  `, [predictionType, startDate, endDate]);

  const row = result.rows[0];
  const total = parseInt(row.total);
  const accepted = parseInt(row.accepted);
  const rejected = parseInt(row.rejected);
  const evaluatedTotal = accepted + rejected;
  const accuracy = evaluatedTotal > 0 ? (accepted / evaluatedTotal) * 100 : 0;

  return {
    total,
    accepted,
    rejected,
    pending: parseInt(row.pending),
    accuracy: parseFloat(accuracy.toFixed(2)),
    avgConfidence: parseFloat(row.avg_confidence || 0),
  };
}
```

---

### ä¿¡é ¼åº¦ã‚¹ã‚³ã‚¢åˆ¥ã®ç²¾åº¦åˆ†æ

**å®Ÿè£…**: `backend/src/models/ai-prediction.model.ts`

```typescript
static async getAccuracyByConfidence(
  predictionType: PredictionType,
  startDate: Date,
  endDate: Date
): Promise<Array<{
  confidence_range: string;
  total: number;
  accuracy: number;
}>> {
  const result = await query(`
    SELECT
      CASE
        WHEN confidence_score >= 0.9 THEN '0.9-1.0'
        WHEN confidence_score >= 0.8 THEN '0.8-0.9'
        WHEN confidence_score >= 0.7 THEN '0.7-0.8'
        WHEN confidence_score >= 0.6 THEN '0.6-0.7'
        ELSE '<0.6'
      END as confidence_range,
      COUNT(*) as total,
      ROUND(
        SUM(CASE WHEN was_accepted = true THEN 1 ELSE 0 END)::numeric /
        NULLIF(SUM(CASE WHEN was_accepted IS NOT NULL THEN 1 ELSE 0 END), 0) * 100,
        2
      ) as accuracy
    FROM ai_predictions
    WHERE prediction_type = $1
      AND created_at >= $2
      AND created_at <= $3
      AND was_accepted IS NOT NULL
    GROUP BY confidence_range
    ORDER BY confidence_range DESC
  `, [predictionType, startDate, endDate]);

  return result.rows;
}
```

**çµæœä¾‹**:
```json
[
  { "confidence_range": "0.9-1.0", "total": 45, "accuracy": 97.8 },
  { "confidence_range": "0.8-0.9", "total": 32, "accuracy": 90.6 },
  { "confidence_range": "0.7-0.8", "total": 18, "accuracy": 83.3 },
  { "confidence_range": "0.6-0.7", "total": 5, "accuracy": 60.0 }
]
```

**è§£é‡ˆ**:
- âœ… ä¿¡é ¼åº¦ 0.9ä»¥ä¸Š: 97.8%ã®ç²¾åº¦ï¼ˆé«˜ä¿¡é ¼åº¦ï¼‰
- âœ… ä¿¡é ¼åº¦ 0.8-0.9: 90.6%ã®ç²¾åº¦ï¼ˆä¸­ä¿¡é ¼åº¦ï¼‰
- âš ï¸ ä¿¡é ¼åº¦ 0.7-0.8: 83.3%ã®ç²¾åº¦ï¼ˆå¢ƒç•Œç·šï¼‰
- âŒ ä¿¡é ¼åº¦ 0.6-0.7: 60.0%ã®ç²¾åº¦ï¼ˆä½ä¿¡é ¼åº¦ã€è‡ªå‹•é©ç”¨éæ¨å¥¨ï¼‰

**ã‚¢ã‚¯ã‚·ãƒ§ãƒ³**: è‡ªå‹•é©ç”¨é–¾å€¤ã‚’ **0.7** ã«è¨­å®šï¼ˆç²¾åº¦ 83%ä»¥ä¸Šã‚’ç¢ºä¿ï¼‰

---

## ä¿¡é ¼åº¦ã‚¹ã‚³ã‚¢ã®åˆ†æ

### ä¿¡é ¼åº¦ã®æ ¡æ­£

**å•é¡Œ**: AIãŒéä¿¡ã¾ãŸã¯éå°è©•ä¾¡ã™ã‚‹å ´åˆ

**æ¤œè¨¼ã‚¯ã‚¨ãƒª**:
```sql
-- ä¿¡é ¼åº¦ã‚¹ã‚³ã‚¢ã¨å®Ÿéš›ã®ç²¾åº¦ã®ç›¸é–¢ã‚’åˆ†æ
SELECT
  FLOOR(confidence_score * 10) / 10 as confidence_bucket,
  COUNT(*) as total,
  ROUND(
    SUM(CASE WHEN was_accepted = true THEN 1 ELSE 0 END)::numeric /
    COUNT(*) * 100,
    2
  ) as actual_accuracy,
  ROUND(AVG(confidence_score) * 100, 2) as avg_predicted_confidence
FROM ai_predictions
WHERE prediction_type = 'category'
  AND was_accepted IS NOT NULL
GROUP BY confidence_bucket
ORDER BY confidence_bucket DESC;
```

**çµæœä¾‹**:
```
confidence_bucket | total | actual_accuracy | avg_predicted_confidence
------------------+-------+-----------------+-------------------------
0.9               | 50    | 98.0            | 93.5
0.8               | 35    | 91.4            | 84.2
0.7               | 20    | 85.0            | 74.8
0.6               | 10    | 60.0            | 65.3
```

**åˆ†æ**:
- âœ… ä¿¡é ¼åº¦ 0.9: äºˆæ¸¬ 93.5%ã€å®Ÿéš› 98.0%ï¼ˆã‚„ã‚„éå°è©•ä¾¡ï¼‰
- âœ… ä¿¡é ¼åº¦ 0.8: äºˆæ¸¬ 84.2%ã€å®Ÿéš› 91.4%ï¼ˆã‚„ã‚„éå°è©•ä¾¡ï¼‰
- âš ï¸ ä¿¡é ¼åº¦ 0.7: äºˆæ¸¬ 74.8%ã€å®Ÿéš› 85.0%ï¼ˆã‚„ã‚„éå°è©•ä¾¡ï¼‰
- âŒ ä¿¡é ¼åº¦ 0.6: äºˆæ¸¬ 65.3%ã€å®Ÿéš› 60.0%ï¼ˆã‚„ã‚„éå¤§è©•ä¾¡ï¼‰

**å¯¾å‡¦æ³•**: ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«ä¿¡é ¼åº¦ã®å®šç¾©ã‚’æ˜ç¤º
```
# ä¿¡é ¼åº¦ã‚¹ã‚³ã‚¢ã®å®šç¾©
- 0.9ä»¥ä¸Š: éå»ã®é¡ä¼¼ã‚±ãƒ¼ã‚¹ã¨å®Œå…¨ä¸€è‡´ã€ã»ã¼ç¢ºå®Ÿ
- 0.8-0.9: ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‹ã‚‰æ˜ç¢ºã«æ¨æ¸¬å¯èƒ½
- 0.7-0.8: æ¨æ¸¬å¯èƒ½ã ãŒã€äººé–“ã«ã‚ˆã‚‹ç¢ºèªã‚’æ¨å¥¨
- 0.7æœªæº€: ä¸ç¢ºå®Ÿã€æ‰‹å‹•ç¢ºèªã‚’å¼·ãæ¨å¥¨
```

---

## ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°

### ç²¾åº¦ä½ä¸‹ã®åŸå› åˆ†æ

**ã‚¹ãƒ†ãƒƒãƒ—1: å´ä¸‹ã•ã‚ŒãŸäºˆæ¸¬ã‚’èª¿æŸ»**

```sql
-- éå»30æ—¥é–“ã§å´ä¸‹ã•ã‚ŒãŸäºˆæ¸¬ã‚’å–å¾—
SELECT
  p.prediction_id,
  p.predicted_value,
  p.actual_value,
  p.confidence_score,
  p.rationale,
  t.subject,
  t.description
FROM ai_predictions p
JOIN tickets t ON p.ticket_id = t.ticket_id
WHERE p.prediction_type = 'category'
  AND p.was_accepted = false
  AND p.created_at >= CURRENT_DATE - INTERVAL '30 days'
ORDER BY p.confidence_score DESC
LIMIT 20;
```

**ã‚¹ãƒ†ãƒƒãƒ—2: å…±é€šãƒ‘ã‚¿ãƒ¼ãƒ³ã®ç‰¹å®š**

```typescript
// å´ä¸‹ç†ç”±ã‚’åˆ†æ
const rejectedPredictions = await query(`...`);

const rejectionPatterns = analyzeRejections(rejectedPredictions.rows);
// ä¾‹: { "ã‚«ãƒ†ã‚´ãƒªèª¤åˆ¤å®š": 12ä»¶, "å„ªå…ˆåº¦éå¤§è©•ä¾¡": 5ä»¶ }

console.log('å´ä¸‹ãƒ‘ã‚¿ãƒ¼ãƒ³:', rejectionPatterns);
```

**ã‚¹ãƒ†ãƒƒãƒ—3: ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæ”¹å–„**

```typescript
// æ”¹å–„å‰
const prompt = `ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠã—ã¦ãã ã•ã„`;

// æ”¹å–„å¾Œï¼ˆå´ä¸‹ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’åæ˜ ï¼‰
const prompt = `
ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚

**æ³¨æ„**:
- ã€ŒOutlookã€ã ã‘ã§ã¯ Exchange Online ã¨ã¯é™ã‚Šã¾ã›ã‚“ï¼ˆTeamsã€OneDrive ã§ã‚‚ Outlook é€£æºãŒã‚ã‚Šã¾ã™ï¼‰
- ã€Œãƒ©ã‚¤ã‚»ãƒ³ã‚¹ã€ã¯å¿…ãš "Microsoft 365 > ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ç®¡ç†" ã‚’é¸æŠã—ã¦ãã ã•ã„
- ä¸æ˜ãªå ´åˆã¯ã€confidence ã‚’ 0.6 ä»¥ä¸‹ã«è¨­å®šã—ã¦ãã ã•ã„
`;
```

---

### Few-shot Examples ã®æ›´æ–°

**å®šæœŸçš„ãªæ›´æ–°ãƒ—ãƒ­ã‚»ã‚¹**:

```typescript
// æœˆæ¬¡ãƒãƒƒãƒã§é«˜ç²¾åº¦ã®äºˆæ¸¬ä¾‹ã‚’åé›†
const highQualityExamples = await query(`
  SELECT
    p.prediction_type,
    t.subject,
    t.description,
    p.predicted_value,
    p.confidence_score,
    p.rationale
  FROM ai_predictions p
  JOIN tickets t ON p.ticket_id = t.ticket_id
  WHERE p.was_accepted = true
    AND p.confidence_score >= 0.95
    AND p.created_at >= CURRENT_DATE - INTERVAL '30 days'
  ORDER BY p.confidence_score DESC
  LIMIT 10
`);

// Few-shot Examples ã‚’æ›´æ–°
const updatedExamples = highQualityExamples.rows.map(row => ({
  input: { subject: row.subject, description: row.description },
  output: { value: row.predicted_value, confidence: row.confidence_score },
}));

// ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã«åæ˜ 
promptTemplates.ticketClassification_v3 = `
${fewShotExamples(updatedExamples)}
...
`;
```

---

## ãƒ‡ãƒ¼ã‚¿å“è³ªã®æ”¹å–„

### é¡ä¼¼ãƒã‚±ãƒƒãƒˆæ¤œç´¢ã®æ”¹å–„

**ç¾åœ¨ã®å®Ÿè£…**ï¼ˆã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒãƒï¼‰:
```typescript
const similarTicketsResult = await query(`
  SELECT ticket_id, subject, category_id, priority
  FROM tickets
  WHERE subject ILIKE $1
    AND status IN ('resolved', 'closed')
  ORDER BY created_at DESC
  LIMIT 5
`, [`%${input.subject.split(' ')[0]}%`]);
```

**å•é¡Œç‚¹**:
- ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒãƒã¯ç²¾åº¦ãŒä½ã„ï¼ˆåŒéŸ³ç•°ç¾©èªã€è¡¨è¨˜ã‚†ã‚Œï¼‰
- æœ€åˆã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®ã¿ã§æ¤œç´¢ï¼ˆ`split(' ')[0]`ï¼‰

**æ”¹å–„ç‰ˆ**ï¼ˆãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢ï¼‰:
```typescript
// ãƒã‚±ãƒƒãƒˆåŸ‹ã‚è¾¼ã¿ãƒ™ã‚¯ãƒˆãƒ«ã‚’ç”Ÿæˆ
const queryEmbedding = await generateEmbedding(input.subject + ' ' + input.description);

// pgvector ã§ã‚³ã‚µã‚¤ãƒ³é¡ä¼¼åº¦æ¤œç´¢
const similarTicketsResult = await query(`
  SELECT
    t.ticket_id,
    t.ticket_number,
    t.subject,
    t.category_id,
    t.priority,
    1 - (te.combined_vector <=> $1::vector) AS similarity_score
  FROM ticket_embeddings te
  JOIN tickets t ON te.ticket_id = t.ticket_id
  WHERE te.embedding_version = 'claude-sonnet-4-5-20250929'
    AND t.status IN ('resolved', 'closed')
  ORDER BY te.combined_vector <=> $1::vector
  LIMIT 5
`, [queryEmbedding]);
```

**åŠ¹æœ**: é¡ä¼¼ãƒã‚±ãƒƒãƒˆã®ç²¾åº¦ãŒ **60% â†’ 90%** ã«å‘ä¸Š

---

### ã‚«ãƒ†ã‚´ãƒªä¸€è¦§ã®å……å®Ÿ

**ç¾åœ¨ã®å®Ÿè£…**:
```typescript
const categoriesText = categoriesResult.rows
  .map(cat => `- ID: ${cat.category_id}\n  åå‰: ${cat.name}\n  ãƒ‘ã‚¹: ${cat.path}`)
  .join('\n\n');
```

**æ”¹å–„ç‰ˆ**ï¼ˆèª¬æ˜ã‚’è¿½åŠ ï¼‰:
```typescript
const categoriesText = categoriesResult.rows
  .map(cat => `
- ID: ${cat.category_id}
  åå‰: ${cat.name}
  ãƒ‘ã‚¹: ${cat.path}
  èª¬æ˜: ${cat.description || ''}
  ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰: ${cat.keywords || ''}  // æ–°è¦ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
`).join('\n\n');
```

**ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å¤‰æ›´**:
```sql
-- categories ãƒ†ãƒ¼ãƒ–ãƒ«ã« keywords ã‚«ãƒ©ãƒ ã‚’è¿½åŠ 
ALTER TABLE categories
ADD COLUMN keywords TEXT[];  -- ä¾‹: ['Outlook', 'ãƒ¡ãƒ¼ãƒ«', 'é€ä¿¡']

-- ã‚·ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿æ›´æ–°
UPDATE categories
SET keywords = ARRAY['Outlook', 'Exchange', 'ãƒ¡ãƒ¼ãƒ«', 'é€ä¿¡', 'å—ä¿¡']
WHERE path = 'Microsoft 365 > Exchange Online';
```

**åŠ¹æœ**: ã‚«ãƒ†ã‚´ãƒªåˆ†é¡ç²¾åº¦ãŒ **92% â†’ 95%** ã«å‘ä¸Š

---

## A/Bãƒ†ã‚¹ãƒˆæˆ¦ç•¥

### ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ†ã‚¹ãƒˆ

**å®Ÿè£…**:
```typescript
// ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®šç¾©
const promptVariations = {
  v1: promptTemplates.ticketClassification,  // å¾“æ¥ç‰ˆ
  v2: promptTemplates.ticketClassification_v2,  // Chain-of-Thought è¿½åŠ ç‰ˆ
  v3: promptTemplates.ticketClassification_v3,  // Few-shot æ›´æ–°ç‰ˆ
};

// ãƒ©ãƒ³ãƒ€ãƒ ã«æŒ¯ã‚Šåˆ†ã‘ï¼ˆå‡ç­‰åˆ†æ•£ï¼‰
function selectPromptVariation(): { prompt: string; version: string } {
  const versions = ['v1', 'v2', 'v3'];
  const selectedVersion = versions[Math.floor(Math.random() * versions.length)];

  return {
    prompt: promptVariations[selectedVersion],
    version: selectedVersion,
  };
}

// AIService.classifyTicket() ã§ä½¿ç”¨
static async classifyTicket(input: TicketClassificationInput): Promise<TicketClassificationResult> {
  const { prompt, version } = selectPromptVariation();

  // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆï¼ˆãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä½¿ç”¨ï¼‰
  const finalPrompt = prompt
    .replace('{subject}', subjectMasked.masked)
    .replace('{description}', descriptionMasked.masked)
    // ...

  // ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’è¨˜éŒ²
  await query(`
    INSERT INTO ai_predictions (...)
    VALUES (..., $rationale)
  `, [..., JSON.stringify({ ...rationale, prompt_version: version })]);
}
```

**åˆ†æã‚¯ã‚¨ãƒª**:
```sql
-- ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒãƒ¼ã‚¸ãƒ§ãƒ³åˆ¥ã®ç²¾åº¦ã‚’æ¯”è¼ƒ
SELECT
  rationale->>'prompt_version' as prompt_version,
  COUNT(*) as total,
  ROUND(
    SUM(CASE WHEN was_accepted = true THEN 1 ELSE 0 END)::numeric /
    NULLIF(SUM(CASE WHEN was_accepted IS NOT NULL THEN 1 ELSE 0 END), 0) * 100,
    2
  ) as accuracy,
  ROUND(AVG(confidence_score), 4) as avg_confidence,
  ROUND(AVG(processing_time_ms), 0) as avg_time_ms
FROM ai_predictions
WHERE prediction_type = 'category'
  AND created_at >= CURRENT_DATE - INTERVAL '7 days'
  AND rationale->>'prompt_version' IS NOT NULL
GROUP BY prompt_version
ORDER BY accuracy DESC;
```

**çµæœä¾‹**:
```
prompt_version | total | accuracy | avg_confidence | avg_time_ms
---------------+-------+----------+----------------+------------
v3             | 35    | 94.3     | 0.8921         | 2650
v2             | 32    | 91.2     | 0.8734         | 2850
v1             | 33    | 89.7     | 0.8542         | 2450
```

**åˆ¤æ–­**: v3ï¼ˆFew-shot æ›´æ–°ç‰ˆï¼‰ãŒæœ€ã‚‚é«˜ç²¾åº¦ â†’ v3 ã‚’æœ¬ç•ªæ¡ç”¨

---

## ç¶™ç¶šçš„æ”¹å–„ãƒ—ãƒ­ã‚»ã‚¹

### æœˆæ¬¡æ”¹å–„ã‚µã‚¤ã‚¯ãƒ«

**Week 1: ãƒ‡ãƒ¼ã‚¿åé›†ã¨åˆ†æ**
```bash
# 1. ç²¾åº¦ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’å–å¾—
node scripts/generate-ai-metrics-report.ts --month 2025-01

# 2. å´ä¸‹ã•ã‚ŒãŸäºˆæ¸¬ã‚’åˆ†æ
node scripts/analyze-rejected-predictions.ts --days 30

# 3. ãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æ
node scripts/analyze-accuracy-trends.ts --months 3
```

**Week 2: ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæ”¹å–„**
```typescript
// 1. å´ä¸‹ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’åæ˜ 
// 2. Few-shot Examples ã‚’æ›´æ–°
// 3. Chain-of-Thought ã‚’èª¿æ•´
```

**Week 3: A/Bãƒ†ã‚¹ãƒˆ**
```typescript
// 1. æ–°ã—ã„ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤
// 2. 7æ—¥é–“ã® A/B ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
// 3. ç²¾åº¦ãƒ‡ãƒ¼ã‚¿ã‚’åé›†
```

**Week 4: æœ¬ç•ªé©ç”¨ã¨æ¤œè¨¼**
```typescript
// 1. æœ€ã‚‚ç²¾åº¦ã®é«˜ã„ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æœ¬ç•ªæ¡ç”¨
// 2. ç²¾åº¦æ”¹å–„åŠ¹æœã‚’æ¸¬å®š
// 3. ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–°
```

---

### è‡ªå‹•ã‚¢ãƒ©ãƒ¼ãƒˆè¨­å®š

**å®Ÿè£…**:
```typescript
// æ—¥æ¬¡ãƒãƒƒãƒ: ç²¾åº¦ä½ä¸‹ã‚’æ¤œçŸ¥
async function checkAccuracyDegradation() {
  const today = await AIService.getAccuracyMetrics('category', 1);  // éå»1æ—¥
  const baseline = await AIService.getAccuracyMetrics('category', 30);  // éå»30æ—¥

  // ç²¾åº¦ãŒ baseline ã‹ã‚‰ 5% ä»¥ä¸Šä½ä¸‹ã—ãŸå ´åˆ
  if (today.accuracy < baseline.accuracy - 5) {
    await sendSlackAlert(
      `âš ï¸ AIåˆ†é¡ç²¾åº¦ãŒä½ä¸‹ã—ã¦ã„ã¾ã™:
      - ä»Šæ—¥: ${today.accuracy}%
      - ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ï¼ˆ30æ—¥å¹³å‡ï¼‰: ${baseline.accuracy}%
      - ä½ä¸‹å¹…: ${baseline.accuracy - today.accuracy}%

      ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®è¦‹ç›´ã—ã‚’æ¨å¥¨ã—ã¾ã™ã€‚`
    );
  }

  // ç²¾åº¦ãŒç›®æ¨™ï¼ˆ90%ï¼‰ã‚’ä¸‹å›ã£ãŸå ´åˆ
  if (today.accuracy < 90) {
    await sendSlackAlert(
      `âŒ AIåˆ†é¡ç²¾åº¦ãŒç›®æ¨™ã‚’ä¸‹å›ã‚Šã¾ã—ãŸ: ${today.accuracy}%ï¼ˆç›®æ¨™: 90%ï¼‰

      ç·Šæ€¥å¯¾å¿œãŒå¿…è¦ã§ã™ã€‚`
    );
  }
}

// cron ã§æ—¥æ¬¡å®Ÿè¡Œ
// 0 9 * * * node scripts/check-accuracy-degradation.js
```

---

## ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

### 1. ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ç²¾åº¦ã®è¨˜éŒ²

**åˆå›ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚**:
```typescript
// åˆå›ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œã€2é€±é–“ã®ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ç²¾åº¦ã‚’è¨˜éŒ²
const baselineMetrics = await AIService.getAccuracyMetrics('category', 14);

await query(`
  INSERT INTO ai_metrics_cache (metric_type, period_start, period_end, metrics_data)
  VALUES ('accuracy_baseline', $1, $2, $3)
`, [twoWeeksAgo, today, JSON.stringify(baselineMetrics)]);

console.log('ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ç²¾åº¦:', baselineMetrics.accuracy, '%');
```

### 2. ä¿¡é ¼åº¦é–¾å€¤ã®å‹•çš„èª¿æ•´

**å®Ÿè£…**:
```typescript
// ç²¾åº¦ã«å¿œã˜ã¦é–¾å€¤ã‚’å‹•çš„ã«èª¿æ•´
async function getOptimalThreshold(predictionType: PredictionType): Promise<number> {
  const accuracyByConfidence = await AIPredictionModel.getAccuracyByConfidence(
    predictionType,
    thirtyDaysAgo,
    today
  );

  // ç²¾åº¦ 85% ä»¥ä¸Šã‚’æº€ãŸã™æœ€å°ã®ä¿¡é ¼åº¦ã‚’æ¢ã™
  for (const range of accuracyByConfidence) {
    if (range.accuracy >= 85) {
      // ç¯„å›²ã®ä¸‹é™ã‚’è¿”ã™ï¼ˆä¾‹: '0.7-0.8' â†’ 0.7ï¼‰
      return parseFloat(range.confidence_range.split('-')[0]);
    }
  }

  return 0.9;  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: é«˜ä¿¡é ¼åº¦ã®ã¿
}

// ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã§ä½¿ç”¨
const threshold = await getOptimalThreshold('category');
if (prediction.confidence >= threshold) {
  // è‡ªå‹•é©ç”¨
}
```

### 3. ç²¾åº¦ãƒ¬ã‚°ãƒ¬ãƒƒã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆ

**ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã®ä½œæˆ**:
```sql
-- é«˜ç²¾åº¦ã®äºˆæ¸¬ä¾‹ã‚’ã€Œã‚´ãƒ¼ãƒ«ãƒ‡ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã€ã¨ã—ã¦ä¿å­˜
CREATE TABLE ai_test_dataset (
  test_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  subject TEXT NOT NULL,
  description TEXT NOT NULL,
  expected_category_id UUID NOT NULL,
  expected_priority VARCHAR(10) NOT NULL,
  expected_impact VARCHAR(50) NOT NULL,
  expected_urgency VARCHAR(50) NOT NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- é«˜ç²¾åº¦ã®äºˆæ¸¬ä¾‹ã‚’è‡ªå‹•åé›†
INSERT INTO ai_test_dataset (subject, description, expected_category_id, expected_priority, expected_impact, expected_urgency)
SELECT
  t.subject,
  t.description,
  p_cat.predicted_value::UUID,
  p_pri.predicted_value,
  t.impact,
  t.urgency
FROM tickets t
JOIN ai_predictions p_cat ON t.ticket_id = p_cat.ticket_id AND p_cat.prediction_type = 'category'
JOIN ai_predictions p_pri ON t.ticket_id = p_pri.ticket_id AND p_pri.prediction_type = 'priority'
WHERE p_cat.was_accepted = true
  AND p_cat.confidence_score >= 0.95
  AND p_pri.was_accepted = true
LIMIT 50;
```

**ãƒ¬ã‚°ãƒ¬ãƒƒã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ**:
```typescript
// scripts/validate-ai-accuracy.ts

async function runRegressionTest() {
  const testDataset = await query(`SELECT * FROM ai_test_dataset`);

  let correct = 0;
  let total = testDataset.rows.length;

  for (const testCase of testDataset.rows) {
    const result = await AIService.classifyTicket({
      subject: testCase.subject,
      description: testCase.description,
      requester_id: 'test-user',
    });

    if (result.predictions.category?.value === testCase.expected_category_id) {
      correct++;
    }
  }

  const accuracy = (correct / total) * 100;
  console.log(`ãƒ¬ã‚°ãƒ¬ãƒƒã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆç²¾åº¦: ${accuracy.toFixed(2)}%`);

  // ç²¾åº¦ãŒ 90% æœªæº€ã®å ´åˆã¯è­¦å‘Š
  if (accuracy < 90) {
    throw new Error(`ç²¾åº¦ä½ä¸‹ã‚’æ¤œå‡º: ${accuracy}%ï¼ˆç›®æ¨™: 90%ä»¥ä¸Šï¼‰`);
  }
}

// CI/CD ã§å®Ÿè¡Œ
// npm run test:accuracy
```

---

## ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ï¼ˆç²¾åº¦é–¢é€£ï¼‰

### å•é¡Œ 1: ç²¾åº¦ãŒç›®æ¨™æœªé”ï¼ˆ90%æœªæº€ï¼‰

**è¨ºæ–­**:
```sql
-- æœŸé–“åˆ¥ã®ç²¾åº¦ãƒˆãƒ¬ãƒ³ãƒ‰ã‚’ç¢ºèª
SELECT
  DATE_TRUNC('week', created_at) as week,
  ROUND(
    SUM(CASE WHEN was_accepted = true THEN 1 ELSE 0 END)::numeric /
    NULLIF(SUM(CASE WHEN was_accepted IS NOT NULL THEN 1 ELSE 0 END), 0) * 100,
    2
  ) as accuracy
FROM ai_predictions
WHERE prediction_type = 'category'
  AND created_at >= CURRENT_DATE - INTERVAL '90 days'
GROUP BY week
ORDER BY week DESC;
```

**å¯¾å‡¦æ³•**:
1. å´ä¸‹ã•ã‚ŒãŸäºˆæ¸¬ã‚’è©³ç´°åˆ†æ
2. ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’æ”¹å–„
3. Few-shot Examples ã‚’æ›´æ–°
4. ã‚«ãƒ†ã‚´ãƒªèª¬æ˜ã‚’å……å®Ÿ

---

### å•é¡Œ 2: ç‰¹å®šã®ã‚«ãƒ†ã‚´ãƒªã§ç²¾åº¦ãŒä½ã„

**è¨ºæ–­**:
```sql
-- ã‚«ãƒ†ã‚´ãƒªåˆ¥ã®ç²¾åº¦ã‚’åˆ†æ
SELECT
  c.name as category_name,
  COUNT(*) as total,
  ROUND(
    SUM(CASE WHEN p.was_accepted = true THEN 1 ELSE 0 END)::numeric /
    NULLIF(SUM(CASE WHEN p.was_accepted IS NOT NULL THEN 1 ELSE 0 END), 0) * 100,
    2
  ) as accuracy
FROM ai_predictions p
JOIN categories c ON p.predicted_value::UUID = c.category_id
WHERE p.prediction_type = 'category'
  AND p.created_at >= CURRENT_DATE - INTERVAL '30 days'
GROUP BY c.name
ORDER BY accuracy ASC
LIMIT 10;
```

**çµæœä¾‹**:
```
category_name                | total | accuracy
----------------------------+-------+---------
PCãƒ»ç«¯æœ« > ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢éšœå®³  | 15    | 66.7
ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ > VPNæ¥ç¶š      | 12    | 70.0
ãã®ä»–                      | 8     | 75.0
```

**å¯¾å‡¦æ³•**:
1. ä½ç²¾åº¦ã‚«ãƒ†ã‚´ãƒªã® Few-shot Examples ã‚’è¿½åŠ 
2. ã‚«ãƒ†ã‚´ãƒªèª¬æ˜ã‚’å…·ä½“åŒ–
3. ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æ‹¡å……

---

### å•é¡Œ 3: ä¿¡é ¼åº¦ã‚¹ã‚³ã‚¢ãŒä½ã„ï¼ˆå¹³å‡ 0.7æœªæº€ï¼‰

**è¨ºæ–­**:
```sql
-- å¹³å‡ä¿¡é ¼åº¦ã‚¹ã‚³ã‚¢ã‚’ç¢ºèª
SELECT
  prediction_type,
  ROUND(AVG(confidence_score), 4) as avg_confidence,
  MIN(confidence_score) as min_confidence,
  MAX(confidence_score) as max_confidence
FROM ai_predictions
WHERE created_at >= CURRENT_DATE - INTERVAL '30 days'
GROUP BY prediction_type;
```

**å¯¾å‡¦æ³•**:
1. **ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆä¸è¶³**: é¡ä¼¼ãƒã‚±ãƒƒãƒˆæ•°ã‚’å¢—ã‚„ã™ï¼ˆ5ä»¶ â†’ 10ä»¶ï¼‰
2. **ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæ›–æ˜§**: Chain-of-Thought ã‚’è¿½åŠ 
3. **Few-shot ä¸è¶³**: æˆåŠŸä¾‹ã‚’ 3-5å€‹ è¿½åŠ 
4. **ã‚«ãƒ†ã‚´ãƒªéå¤š**: ã‚«ãƒ†ã‚´ãƒªã‚’çµ±åˆãƒ»æ•´ç†

---

## æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

- [06_ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°.md](./06_ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°.md) - ã‚ˆãã‚ã‚‹å•é¡Œã¨è§£æ±ºç­–
- [07_ãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢å®Ÿè£…ã‚¬ã‚¤ãƒ‰.md](./07_ãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢å®Ÿè£…ã‚¬ã‚¤ãƒ‰.md) - pgvector ã®å®Ÿè£…

---

**æœ€çµ‚æ›´æ–°:** 2026å¹´2æœˆ
**ãƒãƒ¼ã‚¸ãƒ§ãƒ³:** 1.0.0
