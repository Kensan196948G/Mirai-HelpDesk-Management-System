# ãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢å®Ÿè£…ã‚¬ã‚¤ãƒ‰

pgvector ã‚’ä½¿ç”¨ã—ãŸã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯æ¤œç´¢ã®å®Ÿè£…æ–¹æ³•ã€åŸ‹ã‚è¾¼ã¿ãƒ™ã‚¯ãƒˆãƒ«ç”Ÿæˆã€HNSW ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æœ€é©åŒ–ã‚’è§£èª¬ã—ã¾ã™ã€‚

---

## ğŸ“‹ ç›®æ¬¡

1. [ãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢ã¨ã¯](#ãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢ã¨ã¯)
2. [pgvector ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—](#pgvector-ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—)
3. [åŸ‹ã‚è¾¼ã¿ãƒ™ã‚¯ãƒˆãƒ«ã®ç”Ÿæˆ](#åŸ‹ã‚è¾¼ã¿ãƒ™ã‚¯ãƒˆãƒ«ã®ç”Ÿæˆ)
4. [ãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢ã®å®Ÿè£…](#ãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢ã®å®Ÿè£…)
5. [HNSW ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®æœ€é©åŒ–](#hnsw-ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®æœ€é©åŒ–)
6. [ãƒãƒƒãƒå‡¦ç†ã®å®Ÿè£…](#ãƒãƒƒãƒå‡¦ç†ã®å®Ÿè£…)
7. [ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°](#ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°)

---

## ãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢ã¨ã¯

### æ¦‚è¦

**ãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢**ï¼ˆSemantic Searchï¼‰ã¯ã€ãƒ†ã‚­ã‚¹ãƒˆã®**æ„å‘³çš„ãªé¡ä¼¼æ€§**ã«åŸºã¥ã„ã¦æ¤œç´¢ã™ã‚‹æ‰‹æ³•ã§ã™ã€‚

### å¾“æ¥ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢ã¨ã®æ¯”è¼ƒ

| æ¤œç´¢æ–¹å¼ | ä»•çµ„ã¿ | ä¾‹ |
|---------|--------|---|
| **ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢** | æ–‡å­—åˆ—ã®å®Œå…¨ä¸€è‡´ãƒ»éƒ¨åˆ†ä¸€è‡´ | "Outlook ã‚¨ãƒ©ãƒ¼" â†’ "Outlook" ã‚’å«ã‚€ãƒã‚±ãƒƒãƒˆã‚’æ¤œç´¢ |
| **ãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢** | æ„å‘³çš„ãªé¡ä¼¼æ€§ | "Outlook ã‚¨ãƒ©ãƒ¼" â†’ "ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã§ããªã„"ã€"æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«å•é¡Œ" ã‚‚æ¤œç´¢ |

**ãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢ã®åˆ©ç‚¹**:
- âœ… **åŒç¾©èªãƒ»é¡ç¾©èª**: "PC" ã¨ "ãƒ‘ã‚½ã‚³ãƒ³" ã‚’åŒä¸€è¦–
- âœ… **è¡¨è¨˜ã‚†ã‚Œ**: "outlook" ã¨ "Outlook" ã‚’åŒä¸€è¦–
- âœ… **æ„å‘³ç†è§£**: "é€ä¿¡ã§ããªã„" ã¨ "ã‚¨ãƒ©ãƒ¼ãŒå‡ºã‚‹" ã‚’é¡ä¼¼ã¨åˆ¤å®š
- âœ… **å¤šè¨€èªå¯¾å¿œ**: æ—¥æœ¬èªã¨è‹±èªã®æ··åœ¨ã‚‚æ¤œç´¢å¯èƒ½

---

### ãƒ™ã‚¯ãƒˆãƒ«åŒ–ï¼ˆEmbeddingï¼‰ã®ä»•çµ„ã¿

**ãƒ—ãƒ­ã‚»ã‚¹**:
```
1. ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›
   ä¾‹: "Outlookã§æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ãŒé€ä¿¡ã§ããªã„"
   â†“
2. AI ãƒ¢ãƒ‡ãƒ«ï¼ˆClaudeï¼‰ã§åŸ‹ã‚è¾¼ã¿ãƒ™ã‚¯ãƒˆãƒ«ã«å¤‰æ›
   ä¾‹: [0.123, -0.456, 0.789, ..., 0.234]ï¼ˆ1024æ¬¡å…ƒï¼‰
   â†“
3. ãƒ™ã‚¯ãƒˆãƒ«ã‚’ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜
   â†“
4. æ¤œç´¢æ™‚: æ¤œç´¢ã‚¯ã‚¨ãƒªã‚‚ãƒ™ã‚¯ãƒˆãƒ«åŒ–ã—ã€ã‚³ã‚µã‚¤ãƒ³é¡ä¼¼åº¦ã§æ¯”è¼ƒ
   â†“
5. é¡ä¼¼åº¦ãŒé«˜ã„é †ã«ãƒ©ãƒ³ã‚­ãƒ³ã‚°
```

**ã‚³ã‚µã‚¤ãƒ³é¡ä¼¼åº¦**:
```
similarity = 1 - cosine_distance
         = dot(A, B) / (||A|| * ||B||)
         = 0.0-1.0ï¼ˆ1.0 ã«è¿‘ã„ã»ã©é¡ä¼¼ï¼‰
```

---

## pgvector ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

### 1. pgvector ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

**Ubuntu/Debian:**
```bash
# PostgreSQL ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç¢ºèª
psql --version

# pgvector ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆPostgreSQL 15 ã®å ´åˆï¼‰
sudo apt update
sudo apt install postgresql-15-pgvector

# PostgreSQL ã‚’å†èµ·å‹•
sudo systemctl restart postgresql
```

**macOSï¼ˆHomebrewï¼‰:**
```bash
# Homebrew ã§ pgvector ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
brew install pgvector

# PostgreSQL ã‚’å†èµ·å‹•
brew services restart postgresql@15
```

**Docker:**
```yaml
# docker-compose.yml
version: '3.8'
services:
  postgres:
    image: pgvector/pgvector:pg15
    environment:
      POSTGRES_DB: mirai_helpdesk
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password
    ports:
      - "5432:5432"
    volumes:
      - pgdata:/var/lib/postgresql/data

volumes:
  pgdata:
```

**ã‚½ãƒ¼ã‚¹ã‹ã‚‰ãƒ“ãƒ«ãƒ‰:**
```bash
# ãƒªãƒã‚¸ãƒˆãƒªã‚’ã‚¯ãƒ­ãƒ¼ãƒ³
git clone https://github.com/pgvector/pgvector.git
cd pgvector

# ãƒ“ãƒ«ãƒ‰
make

# ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆè¦ç®¡ç†è€…æ¨©é™ï¼‰
sudo make install

# PostgreSQL ã‚’å†èµ·å‹•
sudo systemctl restart postgresql
```

---

### 2. æ‹¡å¼µæ©Ÿèƒ½ã®æœ‰åŠ¹åŒ–

**SQL ã‚³ãƒãƒ³ãƒ‰:**
```sql
-- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«æ¥ç¶š
psql -U postgres -d mirai_helpdesk

-- pgvector æ‹¡å¼µã‚’æœ‰åŠ¹åŒ–
CREATE EXTENSION IF NOT EXISTS vector;

-- ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç¢ºèª
SELECT * FROM pg_available_extensions WHERE name = 'vector';

-- æœŸå¾…ã•ã‚Œã‚‹å‡ºåŠ›:
--   name   | version | installed_version | comment
-- ---------+---------+-------------------+---------
--   vector | 0.5.1   | 0.5.1             | vector data type and ivfflat and hnsw access methods
```

**ç¢ºèªã‚¯ã‚¨ãƒª:**
```sql
-- vector å‹ãŒä½¿ç”¨å¯èƒ½ã‹ç¢ºèª
CREATE TABLE test_vectors (id serial PRIMARY KEY, vec vector(3));
INSERT INTO test_vectors (vec) VALUES ('[1,2,3]'), ('[4,5,6]');
SELECT vec FROM test_vectors;

-- ã‚³ã‚µã‚¤ãƒ³è·é›¢ã‚’è¨ˆç®—
SELECT vec <=> '[1,2,3]'::vector AS distance FROM test_vectors;

-- ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
DROP TABLE test_vectors;
```

---

### 3. ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®å®Ÿè¡Œ

**ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«**: `database/migrations/013_add_vector_search.sql`

**å®Ÿè¡Œ**:
```bash
cd backend
npm run migrate

# å‡ºåŠ›ä¾‹:
# âœ… Running migration: 013_add_vector_search.sql
# âœ… Extension 'vector' created
# âœ… Table 'ticket_embeddings' created
# âœ… Index 'idx_ticket_embeddings_combined_hnsw' created
```

**ç¢ºèª**:
```sql
-- ãƒ†ãƒ¼ãƒ–ãƒ«ãŒä½œæˆã•ã‚ŒãŸã‹ç¢ºèª
\d ticket_embeddings

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒä½œæˆã•ã‚ŒãŸã‹ç¢ºèª
SELECT indexname, indexdef
FROM pg_indexes
WHERE tablename = 'ticket_embeddings';

-- æœŸå¾…ã•ã‚Œã‚‹å‡ºåŠ›:
-- idx_ticket_embeddings_combined_hnsw | CREATE INDEX ... USING hnsw (combined_vector vector_cosine_ops)
```

---

## åŸ‹ã‚è¾¼ã¿ãƒ™ã‚¯ãƒˆãƒ«ã®ç”Ÿæˆ

### Claude API ã§åŸ‹ã‚è¾¼ã¿ã‚’ç”Ÿæˆ

**æ³¨æ„**: Claude API ã¯ç¾åœ¨ã€å°‚ç”¨ã® Embeddings API ã‚’æä¾›ã—ã¦ã„ã¾ã›ã‚“ã€‚ä»£ã‚ã‚Šã«ã€ãƒã‚±ãƒƒãƒˆå†…å®¹ã‚’è¦ç´„ã—ã€ãã®è¦ç´„ã‹ã‚‰ãƒ™ã‚¯ãƒˆãƒ«ã‚’ç”Ÿæˆã™ã‚‹ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

**å®Ÿè£…**ï¼ˆå°†æ¥çš„ã«å°‚ç”¨APIå¯¾å¿œäºˆå®šï¼‰:
```typescript
// backend/src/services/vector-search.service.ts

export class VectorSearchService {
  /**
   * ãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰åŸ‹ã‚è¾¼ã¿ãƒ™ã‚¯ãƒˆãƒ«ã‚’ç”Ÿæˆ
   *
   * æ³¨æ„: Claude ã¯ç¾åœ¨ã€Embeddings API ã‚’æä¾›ã—ã¦ã„ãªã„ãŸã‚ã€
   * ä»£æ›¿ã¨ã—ã¦ä»¥ä¸‹ã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã‚’ä½¿ç”¨:
   * 1. ãƒ†ã‚­ã‚¹ãƒˆã‚’è¦ç´„ï¼ˆClaudeï¼‰
   * 2. è¦ç´„ã‚’ãƒ™ã‚¯ãƒˆãƒ«åŒ–ï¼ˆå°†æ¥: å°‚ç”¨APIã€ç¾åœ¨: ç°¡æ˜“å®Ÿè£…ï¼‰
   */
  static async generateEmbedding(text: string): Promise<number[]> {
    // TODO: å°‚ç”¨ã® Embeddings API ã«ç½®ãæ›ãˆ
    // ç¾åœ¨ã¯ç°¡æ˜“çš„ãªå®Ÿè£…ï¼ˆTF-IDF ã¾ãŸã¯ OpenAI Embeddings ã‚’ä½¿ç”¨ï¼‰

    // ã‚ªãƒ—ã‚·ãƒ§ãƒ³1: OpenAI Embeddings APIï¼ˆæ¨å¥¨ï¼‰
    // const embedding = await openai.embeddings.create({
    //   model: 'text-embedding-3-large',
    //   input: text,
    // });
    // return embedding.data[0].embedding;

    // ã‚ªãƒ—ã‚·ãƒ§ãƒ³2: ãƒ­ãƒ¼ã‚«ãƒ«ãƒ¢ãƒ‡ãƒ«ï¼ˆSentence Transformersï¼‰
    // const embedding = await sentenceTransformer.encode(text);
    // return embedding;

    // ã‚ªãƒ—ã‚·ãƒ§ãƒ³3: TF-IDFï¼ˆã‚·ãƒ³ãƒ—ãƒ«ã ãŒç²¾åº¦ä½ã„ï¼‰
    return this.simpleTFIDFEmbedding(text);
  }

  /**
   * ç°¡æ˜“çš„ãª TF-IDF ãƒ™ã‚¯ãƒˆãƒ«åŒ–ï¼ˆé–‹ç™ºç”¨ï¼‰
   *
   * æ³¨æ„: æœ¬ç•ªç’°å¢ƒã§ã¯å°‚ç”¨ã® Embeddings API ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„
   */
  private static simpleTFIDFEmbedding(text: string): number[] {
    // å½¢æ…‹ç´ è§£æï¼ˆæ—¥æœ¬èªå¯¾å¿œï¼‰
    const tokens = this.tokenize(text);

    // TF-IDF è¨ˆç®—ï¼ˆç°¡æ˜“ç‰ˆï¼‰
    const vector = new Array(1024).fill(0);

    tokens.forEach((token, index) => {
      const hash = this.hashString(token);
      const position = hash % 1024;
      vector[position] += 1;
    });

    // æ­£è¦åŒ–ï¼ˆL2ãƒãƒ«ãƒ ï¼‰
    const norm = Math.sqrt(vector.reduce((sum, val) => sum + val * val, 0));
    return vector.map(val => val / norm);
  }

  private static tokenize(text: string): string[] {
    // ç°¡æ˜“çš„ãªæ—¥æœ¬èªãƒˆãƒ¼ã‚¯ãƒ³åŒ–ï¼ˆæœ¬ç•ªã§ã¯ Kuromoji ç­‰ã‚’ä½¿ç”¨ï¼‰
    return text
      .toLowerCase()
      .replace(/[^\w\s]/g, '')
      .split(/\s+/)
      .filter(token => token.length > 1);
  }

  private static hashString(str: string): number {
    let hash = 0;
    for (let i = 0; i < str.length; i++) {
      hash = (hash << 5) - hash + str.charCodeAt(i);
      hash |= 0;  // 32bit æ•´æ•°ã«å¤‰æ›
    }
    return Math.abs(hash);
  }
}
```

**æ¨å¥¨: OpenAI Embeddings API ã®ä½¿ç”¨**

```typescript
import OpenAI from 'openai';

const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY,
});

export class VectorSearchService {
  static async generateEmbedding(text: string): Promise<number[]> {
    const response = await openai.embeddings.create({
      model: 'text-embedding-3-large',  // 3072æ¬¡å…ƒ
      input: text,
      dimensions: 1024,  // 1024æ¬¡å…ƒã«å‰Šæ¸›
    });

    return response.data[0].embedding;
  }
}
```

**ã‚³ã‚¹ãƒˆ**: OpenAI text-embedding-3-large ã¯ $0.13 per 1M tokensï¼ˆéå¸¸ã«å®‰ä¾¡ï¼‰

---

### ãƒã‚±ãƒƒãƒˆä½œæˆæ™‚ã«åŸ‹ã‚è¾¼ã¿ã‚’ç”Ÿæˆ

**å®Ÿè£…**:
```typescript
// backend/src/controllers/ticket.controller.ts

export class TicketController {
  static createTicket = asyncHandler(async (req, res, next) => {
    // 1. ãƒã‚±ãƒƒãƒˆã‚’ä½œæˆ
    const ticket = await TicketModel.create({ ... });

    // 2. åŸ‹ã‚è¾¼ã¿ãƒ™ã‚¯ãƒˆãƒ«ã‚’ç”Ÿæˆï¼ˆéåŒæœŸï¼‰
    // æ³¨æ„: await ã—ãªã„ã“ã¨ã§ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’é…å»¶ã•ã›ãªã„
    VectorSearchService.generateAndSaveEmbedding(ticket.ticket_id, ticket.subject, ticket.description)
      .catch(error => {
        console.error('åŸ‹ã‚è¾¼ã¿ç”Ÿæˆã‚¨ãƒ©ãƒ¼:', error);
        // ã‚¨ãƒ©ãƒ¼ã¯è¨˜éŒ²ã™ã‚‹ãŒã€ãƒã‚±ãƒƒãƒˆä½œæˆã¯æˆåŠŸæ‰±ã„
      });

    res.json({ success: true, data: ticket });
  });
}
```

**TicketEmbeddingModel ã®å®Ÿè£…**:
```typescript
// backend/src/models/ticket-embedding.model.ts

export class TicketEmbeddingModel {
  /**
   * åŸ‹ã‚è¾¼ã¿ãƒ™ã‚¯ãƒˆãƒ«ã‚’ä¿å­˜
   */
  static async create(data: {
    ticket_id: string;
    embedding_version: string;
    subject_vector: number[];
    description_vector: number[];
    combined_vector: number[];
  }): Promise<void> {
    await query(`
      INSERT INTO ticket_embeddings (
        ticket_id, embedding_version,
        subject_vector, description_vector, combined_vector
      )
      VALUES ($1, $2, $3::vector, $4::vector, $5::vector)
      ON CONFLICT (ticket_id, embedding_version)
      DO UPDATE SET
        subject_vector = EXCLUDED.subject_vector,
        description_vector = EXCLUDED.description_vector,
        combined_vector = EXCLUDED.combined_vector,
        updated_at = CURRENT_TIMESTAMP
    `, [
      data.ticket_id,
      data.embedding_version,
      JSON.stringify(data.subject_vector),  // [0.1, 0.2, ..., 0.3]
      JSON.stringify(data.description_vector),
      JSON.stringify(data.combined_vector),
    ]);
  }
}
```

---

## ãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢ã®å®Ÿè£…

### VectorSearchService ã®å®Ÿè£…

**ãƒ•ã‚¡ã‚¤ãƒ«**: `backend/src/services/vector-search.service.ts`

```typescript
import { query } from '../config/database';
import { TicketEmbeddingModel } from '../models/ticket-embedding.model';

export interface SimilarTicket {
  ticket_id: string;
  ticket_number: string;
  subject: string;
  description: string;
  category: string;
  status: string;
  similarity_score: number;
  resolution_summary?: string;
  helpful_comments?: string[];
}

export class VectorSearchService {
  /**
   * é¡ä¼¼ãƒã‚±ãƒƒãƒˆã‚’æ¤œç´¢
   */
  static async searchSimilarTickets(params: {
    query: string;
    limit?: number;
    statusFilter?: string[];
    minSimilarity?: number;
  }): Promise<SimilarTicket[]> {
    const { query: searchQuery, limit = 5, statusFilter = ['resolved', 'closed'], minSimilarity = 0.7 } = params;

    // 1. æ¤œç´¢ã‚¯ã‚¨ãƒªã‚’ãƒ™ã‚¯ãƒˆãƒ«åŒ–
    const queryEmbedding = await this.generateEmbedding(searchQuery);

    // 2. pgvector ã§ã‚³ã‚µã‚¤ãƒ³é¡ä¼¼åº¦æ¤œç´¢
    const result = await query(
      `
      SELECT
        t.ticket_id,
        t.ticket_number,
        t.subject,
        t.description,
        c.name as category,
        t.status,
        t.resolution_summary,
        1 - (te.combined_vector <=> $1::vector) AS similarity_score
      FROM ticket_embeddings te
      JOIN tickets t ON te.ticket_id = t.ticket_id
      LEFT JOIN categories c ON t.category_id = c.category_id
      WHERE te.embedding_version = $2
        AND t.status = ANY($3)
        AND 1 - (te.combined_vector <=> $1::vector) >= $4
      ORDER BY te.combined_vector <=> $1::vector
      LIMIT $5
      `,
      [
        JSON.stringify(queryEmbedding),
        'claude-sonnet-4-5-20250929',
        statusFilter,
        minSimilarity,
        limit,
      ]
    );

    // 3. æœ‰ç”¨ãªã‚³ãƒ¡ãƒ³ãƒˆã‚’å–å¾—
    const ticketsWithComments = await Promise.all(
      result.rows.map(async (ticket) => {
        const commentsResult = await query(
          `
          SELECT body
          FROM ticket_comments
          WHERE ticket_id = $1
            AND visibility = 'public'
          ORDER BY created_at DESC
          LIMIT 3
          `,
          [ticket.ticket_id]
        );

        return {
          ...ticket,
          helpful_comments: commentsResult.rows.map((c) => c.body),
        };
      })
    );

    return ticketsWithComments;
  }

  /**
   * ãƒã‚±ãƒƒãƒˆåŸ‹ã‚è¾¼ã¿ãƒ™ã‚¯ãƒˆãƒ«ã‚’ç”Ÿæˆãƒ»ä¿å­˜
   */
  static async generateAndSaveEmbedding(
    ticketId: string,
    subject: string,
    description: string
  ): Promise<void> {
    try {
      // 1. å„è¦ç´ ã®ãƒ™ã‚¯ãƒˆãƒ«ã‚’ç”Ÿæˆ
      const subjectVector = await this.generateEmbedding(subject);
      const descriptionVector = await this.generateEmbedding(description);

      // 2. çµ±åˆãƒ™ã‚¯ãƒˆãƒ«ã‚’ç”Ÿæˆï¼ˆä»¶åã¨è©³ç´°ã‚’çµåˆï¼‰
      const combinedText = `${subject}\n\n${description}`;
      const combinedVector = await this.generateEmbedding(combinedText);

      // 3. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜
      await TicketEmbeddingModel.create({
        ticket_id: ticketId,
        embedding_version: 'claude-sonnet-4-5-20250929',
        subject_vector: subjectVector,
        description_vector: descriptionVector,
        combined_vector: combinedVector,
      });

      console.log(`âœ… åŸ‹ã‚è¾¼ã¿ãƒ™ã‚¯ãƒˆãƒ«ç”Ÿæˆå®Œäº†: ${ticketId}`);
    } catch (error) {
      console.error(`âŒ åŸ‹ã‚è¾¼ã¿ç”Ÿæˆã‚¨ãƒ©ãƒ¼ (${ticketId}):`, error);
      throw error;
    }
  }
}
```

---

### æ¤œç´¢ã‚¯ã‚¨ãƒªã®ä¾‹

**SQLï¼ˆpgvectorï¼‰:**
```sql
-- é¡ä¼¼ãƒã‚±ãƒƒãƒˆã‚’æ¤œç´¢
SELECT
  t.ticket_id,
  t.ticket_number,
  t.subject,
  1 - (te.combined_vector <=> $1::vector) AS similarity_score
FROM ticket_embeddings te
JOIN tickets t ON te.ticket_id = t.ticket_id
WHERE te.embedding_version = 'claude-sonnet-4-5-20250929'
  AND t.status IN ('resolved', 'closed')
  AND 1 - (te.combined_vector <=> $1::vector) >= 0.7  -- é¡ä¼¼åº¦ 70% ä»¥ä¸Š
ORDER BY te.combined_vector <=> $1::vector  -- è·é›¢ãŒè¿‘ã„é †ï¼ˆé¡ä¼¼åº¦ãŒé«˜ã„é †ï¼‰
LIMIT 5;
```

**æ¼”ç®—å­ã®æ„å‘³**:
- `<=>`: ã‚³ã‚µã‚¤ãƒ³è·é›¢ï¼ˆ0 ã«è¿‘ã„ã»ã©é¡ä¼¼ï¼‰
- `1 - è·é›¢`: ã‚³ã‚µã‚¤ãƒ³é¡ä¼¼åº¦ï¼ˆ1 ã«è¿‘ã„ã»ã©é¡ä¼¼ï¼‰

---

## HNSW ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®æœ€é©åŒ–

### HNSW ã¨ã¯

**HNSW**ï¼ˆHierarchical Navigable Small Worldï¼‰ã¯ã€å¤§è¦æ¨¡ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã§ã®é«˜é€Ÿãªè¿‘ä¼¼æœ€è¿‘å‚æ¢ç´¢ï¼ˆANNï¼‰ã‚’å®Ÿç¾ã™ã‚‹ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã§ã™ã€‚

**ç‰¹å¾´**:
- **é«˜é€Ÿ**: O(log n) ã®æ¤œç´¢æ™‚é–“ï¼ˆãƒ•ãƒ«ã‚¹ã‚­ãƒ£ãƒ³ã¯ O(n)ï¼‰
- **é«˜ç²¾åº¦**: è¿‘ä¼¼ç²¾åº¦ 95% ä»¥ä¸Š
- **ã‚¹ã‚±ãƒ¼ãƒ©ãƒ–ãƒ«**: 100ä¸‡ä»¶ä»¥ä¸Šã®ãƒ™ã‚¯ãƒˆãƒ«ã§ã‚‚é«˜é€Ÿ

---

### ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®ä½œæˆ

**åŸºæœ¬çš„ãªä½œæˆ**:
```sql
CREATE INDEX idx_ticket_embeddings_combined_hnsw
  ON ticket_embeddings
  USING hnsw (combined_vector vector_cosine_ops);
```

**ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ä»˜ãä½œæˆ**:
```sql
CREATE INDEX idx_ticket_embeddings_combined_hnsw
  ON ticket_embeddings
  USING hnsw (combined_vector vector_cosine_ops)
  WITH (m = 16, ef_construction = 64);
```

**ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®èª¬æ˜**:

| ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ | æ¨å¥¨ç¯„å›² | èª¬æ˜ |
|-----------|----------|---------|------|
| `m` | 16 | 16-32 | å„ãƒãƒ¼ãƒ‰ã®æ¥ç¶šæ•°ã€‚å¤§ãã„ã»ã©ç²¾åº¦å‘ä¸Šã€ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚µã‚¤ã‚ºå¢—åŠ  |
| `ef_construction` | 64 | 64-128 | æ§‹ç¯‰æ™‚ã®æ¢ç´¢æ·±ã•ã€‚å¤§ãã„ã»ã©ç²¾åº¦å‘ä¸Šã€æ§‹ç¯‰æ™‚é–“å¢—åŠ  |

**ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°æŒ‡é‡**:
```
å°è¦æ¨¡ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆï¼ˆ< 1,000ä»¶ï¼‰:
  m = 16, ef_construction = 64ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰

ä¸­è¦æ¨¡ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆï¼ˆ1,000-10,000ä»¶ï¼‰:
  m = 24, ef_construction = 100

å¤§è¦æ¨¡ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆï¼ˆ> 10,000ä»¶ï¼‰:
  m = 32, ef_construction = 128
```

---

### æ¤œç´¢æ™‚ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿

**ef_search ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿**:
```sql
-- æ¤œç´¢æ™‚ã®æ¢ç´¢æ·±ã•ã‚’è¨­å®š
SET hnsw.ef_search = 100;

-- æ¤œç´¢å®Ÿè¡Œ
SELECT ... ORDER BY combined_vector <=> $1::vector LIMIT 5;
```

**ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®å½±éŸ¿**:

| ef_search | æ¤œç´¢æ™‚é–“ | ç²¾åº¦ | æ¨å¥¨ç”¨é€” |
|-----------|---------|------|---------|
| 40ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰ | é«˜é€Ÿ | æ¨™æº– | ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ¤œç´¢ |
| 100 | ä¸­é€Ÿ | é«˜ç²¾åº¦ | é‡è¦ãªæ¤œç´¢ |
| 200 | ä½é€Ÿ | æœ€é«˜ç²¾åº¦ | ãƒãƒƒãƒå‡¦ç† |

---

### ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹

**VACUUM ã®å®Ÿè¡Œ**:
```sql
-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’æœ€é©åŒ–ï¼ˆæœˆæ¬¡å®Ÿè¡Œæ¨å¥¨ï¼‰
VACUUM ANALYZE ticket_embeddings;
```

**ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®å†æ§‹ç¯‰**:
```sql
-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒæ–­ç‰‡åŒ–ã—ã¦ã„ã‚‹å ´åˆ
REINDEX INDEX idx_ticket_embeddings_combined_hnsw;
```

**çµ±è¨ˆæƒ…å ±ã®æ›´æ–°**:
```sql
-- ãƒ†ãƒ¼ãƒ–ãƒ«çµ±è¨ˆã‚’æ›´æ–°ï¼ˆã‚¯ã‚¨ãƒªãƒ—ãƒ©ãƒ³ãƒŠãƒ¼ã®æœ€é©åŒ–ï¼‰
ANALYZE ticket_embeddings;
```

---

## ãƒãƒƒãƒå‡¦ç†ã®å®Ÿè£…

### æ—¢å­˜ãƒã‚±ãƒƒãƒˆã®ä¸€æ‹¬ãƒ™ã‚¯ãƒˆãƒ«åŒ–

**ã‚¹ã‚¯ãƒªãƒ—ãƒˆ**: `backend/scripts/generate-embeddings-batch.ts`

```typescript
import { query } from '../src/config/database';
import { VectorSearchService } from '../src/services/vector-search.service';

async function generateEmbeddingsBatch() {
  console.log('ğŸš€ æ—¢å­˜ãƒã‚±ãƒƒãƒˆã®åŸ‹ã‚è¾¼ã¿ãƒ™ã‚¯ãƒˆãƒ«ç”Ÿæˆã‚’é–‹å§‹...');

  // 1. åŸ‹ã‚è¾¼ã¿æœªç”Ÿæˆã®ãƒã‚±ãƒƒãƒˆã‚’å–å¾—
  const ticketsResult = await query(`
    SELECT t.ticket_id, t.subject, t.description
    FROM tickets t
    LEFT JOIN ticket_embeddings te
      ON t.ticket_id = te.ticket_id
      AND te.embedding_version = 'claude-sonnet-4-5-20250929'
    WHERE te.embedding_id IS NULL
      AND t.status IN ('resolved', 'closed')
    ORDER BY t.created_at DESC
    LIMIT 100
  `);

  const tickets = ticketsResult.rows;
  console.log(`ğŸ“Š å¯¾è±¡ãƒã‚±ãƒƒãƒˆæ•°: ${tickets.length}ä»¶`);

  // 2. ãƒãƒƒãƒå‡¦ç†ï¼ˆ5ä»¶ãšã¤ã€1ç§’é–“éš”ï¼‰
  const batchSize = 5;
  let processed = 0;

  for (let i = 0; i < tickets.length; i += batchSize) {
    const batch = tickets.slice(i, i + batchSize);

    // ä¸¦åˆ—å‡¦ç†
    await Promise.all(
      batch.map(async (ticket) => {
        try {
          await VectorSearchService.generateAndSaveEmbedding(
            ticket.ticket_id,
            ticket.subject,
            ticket.description
          );
          processed++;
        } catch (error) {
          console.error(`âŒ å¤±æ•— (${ticket.ticket_id}):`, error);
        }
      })
    );

    // é€²æ—è¡¨ç¤º
    console.log(`ğŸ“ˆ é€²æ—: ${processed}/${tickets.length}ä»¶ (${Math.round(processed / tickets.length * 100)}%)`);

    // ãƒ¬ãƒ¼ãƒˆåˆ¶é™å¯¾ç­–: 1ç§’å¾…æ©Ÿ
    if (i + batchSize < tickets.length) {
      await new Promise(resolve => setTimeout(resolve, 1000));
    }
  }

  console.log('âœ… åŸ‹ã‚è¾¼ã¿ãƒ™ã‚¯ãƒˆãƒ«ç”Ÿæˆå®Œäº†');
}

generateEmbeddingsBatch().catch(console.error);
```

**å®Ÿè¡Œ**:
```bash
cd backend
ts-node scripts/generate-embeddings-batch.ts

# å‡ºåŠ›ä¾‹:
# ğŸš€ æ—¢å­˜ãƒã‚±ãƒƒãƒˆã®åŸ‹ã‚è¾¼ã¿ãƒ™ã‚¯ãƒˆãƒ«ç”Ÿæˆã‚’é–‹å§‹...
# ğŸ“Š å¯¾è±¡ãƒã‚±ãƒƒãƒˆæ•°: 100ä»¶
# âœ… åŸ‹ã‚è¾¼ã¿ãƒ™ã‚¯ãƒˆãƒ«ç”Ÿæˆå®Œäº†: ticket-uuid-1
# âœ… åŸ‹ã‚è¾¼ã¿ãƒ™ã‚¯ãƒˆãƒ«ç”Ÿæˆå®Œäº†: ticket-uuid-2
# ...
# ğŸ“ˆ é€²æ—: 100/100ä»¶ (100%)
# âœ… åŸ‹ã‚è¾¼ã¿ãƒ™ã‚¯ãƒˆãƒ«ç”Ÿæˆå®Œäº†
```

---

### Cron ã§å®šæœŸå®Ÿè¡Œ

**crontab è¨­å®š**:
```bash
# æ¯æ—¥ åˆå‰2æ™‚ ã«å®Ÿè¡Œ
0 2 * * * cd /path/to/backend && ts-node scripts/generate-embeddings-batch.ts >> logs/embeddings-batch.log 2>&1
```

---

## ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°

### ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯

**æ¤œç´¢ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ¸¬å®š**:
```sql
-- æ¤œç´¢æ™‚é–“ã‚’æ¸¬å®š
EXPLAIN ANALYZE
SELECT
  t.ticket_id,
  t.subject,
  1 - (te.combined_vector <=> '[0.1, 0.2, ..., 0.3]'::vector) AS similarity_score
FROM ticket_embeddings te
JOIN tickets t ON te.ticket_id = t.ticket_id
WHERE te.embedding_version = 'claude-sonnet-4-5-20250929'
  AND t.status IN ('resolved', 'closed')
ORDER BY te.combined_vector <=> '[0.1, 0.2, ..., 0.3]'::vector
LIMIT 5;

-- æœŸå¾…ã•ã‚Œã‚‹å®Ÿè¡Œæ™‚é–“:
-- 1,000ä»¶: < 50ms
-- 10,000ä»¶: < 200ms
-- 100,000ä»¶: < 500ms
```

---

### ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚µã‚¤ã‚ºã®ç¢ºèª

```sql
-- ãƒ†ãƒ¼ãƒ–ãƒ«ã¨ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®ã‚µã‚¤ã‚ºã‚’ç¢ºèª
SELECT
  pg_size_pretty(pg_total_relation_size('ticket_embeddings')) as total_size,
  pg_size_pretty(pg_relation_size('ticket_embeddings')) as table_size,
  pg_size_pretty(pg_indexes_size('ticket_embeddings')) as indexes_size;

-- æœŸå¾…ã•ã‚Œã‚‹çµæœï¼ˆ10,000ä»¶ã®å ´åˆï¼‰:
-- total_size | table_size | indexes_size
-- -----------+------------+-------------
-- 420 MB     | 80 MB      | 340 MB
```

**æ³¨æ„**: HNSW ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã¯ãƒ†ãƒ¼ãƒ–ãƒ«æœ¬ä½“ã® 3-5å€ ã®ã‚µã‚¤ã‚ºã«ãªã‚Šã¾ã™ã€‚

---

### ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ã®æœ€é©åŒ–

**shared_buffers ã®èª¿æ•´**:
```sql
-- postgresql.conf
shared_buffers = 4GB  -- RAM ã® 25% ç¨‹åº¦

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚­ãƒ£ãƒƒã‚·ãƒ¥
effective_cache_size = 12GB  -- RAM ã® 50-75%
```

**ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ãƒ¡ãƒ¢ãƒª**:
```sql
-- postgresql.conf
maintenance_work_mem = 1GB  -- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æ§‹ç¯‰æ™‚ã®ãƒ¡ãƒ¢ãƒª
```

---

## ãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢ã®ç²¾åº¦è©•ä¾¡

### è©•ä¾¡ãƒ¡ãƒˆãƒªã‚¯ã‚¹

**Recall@K**: ä¸Šä½Kä»¶ã«æ­£è§£ãŒå«ã¾ã‚Œã‚‹å‰²åˆ

```typescript
// scripts/evaluate-vector-search.ts

async function evaluateRecall() {
  // ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆ: é¡ä¼¼ãƒã‚±ãƒƒãƒˆã®ãƒšã‚¢ã‚’ç”¨æ„
  const testPairs = [
    { query_ticket_id: 'uuid-1', expected_similar: ['uuid-2', 'uuid-3'] },
    { query_ticket_id: 'uuid-4', expected_similar: ['uuid-5', 'uuid-6'] },
    // ...
  ];

  let recalls = [];

  for (const pair of testPairs) {
    // æ¤œç´¢å®Ÿè¡Œ
    const results = await VectorSearchService.searchSimilarTickets({
      ticket_id: pair.query_ticket_id,
      limit: 5,
    });

    // ä¸Šä½5ä»¶ã«æœŸå¾…ã•ã‚Œã‚‹ãƒã‚±ãƒƒãƒˆãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹
    const resultIds = results.map(r => r.ticket_id);
    const found = pair.expected_similar.filter(id => resultIds.includes(id)).length;
    const recall = found / pair.expected_similar.length;

    recalls.push(recall);
  }

  const avgRecall = recalls.reduce((sum, r) => sum + r, 0) / recalls.length;
  console.log(`Recall@5: ${(avgRecall * 100).toFixed(2)}%`);

  // ç›®æ¨™: Recall@5 >= 80%
}
```

---

## ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### å•é¡Œ: ãƒ™ã‚¯ãƒˆãƒ«æ¬¡å…ƒã‚¨ãƒ©ãƒ¼

**ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:**
```
ERROR: different vector dimensions 512 and 1024
```

**åŸå› **: åŸ‹ã‚è¾¼ã¿ãƒ™ã‚¯ãƒˆãƒ«ã®æ¬¡å…ƒæ•°ãŒç•°ãªã‚‹

**è§£æ±ºç­–:**
```typescript
// åŸ‹ã‚è¾¼ã¿ç”Ÿæˆæ™‚ã«æ¬¡å…ƒæ•°ã‚’çµ±ä¸€
const embedding = await openai.embeddings.create({
  model: 'text-embedding-3-large',
  input: text,
  dimensions: 1024,  // æ˜ç¤ºçš„ã«æŒ‡å®š
});
```

---

### å•é¡Œ: ãƒ¡ãƒ¢ãƒªä¸è¶³

**ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:**
```
ERROR: out of memory
```

**åŸå› **: å¤§é‡ã®ãƒ™ã‚¯ãƒˆãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ¡ãƒ¢ãƒªã«èª­ã¿è¾¼ã¿

**è§£æ±ºç­–:**
```sql
-- ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ‹ãƒ³ã‚°ã‚’å°å…¥
CREATE TABLE ticket_embeddings (
  ...
) PARTITION BY RANGE (created_at);

CREATE TABLE ticket_embeddings_2025_01 PARTITION OF ticket_embeddings
  FOR VALUES FROM ('2025-01-01') TO ('2025-02-01');

CREATE TABLE ticket_embeddings_2025_02 PARTITION OF ticket_embeddings
  FOR VALUES FROM ('2025-02-01') TO ('2025-03-01');
```

---

## æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

- [08_ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°.md](./08_ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°.md) - ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ã®è©³ç´°

---

**æœ€çµ‚æ›´æ–°:** 2026å¹´2æœˆ
**ãƒãƒ¼ã‚¸ãƒ§ãƒ³:** 1.0.0
