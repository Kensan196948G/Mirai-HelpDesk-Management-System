# 監査レポート出力

## 目次
- [監査レポートとは](#監査レポートとは)
- [監査ログエクスポート](#監査ログエクスポート)
- [月次レポート生成](#月次レポート生成)
- [監査要件](#監査要件)
- [セキュリティとコンプライアンス](#セキュリティとコンプライアンス)

---

## 監査レポートとは

### 目的
- コンプライアンス遵守の証明
- セキュリティ監査への対応
- 内部統制の確認
- 不正操作の検知

### 監査対象
1. **チケット履歴**: すべてのチケット変更
2. **M365実施ログ**: すべてのM365操作
3. **承認履歴**: 承認/却下の記録
4. **ログインログ**: ユーザーアクセス記録
5. **システム変更ログ**: 設定変更の記録

---

## 監査ログエクスポート

### エクスポート可能な形式

| 形式 | 用途 | 推奨シーン |
|-----|------|-----------|
| **CSV** | データ分析 | Excel分析、データ加工 |
| **PDF** | 公式報告書 | 監査提出、アーカイブ |
| **JSON** | システム連携 | SIEM統合、自動分析 |

---

### 1. チケット履歴のエクスポート

#### エクスポート手順

```
1. 管理者画面 > [監査] > [チケット履歴]
2. フィルタ条件を設定:
   - 期間: 2025-01-01 〜 2025-01-31
   - ステータス: すべて
   - 優先度: すべて
3. [エクスポート] ボタン > 形式選択（CSV/PDF/JSON）
4. ファイルダウンロード
```

#### エクスポート内容

```csv
ticket_id,action,actor_id,actor_name,before_value,after_value,created_at,reason
TK-000001,status_change,5,山田太郎,New,Triage,2025-01-20 10:00:00,トリアージ完了
TK-000001,assignment,5,山田太郎,NULL,佐藤次郎,2025-01-20 10:05:00,ネットワーク問題のため
TK-000001,status_change,8,佐藤次郎,Triage,Assigned,2025-01-20 10:10:00,対応開始
TK-000001,priority_change,8,佐藤次郎,P3,P2,2025-01-20 10:15:00,全社影響のため優先度引き上げ
```

---

### 2. M365実施ログのエクスポート

#### エクスポート手順

```
1. 管理者画面 > [監査] > [M365実施ログ]
2. フィルタ条件を設定:
   - 期間: 2025-01-01 〜 2025-01-31
   - 操作種別: すべて
   - 実施者: すべて
3. [エクスポート] ボタン > 形式選択
4. ファイルダウンロード
```

#### エクスポート内容

```csv
log_id,ticket_id,task_id,operator_id,operator_name,task_type,target_upn,method,result,created_at
1,TK-000123,MT-00001,12,田中一郎,license_assignment,tanaka@company.com,Admin Center,success,2025-01-20 14:30:00
2,TK-000124,MT-00002,12,田中一郎,password_reset,suzuki@company.com,PowerShell,success,2025-01-20 15:00:00
3,TK-000125,MT-00003,12,田中一郎,group_membership,sato@company.com,Graph API,success,2025-01-20 15:30:00
```

---

### 3. 承認履歴のエクスポート

#### エクスポート手順

```
1. 管理者画面 > [監査] > [承認履歴]
2. フィルタ条件を設定:
   - 期間: 2025-01-01 〜 2025-01-31
   - ステータス: approved/rejected/pending
   - 承認者: すべて
3. [エクスポート] ボタン > 形式選択
4. ファイルダウンロード
```

#### エクスポート内容

```csv
approval_id,ticket_id,requester_id,requester_name,approver_id,approver_name,requested_at,responded_at,status,reason
1,TK-000123,5,山田太郎,10,鈴木次郎,2025-01-20 10:00:00,2025-01-20 11:00:00,approved,業務上必要と判断
2,TK-000124,6,佐藤三郎,10,鈴木次郎,2025-01-20 12:00:00,2025-01-20 13:00:00,rejected,コスト超過のため却下
3,TK-000125,7,高橋四郎,11,伊藤五郎,2025-01-21 09:00:00,NULL,pending,NULL
```

---

## 月次レポート生成

### 自動生成レポート

システムは毎月1日に自動的に前月のレポートを生成します。

#### 1. 運用サマリーレポート

```markdown
# 運用サマリーレポート - 2025年1月

## チケット統計
- 新規作成: 523件
- 解決: 498件
- クローズ: 476件
- 未解決: 47件

## SLA達成率
- 全体: 95.2%
- P1: 100%
- P2: 96.9%
- P3: 94.7%
- P4: 94.5%

## 平均解決時間
- P1: 1.2時間
- P2: 4.5時間
- P3: 1.8営業日
- P4: 3.2営業日

## トップ5問題
1. Outlook送信エラー: 45件
2. VPN接続不可: 38件
3. パスワードリセット: 32件
4. プリンター印刷不可: 28件
5. Teams音声問題: 22件
```

---

#### 2. セキュリティ監査レポート

```markdown
# セキュリティ監査レポート - 2025年1月

## M365操作統計
- 総操作数: 234件
- ライセンス変更: 45件
- 権限付与: 67件
- パスワードリセット: 89件
- グループ管理: 33件

## SOD（職務分離）遵守状況
- 総承認数: 156件
- SOD遵守: 156件（100%）
- SOD違反: 0件

## 承認統計
- 承認依頼: 156件
- 承認: 142件（91%）
- 却下: 14件（9%）
- 平均承認時間: 2.3時間

## セキュリティイベント
- 不正ログイン試行: 0件
- 権限昇格試行: 0件
- データエクスポート: 12件（すべて正当）
```

---

#### 3. コンプライアンスレポート

```markdown
# コンプライアンスレポート - 2025年1月

## 監査証跡の完全性
- チケット履歴レコード: 3,456件
- M365実施ログ: 234件
- 承認履歴: 156件
- 削除されたレコード: 0件 ✅

## 追記専用ログの検証
- UPDATE試行: 0件 ✅
- DELETE試行: 0件 ✅
- トリガーによる保護: 有効 ✅

## データ保持期間遵守
- 2年以上保持: 全レコード ✅
- 最古のレコード: 2023-01-15

## 承認フロー遵守
- 承認なしのM365操作: 0件 ✅
- SOD違反: 0件 ✅
```

---

### レポート生成手順（手動）

#### 1. カスタムレポート生成

```
1. 管理者画面 > [レポート] > [カスタムレポート]
2. レポート種別を選択:
   □ 運用サマリー
   □ セキュリティ監査
   □ コンプライアンス
   □ M365操作詳細
3. 期間を設定
4. フィルタを設定（オプション）
5. [生成] ボタン
6. レポートがPDF/CSVで出力される
```

---

#### 2. スケジュール設定

定期的なレポート生成をスケジュール設定できます。

```
1. 管理者画面 > [設定] > [レポートスケジュール]
2. [新規スケジュール]
3. 設定:
   - レポート種別: 運用サマリー
   - 頻度: 月次（毎月1日 9:00）
   - 期間: 前月
   - 形式: PDF + CSV
   - 送信先: it-manager@company.com
4. [保存]
```

---

## 監査要件

### 必須監査項目

#### 1. すべての特権操作が記録されているか

```sql
-- M365操作の記録確認
SELECT COUNT(*) as total_m365_operations,
       COUNT(DISTINCT operator_id) as unique_operators,
       MIN(created_at) as oldest_record,
       MAX(created_at) as newest_record
FROM m365_execution_logs
WHERE created_at >= '2025-01-01' AND created_at < '2025-02-01';
```

**期待結果**: すべてのM365操作が記録されている

---

#### 2. SOD（職務分離）が遵守されているか

```sql
-- SOD違反の確認
SELECT a.approval_id, a.ticket_id,
       a.approver_id, m.operator_id
FROM approvals a
JOIN m365_tasks t ON t.ticket_id = a.ticket_id
JOIN m365_execution_logs m ON m.task_id = t.task_id
WHERE a.approver_id = m.operator_id
  AND a.status = 'approved'
  AND m.created_at >= '2025-01-01' AND m.created_at < '2025-02-01';
```

**期待結果**: 0件（違反なし）

---

#### 3. 承認なしのM365操作がないか

```sql
-- 承認なしのM365操作確認
SELECT m.*
FROM m365_execution_logs m
JOIN m365_tasks t ON t.task_id = m.task_id
LEFT JOIN approvals a ON a.ticket_id = t.ticket_id AND a.status = 'approved'
WHERE a.approval_id IS NULL
  AND t.approval_required = TRUE
  AND m.created_at >= '2025-01-01' AND m.created_at < '2025-02-01';
```

**期待結果**: 0件（違反なし）

---

#### 4. 追記専用ログが改ざんされていないか

```sql
-- ticket_historyのUPDATE/DELETE試行確認
-- （トリガーがブロックするため、試行ログはシステムログに記録される）

SELECT *
FROM system_logs
WHERE table_name IN ('ticket_history', 'm365_execution_logs')
  AND operation IN ('UPDATE', 'DELETE')
  AND created_at >= '2025-01-01' AND created_at < '2025-02-01';
```

**期待結果**: 0件（改ざん試行なし）

---

### 監査チェックリスト

```
【月次監査チェックリスト - 2025年1月】

□ すべてのM365操作が記録されている
□ SOD違反がない（承認者≠実施者）
□ 承認なしのM365操作がない
□ 追記専用ログの改ざんがない
□ 削除されたレコードがない
□ データ保持期間を遵守している（2年以上）
□ すべての承認に理由が記載されている
□ SLA違反の正当な理由が記録されている
□ ログイン失敗の異常なパターンがない
□ 不正なデータエクスポートがない

監査実施者: [氏名]
監査日: 2025-02-01
監査結果: 合格 / 不合格
所見: [コメント]
```

---

## セキュリティとコンプライアンス

### データ保持ポリシー

#### 保持期間

| データ種別 | 保持期間 | 理由 |
|-----------|---------|------|
| チケット履歴 | 2年 | コンプライアンス要件 |
| M365実施ログ | 2年 | セキュリティ監査 |
| 承認履歴 | 3年 | 内部統制証明 |
| ログインログ | 1年 | セキュリティ監視 |
| 添付ファイル | 2年 | エビデンス保持 |

---

#### データ削除プロセス

保持期間を過ぎたデータは以下のプロセスで削除されます。

```
1. アーカイブ（保持期間終了前）
   - データを読み取り専用ストレージに移動
   - 検索可能な状態で保持

2. 削除（保持期間終了後）
   - マネージャー承認を取得
   - 削除ログを記録
   - 安全な削除（復元不可）

3. 削除証明書発行
   - 削除完了の記録
   - 監査用証明書
```

---

### アクセス制限

監査レポートへのアクセスは厳格に制限されています。

| 役割 | アクセス権限 |
|-----|-----------|
| **Manager** | 全レポート閲覧・エクスポート |
| **Auditor** | 全レポート閲覧のみ（エクスポート不可）|
| **Agent** | 自分の操作ログのみ閲覧 |
| **その他** | アクセス不可 |

---

### エクスポートログ

すべてのレポートエクスポートは記録されます。

```csv
export_id,user_id,user_name,report_type,period_from,period_to,format,exported_at
1,10,鈴木次郎,m365_execution_log,2025-01-01,2025-01-31,CSV,2025-02-01 09:00:00
2,15,伊藤五郎,ticket_history,2025-01-01,2025-01-31,PDF,2025-02-01 10:00:00
```

---

### PIIデータの取り扱い

#### 個人情報の保護

レポートに含まれる個人情報（PII）の取り扱い:

```
【マスキング対象】
- パスワード（一時パスワード含む）: 完全マスキング
- メールアドレス: 外部エクスポート時にマスキング
- 電話番号: 外部エクスポート時にマスキング

【マスキング例】
元データ: tanaka@company.com
マスキング: t****a@company.com

元データ: 03-1234-5678
マスキング: 03-****-****
```

---

## レポート配布

### 定期配布スケジュール

| レポート | 配布先 | 頻度 | 形式 |
|---------|--------|------|------|
| 運用サマリー | IT部門全員 | 月次 | PDF |
| セキュリティ監査 | IT部門長 + セキュリティチーム | 月次 | PDF + CSV |
| コンプライアンス | IT部門長 + 監査部門 | 月次 | PDF |
| 経営層レポート | 経営層 | 四半期 | PDF |

---

### レポート保管

生成されたレポートは以下の場所に保管されます。

```
保管場所: \\fileserver\audit_reports\
├── 2025/
│   ├── 01_January/
│   │   ├── 運用サマリー_2025-01.pdf
│   │   ├── セキュリティ監査_2025-01.pdf
│   │   ├── コンプライアンス_2025-01.pdf
│   │   └── エクスポートログ_2025-01.csv
│   └── 02_February/
└── 2024/
    └── ...

アクセス権限: Manager, Auditor のみ
バックアップ: 毎日実行
保持期間: 3年
```

---

## トラブルシューティング

### レポート生成エラー

#### エラー1: データが多すぎてタイムアウト

**解決方法**:
```
期間を短く設定してください。
例: 1ヶ月 → 1週間ずつ
```

#### エラー2: エクスポート権限がない

**解決方法**:
```
Manager または Auditor ロールが必要です。
システム管理者に権限付与を依頼してください。
```

---

## 関連ドキュメント

- [M365操作マニュアル](./M365操作マニュアル.md)
- [承認フローガイド](./承認フローガイド.md)
- [運用マニュアル](./運用マニュアル.md)

---

**最終更新日**: 2025年1月20日
**バージョン**: 1.0
