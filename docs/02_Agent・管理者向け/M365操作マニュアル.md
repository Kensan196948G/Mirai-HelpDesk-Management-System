# M365操作マニュアル

## 目次
- [はじめに](#はじめに)
- [M365操作の基本原則](#m365操作の基本原則)
- [承認フロー](#承認フロー)
- [実施ログ記録方法](#実施ログ記録方法)
- [操作別手順](#操作別手順)
- [トラブルシューティング](#トラブルシューティング)

---

## はじめに

このマニュアルは、M365 Operatorがチケットに基づいてMicrosoft 365の操作を実施する際の手順を説明します。

### 重要な原則

⚠️ **すべてのM365操作には承認と実施ログが必須です**

1. **承認なしの操作禁止**: すべての特権操作には事前承認が必要
2. **SOD（職務分離）遵守**: 承認者 ≠ 実施者
3. **完全な監査証跡**: 誰が・いつ・何を・どのように実施したか記録
4. **エビデンス必須**: スクリーンショットまたはコマンド出力を添付

---

## M365操作の基本原則

### 操作の3ステップ

```
ステップ1: 承認確認
    ↓
ステップ2: 操作実施
    ↓
ステップ3: 実施ログ記録
```

### 実施前チェックリスト

```
□ チケットに承認済みのapprovalレコードがあるか
□ 承認者が自分と異なるか（SODチェック）
□ 操作内容が承認された内容と一致しているか
□ 対象ユーザー/リソースが正しいか
□ バックアップ/ロールバック手順を確認したか
```

---

## 承認フロー

### 承認が必要な操作

| 操作種別 | 承認者 | 理由 |
|---------|--------|------|
| ライセンス追加/変更 | Manager/Approver | コスト発生 |
| 特権的な権限付与 | Manager | セキュリティリスク |
| グローバル管理者権限 | IT部門長 | 最高権限 |
| 全社設定変更 | Manager/Approver | 全社影響 |
| データ削除/復元 | Manager/Approver | データ保護 |

### 承認依頼方法

#### 1. チケット詳細画面から「承認依頼」をクリック

#### 2. 承認依頼内容を記載

```
【操作内容】
ユーザー「tanaka@company.com」にMicrosoft 365 E5ライセンスを付与

【理由】
営業部への異動に伴い、Teamsの高度な機能が必要

【影響】
- 月額コスト: +3,000円
- 既存ライセンス（E3）からのアップグレード

【実施予定日】
2025-01-21

【ロールバック手順】
E5ライセンスを削除し、E3に戻す
```

#### 3. 承認者を選択

- システムが推奨する承認者を表示
- SODチェック: 自分自身は選択不可

#### 4. 承認待ち

- 承認者にメール通知が送信される
- ステータスが「Pending Approval」に変更される
- 承認/却下されるまで待機

---

## 実施ログ記録方法

### 実施ログの必須項目

すべてのM365操作後、必ず実施ログを記録します。

| 項目 | 説明 | 必須 |
|-----|------|------|
| **操作内容** | 何を実施したか | ✅ |
| **対象** | 誰に/何に対して | ✅ |
| **実施方法** | 管理センター/PowerShell/Graph API | ✅ |
| **実施日時** | いつ実施したか | ✅（自動記録）|
| **結果** | 成功/失敗 | ✅ |
| **エビデンス** | スクリーンショットまたはコマンド出力 | ✅ |
| **ロールバック手順** | 元に戻す方法 | ✅（変更操作の場合）|

### 実施ログ記録手順

#### 方法1: システム内で記録（推奨）

1. チケット詳細画面から「M365タスク」タブを開く
2. 該当タスクの「実施ログ追加」をクリック
3. 必須項目を入力

```
【実施内容】
Microsoft 365 E5ライセンスを付与

【対象】
ユーザー: tanaka@company.com (田中太郎)

【実施方法】
Microsoft 365 管理センター > ユーザー > ライセンスとアプリ

【結果】
成功

【詳細】
- 既存ライセンス: Microsoft 365 E3
- 変更後ライセンス: Microsoft 365 E5
- 実施日時: 2025-01-21 10:30

【エビデンス】
[スクリーンショット添付]

【ロールバック手順】
1. Microsoft 365 管理センター > ユーザー
2. 田中太郎を選択
3. ライセンスとアプリ > E5のチェックを外す
4. E3にチェック > 変更を保存
```

4. スクリーンショットを添付
5. 「保存」をクリック

---

## 操作別手順

### 1. ライセンス管理

#### ライセンス付与

**承認**: 必要

**手順**:
```
1. Microsoft 365 管理センター (https://admin.microsoft.com) にアクセス
2. [ユーザー] > [アクティブなユーザー]
3. 対象ユーザーを選択
4. [ライセンスとアプリ] タブをクリック
5. 付与するライセンスにチェック
6. [変更を保存] をクリック
7. スクリーンショットを撮影
```

**エビデンス**:
- ライセンス割り当て前の画面
- ライセンス割り当て後の画面

**ロールバック**:
```
同じ手順でライセンスのチェックを外す
```

---

#### ライセンス削除

**承認**: 必要

**PowerShell例**:
```powershell
# 接続
Connect-MgGraph -Scopes "User.ReadWrite.All", "Organization.Read.All"

# ライセンスSKU IDを確認
Get-MgSubscribedSku | Select SkuPartNumber, SkuId

# ユーザーのライセンスを確認
Get-MgUserLicenseDetail -UserId "tanaka@company.com"

# ライセンスを削除
Set-MgUserLicense -UserId "tanaka@company.com" `
    -RemoveLicenses @("SkuId") `
    -AddLicenses @{}

# 確認
Get-MgUserLicenseDetail -UserId "tanaka@company.com"
```

---

### 2. パスワードリセット

**承認**: 不要（標準操作）

**手順**:
```
1. Microsoft 365 管理センター > [ユーザー] > [アクティブなユーザー]
2. 対象ユーザーを選択
3. [パスワードのリセット] をクリック
4. 以下を選択:
   □ パスワードを自動生成する
   ☑ 初回サインイン時にパスワードを変更する必要がある
5. [リセット] をクリック
6. 一時パスワードをメモ（安全に扱う）
7. スクリーンショット撮影
```

**実施ログ**:
```
【実施内容】
パスワードリセットを実施

【対象】
tanaka@company.com

【実施方法】
Microsoft 365 管理センター

【結果】
成功

【一時パスワード】
[セキュアな方法で依頼者に通知済み]

【エビデンス】
[スクリーンショット添付]
```

---

### 3. グループメンバーシップ管理

#### 配布リスト（Distribution List）への追加

**承認**: 必要（一部のグループ）

**PowerShell例**:
```powershell
# Exchange Online接続
Connect-ExchangeOnline

# 配布リストにメンバー追加
Add-DistributionGroupMember `
    -Identity "sales@company.com" `
    -Member "tanaka@company.com"

# 確認
Get-DistributionGroupMember -Identity "sales@company.com"
```

---

#### Microsoft 365グループ（Teamsグループ）への追加

**承認**: 必要（一部のグループ）

**手順**:
```
1. Microsoft 365 管理センター > [チーム & グループ] > [アクティブなチーム & グループ]
2. 対象グループを選択
3. [メンバー] タブ > [メンバーの表示と管理]
4. [メンバーの追加]
5. 対象ユーザーを検索して選択
6. [保存] > [閉じる]
7. スクリーンショット撮影
```

---

### 4. メールボックス権限管理

#### フルアクセス権限付与

**承認**: 必須（機密性の高い操作）

**PowerShell例**:
```powershell
# Exchange Online接続
Connect-ExchangeOnline

# フルアクセス権限付与
Add-MailboxPermission `
    -Identity "boss@company.com" `
    -User "assistant@company.com" `
    -AccessRights FullAccess `
    -InheritanceType All

# 確認
Get-MailboxPermission -Identity "boss@company.com" |
    Where-Object {$_.User -like "*assistant*"}
```

**実施ログ**:
```
【実施内容】
メールボックスのフルアクセス権限を付与

【対象】
メールボックス: boss@company.com
権限付与先: assistant@company.com

【実施方法】
PowerShell (Exchange Online)

【コマンド】
Add-MailboxPermission -Identity "boss@company.com" ...

【結果】
成功

【エビデンス】
[コマンド出力のスクリーンショット]

【ロールバック手順】
Remove-MailboxPermission -Identity "boss@company.com"
    -User "assistant@company.com" -AccessRights FullAccess
```

---

### 5. Teams管理

#### Teamsチーム作成

**承認**: 必要（一部の場合）

**PowerShell例**:
```powershell
# Teams PowerShellモジュール接続
Connect-MicrosoftTeams

# 新しいTeamsチーム作成
New-Team `
    -DisplayName "営業部プロジェクトA" `
    -Description "プロジェクトAの営業チーム" `
    -Visibility Private

# 所有者追加
Add-TeamUser `
    -GroupId <TeamId> `
    -User "tanaka@company.com" `
    -Role Owner
```

---

#### Teams所有者変更

**承認**: 必要

**手順**:
```
1. Teams管理センター (https://admin.teams.microsoft.com)
2. [チーム] > [チームを管理]
3. 対象チームを検索
4. [メンバー] タブ
5. ユーザーの役割を「所有者」に変更
6. スクリーンショット撮影
```

---

### 6. OneDrive管理

#### OneDrive共有リンクの無効化

**承認**: 必要（セキュリティ関連）

**PowerShell例**:
```powershell
# SharePoint Online接続
Connect-SPOService -Url https://company-admin.sharepoint.com

# ユーザーのOneDrive URLを取得
$oneDriveUrl = "https://company-my.sharepoint.com/personal/tanaka_company_com"

# すべての共有リンクを取得
Get-SPOSite -Identity $oneDriveUrl |
    Get-SPOSiteExternalUserInvitations

# 特定の共有リンクを削除
Remove-SPOSiteExternalUserInvitations -Identity $oneDriveUrl -EmailAddress external@example.com
```

---

### 7. 退職者処理

**承認**: 必須（複数の操作を含む）

**チェックリスト**:
```
□ メールボックスを共有メールボックスに変換
□ 上長へのメール転送設定
□ ライセンス削除
□ グループメンバーシップ削除
□ サインインのブロック
□ OneDriveアクセス権の引き継ぎ設定
□ Teamsチームからの削除
```

**PowerShell例（サインインブロック）**:
```powershell
# サインインをブロック
Update-MgUser -UserId "retired@company.com" -AccountEnabled:$false

# 確認
Get-MgUser -UserId "retired@company.com" |
    Select DisplayName, AccountEnabled
```

---

## トラブルシューティング

### よくある問題と解決方法

#### 問題1: 「権限がありません」エラー

**原因**: 必要な管理者権限がない

**解決方法**:
```
1. 自分のロールを確認
2. 必要な権限:
   - グローバル管理者
   - ユーザー管理者
   - Exchange管理者（メール関連）
   - Teams管理者（Teams関連）
3. 権限不足の場合、マネージャーにエスカレーション
```

---

#### 問題2: PowerShell接続エラー

**原因**: モジュール未インストールまたは認証失敗

**解決方法**:
```powershell
# Microsoft Graphモジュール
Install-Module Microsoft.Graph -Scope CurrentUser
Connect-MgGraph

# Exchange Onlineモジュール
Install-Module ExchangeOnlineManagement
Connect-ExchangeOnline

# Teamsモジュール
Install-Module MicrosoftTeams
Connect-MicrosoftTeams
```

---

#### 問題3: ライセンス不足エラー

**原因**: 利用可能なライセンスがない

**解決方法**:
```
1. ライセンス在庫を確認
   Microsoft 365 管理センター > [課金] > [ライセンス]

2. 不足している場合:
   - 未使用ライセンスを探す
   - 追加購入の承認を取得
   - 代替ライセンスを検討
```

---

## エビデンス撮影のベストプラクティス

### スクリーンショットに含めるべき情報

1. **日時**: システムクロックが見える
2. **対象**: ユーザー名、リソース名
3. **操作前の状態**
4. **操作後の状態**
5. **成功メッセージ**

### 例: ライセンス付与のエビデンス

```
【操作前】
- 画面: Microsoft 365 管理センター > ユーザー > ライセンス
- 表示内容: ライセンス割り当てなし
- ファイル名: before_license_tanaka_20250120.png

【操作後】
- 画面: Microsoft 365 管理センター > ユーザー > ライセンス
- 表示内容: Microsoft 365 E5が割り当てられている
- ファイル名: after_license_tanaka_20250120.png
```

---

## 実施ログ記録テンプレート

### テンプレート

```markdown
## M365実施ログ

**チケット番号**: TK-XXXXXX
**タスクID**: MT-XXXXXX
**実施者**: [あなたの名前]
**実施日時**: YYYY-MM-DD HH:MM

### 実施内容
[何を実施したか簡潔に]

### 対象
- ユーザー: [UPN]
- リソース: [リソース名]

### 実施方法
□ Microsoft 365 管理センター
□ Exchange管理センター
□ Teams管理センター
□ PowerShell
□ Graph API

### 実施詳細
[具体的な手順]

### コマンド（PowerShellの場合）
\`\`\`powershell
[実行したコマンド]
\`\`\`

### 結果
□ 成功
□ 失敗

### 出力結果
[コマンド出力またはメッセージ]

### エビデンス
- 添付ファイル1: [ファイル名]
- 添付ファイル2: [ファイル名]

### ロールバック手順
[元に戻す方法]

### 備考
[その他の注意事項]
```

---

## セキュリティとコンプライアンス

### 重要事項

1. **最小権限の原則**
   - 必要最小限の権限のみを使用
   - 作業完了後は特権セッションを終了

2. **パスワード管理**
   - 一時パスワードは安全に扱う
   - パスワードをチケットに平文で記載しない
   - セキュアな方法（電話、Teams DMなど）で通知

3. **多要素認証（MFA）**
   - M365操作時は必ずMFAを使用
   - 共有アカウントは使用しない

4. **監査ログ**
   - すべての操作は監査ログに記録される
   - 不正な操作は検知される

---

## 関連ドキュメント

- [承認フローガイド](./承認フローガイド.md)
- [トリアージガイド](./トリアージガイド.md)
- [監査レポート出力](./監査レポート出力.md)

---

**最終更新日**: 2025年1月20日
**バージョン**: 1.0
