# マルチAIオーケストレーション 仕様書

**作成日**: 2026-01-25
**バージョン**: 1.0.0
**対象システム**: Mirai HelpDesk Management System

---

## 📖 概要

マルチAIオーケストレーションは、**情報システム担当者の業務効率化と24時間対応可能なITサポート体制の構築**を目的とした、複数のAIモデルを戦略的に組み合わせるアーキテクチャです。

### 目的
- 24時間対応可能なITサポート体制の構築
- 情報システム担当者の業務効率化
- 高品質で根拠のあるトラブルシューティング提供
- ナレッジベースの自動生成・更新

---

## 🏗️ 設計原則

### 1. クロスプラットフォーム対応
- **Ubuntu Linux**: サーバー環境での運用
- **Windows 11**: デスクトップ環境での利用
- **CLI中心設計**: GUI依存なし、自動化可能

### 2. APIモデル選択
- **Claude**: Anthropic Claude API
- **Gemini**: Google Gemini API
- **Perplexity**: Perplexity AI API

### 3. 役割分担モデル
- **Claude**: 一次判断、最終統合、定型回答
- **Gemini**: 情報収集、調査、技術文書整理
- **Perplexity**: Web検索、最新情報取得、参照元提供

### 4. 根拠分離
- 回答本文とエビデンスを明確に分離
- 監査証跡として参照元URLを保持
- トレーサビリティの確保

---

## 🎯 AI役割分担詳細

### Claude（一次判断・最終統合）

**役割**:
- クエリの一次判断とルーティング
- 最終回答の統合と品質保証
- 定型的な回答の生成
- JSON構造化出力

**得意分野**:
- 自然言語理解
- 文脈把握
- 複数情報の統合
- 高品質な文章生成

**使用場面**:
- すべてのクエリの入口（一次判断）
- FAQ回答の生成
- 複数AIからの情報統合
- 最終回答の品質チェック

### Gemini（情報収集・調査）

**役割**:
- 技術情報の収集・整理
- 複数ソースからのデータ統合
- 調査型クエリの処理
- 多言語対応

**得意分野**:
- 大量情報の処理
- 技術文書の理解
- データ整理・分類
- 多言語翻訳

**使用場面**:
- 技術調査が必要な問い合わせ
- 複数の技術文書から情報抽出
- トラブルシューティング手順の生成

### Perplexity（根拠・エビデンス収集）

**役割**:
- Web検索による最新情報取得
- 参照元URLの提供
- エビデンスの収集
- リアルタイム情報の取得

**得意分野**:
- Web検索
- 最新情報の取得
- 信頼性の高い情報源の特定
- 参照元の明示

**使用場面**:
- 公式ドキュメントの参照が必要な場合
- 最新のトラブルシューティング情報
- 根拠となるURLが必要な場合

---

## 🔄 システムアーキテクチャ

### 処理フロー図

```
┌─────────────────────────────────────────┐
│         ユーザー問い合わせ                │
└─────────────────┬───────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────┐
│      Claude 一次判断                     │
│      - FAQ / 調査 / 根拠 に分類          │
└─────────────────┬───────────────────────┘
                  │
          ┌───────┼───────┐
          │       │       │
          ▼       ▼       ▼
    ┌─────┐ ┌─────┐ ┌─────────┐
    │ FAQ │ │調査 │ │  根拠   │
    │     │ │     │ │         │
    │Claude│ │Gemini│ │Perplexity│
    └──┬──┘ └──┬──┘ └────┬────┘
       │       │         │
       └───────┼─────────┘
               │
               ▼
    ┌──────────────────────┐
    │   Claude 最終統合     │
    │   - 品質チェック      │
    │   - 回答生成          │
    │   - 根拠分離          │
    └──────────┬───────────┘
               │
               ▼
    ┌──────────────────────┐
    │      回答出力         │
    │  ┌─────────────────┐ │
    │  │  回答本文         │ │
    │  └─────────────────┘ │
    │  ┌─────────────────┐ │
    │  │  参照元URL       │ │
    │  │  エビデンス      │ │
    │  └─────────────────┘ │
    └──────────────────────┘
```

### データフロー

```
Input: ユーザークエリ
  ↓
[Claude] クエリ分類
  ↓
  ├─ FAQ         → [Claude]      定型回答生成
  ├─ 調査        → [Gemini]      情報収集・整理
  └─ 根拠        → [Perplexity]  Web検索・参照元取得
  ↓
[Claude] 最終統合
  ↓
Output:
  - 回答本文（技術者向け、一般ユーザー向け）
  - 参照元URL
  - エビデンス
  - 品質スコア
```

---

## 🎨 実装パターン

### パターン1: FAQ処理

```
User Query: "パスワードをリセットする方法は？"
    ↓
[Claude 一次判断]
    ↓ FAQ判定
[Claude] 定型回答生成
    ↓
Output:
  - パスワードリセット手順
  - 社内ポータルURL
  - IT部門連絡先
```

### パターン2: 調査処理

```
User Query: "Outlookのメール送信が遅い原因を調査してください"
    ↓
[Claude 一次判断]
    ↓ 調査判定
[Gemini] 技術情報収集
    ↓
  - SMTP設定確認方法
  - ネットワーク診断手順
  - ログファイル確認方法
    ↓
[Claude] 統合・構造化
    ↓
Output:
  - 調査手順（技術者向け）
  - 一時対処法（ユーザー向け）
  - 参考ドキュメント
```

### パターン3: 根拠処理

```
User Query: "VPN接続の公式設定手順を教えてください"
    ↓
[Claude 一次判断]
    ↓ 根拠判定
[Perplexity] Web検索・参照元取得
    ↓
  - 公式ドキュメントURL
  - ベンダーサポートページ
  - 最新の設定ガイド
    ↓
[Claude] 統合・要約
    ↓
Output:
  - 設定手順（要約）
  - 公式ドキュメントURL（複数）
  - 補足情報
```

---

## 💾 キャッシュ戦略

### キャッシュ設計

| クエリタイプ | TTL（有効期限） | 理由 |
|-------------|----------------|------|
| **FAQ** | 24時間 | 定型的な回答は変化が少ない |
| **調査** | 1時間 | 技術情報は更新される可能性 |
| **根拠** | 2時間 | 参照元URLは比較的安定 |
| **一般** | 1時間 | デフォルト設定 |

### キャッシュキー生成

```
キャッシュキー = hash(クエリテキスト + クエリタイプ + 選択AI)
```

### キャッシュ無効化条件

- TTL期限切れ
- 手動でのキャッシュクリア
- ナレッジベース更新時
- システム設定変更時

---

## 🔐 セキュリティ・品質保証

### 1. SOD原則適用

**承認フロー**:
- AIによる自動回答 → レビュー担当者による確認
- ナレッジ自動生成 → 品質保証担当者による承認

### 2. 監査証跡

**記録内容**:
- 使用したAIモデル
- クエリ内容
- 生成された回答
- 参照元URL
- 処理時間
- 品質スコア

### 3. 品質保証

**品質スコア計算**:
- 完全性（Completeness）: 回答が質問に完全に答えているか
- 正確性（Accuracy）: 技術的に正確か
- 関連性（Relevance）: 質問に関連しているか
- 総合品質（Overall）: 上記3つの平均

**閾値**:
- 品質スコア < 70%: 人手レビュー必須
- 品質スコア 70-85%: 推奨レビュー
- 品質スコア > 85%: 自動承認可能

---

## 📊 パフォーマンス目標

### レスポンスタイム

| 処理タイプ | 目標時間 | 最大時間 |
|-----------|---------|---------|
| FAQ | 2秒以内 | 5秒 |
| 調査 | 5秒以内 | 15秒 |
| 根拠 | 3秒以内 | 10秒 |

### スループット

- 同時処理: 最大10クエリ
- 1日あたり: 最大1,000クエリ
- キャッシュヒット率: 目標40%以上

---

## 🔧 実装技術

### Backend API統合

**エンドポイント**:
```
POST /api/ai/query
{
  "query": "問い合わせ内容",
  "type": "faq | investigation | evidence | auto",
  "models": ["claude", "gemini", "perplexity"],
  "user_id": "ユーザーID"
}

Response:
{
  "answer": {
    "summary": "統合回答",
    "technical": "技術者向け詳細",
    "user_friendly": "一般ユーザー向け",
    "preventive_measures": "再発防止策",
    "automation_suggestions": "自動化提案",
    "automation_potential": 75
  },
  "evidence": [
    {
      "title": "参照元タイトル",
      "url": "https://...",
      "source": "perplexity"
    }
  ],
  "quality_score": {
    "overall": 94,
    "completeness": 96,
    "accuracy": 92,
    "relevance": 94
  },
  "processing_time": 2.4,
  "cache_hit": false,
  "models_used": ["claude", "gemini", "perplexity"]
}
```

### データベーススキーマ

**ai_queries テーブル**:
```sql
CREATE TABLE ai_queries (
  query_id TEXT PRIMARY KEY,
  user_id TEXT NOT NULL,
  query_text TEXT NOT NULL,
  query_type TEXT NOT NULL, -- faq, investigation, evidence
  models_used TEXT NOT NULL, -- JSON array
  answer TEXT NOT NULL,
  evidence TEXT, -- JSON array
  quality_score INTEGER,
  processing_time REAL,
  cache_hit INTEGER,
  created_at TEXT NOT NULL,
  FOREIGN KEY (user_id) REFERENCES users(user_id)
);
```

**ai_cache テーブル**:
```sql
CREATE TABLE ai_cache (
  cache_key TEXT PRIMARY KEY,
  query_type TEXT NOT NULL,
  cached_response TEXT NOT NULL,
  quality_score INTEGER,
  created_at TEXT NOT NULL,
  expires_at TEXT NOT NULL
);
```

---

## 📈 品質保証とモニタリング

### メトリクス

**収集項目**:
- 1日あたりのクエリ数
- クエリタイプ別の分布
- 平均処理時間
- 平均品質スコア
- キャッシュヒット率
- エラー率
- ユーザー満足度（役立った/役立たなかった）

### アラート条件

- 品質スコア平均 < 80%（1日）
- エラー率 > 5%（1時間）
- 平均処理時間 > 10秒（1時間）
- API利用量 > 80%（1日）

---

## 🔄 運用フロー

### 1. 問い合わせ受付

```
ユーザー
  ↓ 問い合わせ入力
AIアシスタント（WebUI）
  ↓ POST /api/ai/query
Backend API
  ↓ クエリ分類（Claude）
マルチAI処理
```

### 2. AI処理

```
[Claude 一次判断]
  ↓ クエリタイプ判定
[並列処理]
  ├─ Claude:      FAQ回答生成
  ├─ Gemini:      情報収集
  └─ Perplexity:  根拠収集
  ↓ 結果集約
[Claude 最終統合]
  ↓ 品質チェック
回答生成
```

### 3. 回答提供

```
Backend API
  ↓ レスポンス返却
WebUI
  ↓ 回答表示
  ├─ 統合回答
  ├─ 技術者向け詳細
  ├─ 一般ユーザー向け
  ├─ 再発防止策
  ├─ 自動化提案
  └─ 参照元URL
ユーザー
  ↓ フィードバック（役立った/役立たなかった）
品質改善ループ
```

---

## 📊 ナレッジ自動生成

### 7つのSubAgent

マルチAIオーケストレーションは、**7つのSubAgent**による並列処理で高品質なナレッジを自動生成します。

| SubAgent | 役割 | 処理内容 |
|----------|------|---------|
| **Architect** | 設計整合性チェック | システムアーキテクチャとの整合性確認 |
| **KnowledgeCurator** | タグ・カテゴリ自動分類 | 適切なカテゴリとタグの自動判定 |
| **ITSMExpert** | ITSM原則準拠検証 | Incident/Problem/Change/Request分類 |
| **DevOps** | 技術要素抽出・自動化提案 | 自動化可能性評価、スクリプト化提案 |
| **QA** | 品質保証・重複検知 | 類似ナレッジ検出（85%以上で警告） |
| **Coordinator** | 調整ポイント確認 | 部門間調整の必要性判定 |
| **Documenter** | 要約生成 | 技術者向け・一般ユーザー向け要約 |

### 品質保証Hooks

#### 1. Pre-Task Hook
**実行タイミング**: SubAgent処理開始前
**処理内容**:
- 入力検証
- SubAgent割り当て
- 必要なリソース確認

#### 2. Duplicate-Check Hook
**実行タイミング**: ナレッジ生成時
**処理内容**:
- 既存ナレッジとの類似度計算
- 85%以上で警告表示
- 重複登録防止

#### 3. Deviation-Check Hook
**実行タイミング**: ITSM分類後
**処理内容**:
- ITSM原則からの逸脱検知
- ITILベストプラクティスチェック
- コンプライアンス確認

#### 4. Post-Task Hook
**実行タイミング**: 全SubAgent完了後
**処理内容**:
- 統合レビュー
- 総合品質評価（0-100%）
- 最終検証

---

## 🎯 ユースケース

### ケース1: 緊急障害対応

**シナリオ**: 全社メールサーバーダウン

```
1. ユーザーがAIアシスタントに問い合わせ
   「メールが送受信できません」

2. Claude一次判断 → 調査タイプと判定

3. Gemini並列処理
   - Exchange Serverのステータス確認方法
   - 一般的なメールサーバー障害の診断手順
   - 過去の類似障害事例

4. Perplexity並列処理
   - Microsoft公式トラブルシューティング
   - 最新の既知の問題
   - コミュニティフォーラムの情報

5. Claude最終統合
   - 技術者向け: サーバーログ確認、サービス再起動手順
   - ユーザー向け: 代替手段（Webmail使用）
   - エスカレーション基準

6. 回答提供（処理時間: 約5秒）
   - 品質スコア: 92%
   - 参照元: 5件
```

### ケース2: 日常的な問い合わせ

**シナリオ**: WiFi接続トラブル

```
1. クイックトピック「WiFi接続」選択

2. Claude一次判断 → FAQタイプと判定
   （キャッシュヒット: 過去24時間以内に同じクエリあり）

3. キャッシュから回答取得（処理時間: 0.1秒）

4. 回答提供
   - WiFi接続トラブルシューティング手順
   - 社内WiFi設定情報
   - IT部門連絡先
```

### ケース3: ナレッジ自動生成

**シナリオ**: VPN接続手順のナレッジ作成

```
1. 管理者が「VPN接続」に関するナレッジ自動生成をリクエスト

2. Pre-Task Hook
   - 入力検証OK
   - 7つのSubAgentを割り当て

3. SubAgent並列処理（各0.8-1.5秒）
   - Architect: システム設計との整合性OK
   - KnowledgeCurator: カテゴリ「ネットワーク」、タグ「VPN,接続,リモートワーク」
   - ITSMExpert: Request分類、標準的な手順
   - DevOps: 自動化可能性60%、接続スクリプト化推奨
   - QA: 類似ナレッジ検出（類似度67%、警告なし）、品質スコア92%
   - Coordinator: 部門間調整不要
   - Documenter: 技術者向け・一般ユーザー向け要約生成

4. Duplicate-Check Hook
   - 類似ナレッジなし（最高類似度67% < 85%）

5. Deviation-Check Hook
   - ITSM原則逸脱なし

6. Perplexity: 公式ドキュメント収集
   - FortiClient公式ガイド
   - Microsoft認証ガイド
   - 社内VPN設定マニュアル

7. Claude最終統合
   - 全SubAgentの結果を統合
   - 構造化されたナレッジ生成

8. Post-Task Hook
   - 総合品質評価: 92%
   - 承認推奨

9. ナレッジ保存
   - 自動タグ付け
   - カテゴリ分類
   - AI生成フラグ
   - 品質スコア記録

処理時間: 約4秒
```

---

## 🎓 期待効果

### 業務効率化

- **24時間対応**: 夜間・休日も自動回答
- **回答時間短縮**: 平均5分 → 2秒
- **ナレッジ蓄積**: 自動生成で継続的に拡充
- **担当者負荷軽減**: 定型的な問い合わせを自動化

### 品質向上

- **一貫性**: AI回答の品質が安定
- **根拠明示**: 参照元URL常に提供
- **多角的**: 複数AIによる包括的な回答
- **継続改善**: フィードバックループ

### コスト削減

- **人件費**: 定型業務の自動化
- **研修コスト**: AIが最新情報を提供
- **エスカレーション削減**: 自己解決率向上

---

## 📚 参照

- **Mirai IT Knowledge System**: https://github.com/Kensan196948G/Mirai-IT-Knowledge-System
- **Claude API**: https://docs.anthropic.com/
- **Gemini API**: https://ai.google.dev/
- **Perplexity API**: https://docs.perplexity.ai/

---

**作成者**: Claude Opus 4.5
**作成日**: 2026-01-25
**承認**: 正式仕様書として採用
