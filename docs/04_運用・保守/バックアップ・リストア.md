# バックアップ・リストア

## バックアップ戦略

### RPO/RTO

- **RPO（Recovery Point Objective）**: 24時間
- **RTO（Recovery Time Objective）**: 4時間

### バックアップ種別

| 種別 | 頻度 | 保持期間 | 方法 |
|-----|------|---------|------|
| **フルバックアップ** | 日次（深夜2:00） | 30日 | pg_dump |
| **増分バックアップ** | 6時間ごと | 7日 | WALアーカイブ |
| **添付ファイル** | 日次 | 90日 | rsync |

## PostgreSQLバックアップ

### フルバックアップ

```bash
#!/bin/bash
# /opt/backup/scripts/backup_database.sh

DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="/opt/backup/database"
DB_NAME="mirai_helpdesk"

# フルバックアップ
pg_dump -U postgres -F c -b -v -f "${BACKUP_DIR}/mirai_helpdesk_${DATE}.backup" ${DB_NAME}

# 圧縮
gzip "${BACKUP_DIR}/mirai_helpdesk_${DATE}.backup"

# 30日以上古いバックアップを削除
find ${BACKUP_DIR} -name "*.backup.gz" -mtime +30 -delete

echo "Backup completed: mirai_helpdesk_${DATE}.backup.gz"
```

### バックアップスケジュール

```bash
# crontabに追加
crontab -e

# 毎日深夜2時にバックアップ
0 2 * * * /opt/backup/scripts/backup_database.sh >> /var/log/backup.log 2>&1
```

## リストア手順

### データベースリストア

```bash
#!/bin/bash
# 最新のバックアップからリストア

# 1. バックアップファイルを確認
ls -lh /opt/backup/database/*.backup.gz

# 2. リストアするバックアップを選択
BACKUP_FILE="/opt/backup/database/mirai_helpdesk_20250120_020000.backup.gz"

# 3. 解凍
gunzip -c ${BACKUP_FILE} > /tmp/restore.backup

# 4. 既存データベースを削除（注意！）
dropdb -U postgres mirai_helpdesk

# 5. 新規データベース作成
createdb -U postgres mirai_helpdesk

# 6. リストア実行
pg_restore -U postgres -d mirai_helpdesk -v /tmp/restore.backup

# 7. 確認
psql -U postgres -d mirai_helpdesk -c "SELECT COUNT(*) FROM tickets;"

# 8. 一時ファイル削除
rm /tmp/restore.backup
```

### 添付ファイルバックアップ

```bash
#!/bin/bash
# /opt/backup/scripts/backup_attachments.sh

DATE=$(date +%Y%m%d)
SOURCE="/var/app/helpdesk/uploads"
DEST="/opt/backup/attachments/uploads_${DATE}"

# rsyncでバックアップ
rsync -av --delete ${SOURCE}/ ${DEST}/

# 90日以上古いバックアップを削除
find /opt/backup/attachments -name "uploads_*" -mtime +90 -exec rm -rf {} \;

echo "Attachments backup completed: ${DEST}"
```

## 災害復旧（DR）

### DR手順

```
1. 新しいサーバーを準備
2. PostgreSQLインストール
3. アプリケーションコードをデプロイ
4. データベースをリストア
5. 添付ファイルをリストア
6. 環境変数を設定
7. アプリケーション起動
8. 動作確認
```

### DR訓練

年に2回、DR訓練を実施してください。

```
訓練日: 第2・第4 土曜日
時間: 10:00-12:00
参加者: システム管理者、マネージャー
```

## バックアップ監視

### バックアップ失敗通知

```bash
# /opt/backup/scripts/backup_database.sh に追加

if [ $? -eq 0 ]; then
    echo "Backup successful" | mail -s "[SUCCESS] Helpdesk Backup" admin@company.com
else
    echo "Backup FAILED" | mail -s "[ALERT] Helpdesk Backup FAILED" admin@company.com
fi
```

## 関連ドキュメント

- [トラブルシューティング](./トラブルシューティング.md)
- [パフォーマンスチューニング](./パフォーマンスチューニング.md)
