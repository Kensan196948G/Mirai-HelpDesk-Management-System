# トラブルシューティング

> **Note**: 詳細なトラブルシューティングは `/Enterprise-IT-Helpdesk-AI/docs/runbook-troubleshooting.md` も参照してください。

## よくある問題と解決方法

### 1. アプリケーションが起動しない

#### 症状
```bash
npm run dev
Error: Cannot find module 'express'
```

#### 原因
依存パッケージが未インストール

#### 解決方法
```bash
cd backend
npm install

cd ../frontend
npm install
```

---

### 2. データベース接続エラー

#### 症状
```
Error: connect ECONNREFUSED 127.0.0.1:5432
```

#### 確認事項
```bash
# PostgreSQLが起動しているか確認
sudo systemctl status postgresql

# 接続テスト
psql -U postgres -d mirai_helpdesk

# 接続設定確認
echo $DATABASE_URL
```

#### 解決方法
```bash
# PostgreSQL起動
sudo systemctl start postgresql

# .envファイルの確認
cat backend/.env | grep DATABASE
```

---

### 3. ポート競合エラー

#### 症状
```
Error: listen EADDRINUSE: address already in use :::3000
```

#### 確認
```bash
# ポート使用状況確認
lsof -i :3000
netstat -tulpn | grep 3000
```

#### 解決方法
```bash
# 既存プロセスを停止
kill -9 <PID>

# または別のポートを使用
# backend/.env
PORT=3001
```

---

### 4. M365 API エラー

#### 症状
```
Error: AADSTS7000215: Invalid client secret
```

#### 確認事項
```bash
# 環境変数確認
echo $AZURE_TENANT_ID
echo $AZURE_CLIENT_ID
echo $AZURE_CLIENT_SECRET
```

#### 解決方法
1. Azure Portalで新しいシークレットを作成
2. `.env`ファイルを更新
3. アプリケーションを再起動

---

### 5. 添付ファイルアップロードエラー

#### 症状
```
Error: ENOENT: no such file or directory, open '/uploads/...'
```

#### 確認事項
```bash
# uploadsディレクトリが存在するか
ls -ld uploads/

# 権限確認
ls -l uploads/
```

#### 解決方法
```bash
# ディレクトリ作成
mkdir -p uploads
chmod 755 uploads
```

---

### 6. メモリ不足エラー

#### 症状
```
FATAL ERROR: Ineffective mark-compacts near heap limit
```

#### 確認
```bash
# メモリ使用状況
free -h
ps aux --sort=-%mem | head
```

#### 解決方法
```bash
# Node.jsのヒープサイズを増やす
# package.json
"scripts": {
  "start": "node --max-old-space-size=4096 src/index.js"
}
```

---

### 7. SLA期限が正しく計算されない

#### 症状
SLA期限が予想と異なる

#### 確認
```sql
-- チケットのSLA設定確認
SELECT t.ticket_id, t.priority, t.created_at, t.due_at,
       s.priority as sla_priority,
       s.response_time_minutes, s.resolution_time_minutes
FROM tickets t
JOIN sla_policies s ON t.sla_policy_id = s.sla_policy_id
WHERE t.ticket_id = 123;
```

#### 解決方法
```sql
-- SLAポリシーを確認・修正
UPDATE sla_policies
SET response_time_minutes = 15,
    resolution_time_minutes = 120
WHERE priority = 'P1';
```

---

## ログ確認

### アプリケーションログ

```bash
# 最新のエラーログ
tail -f /var/log/helpdesk/error.log

# 特定のエラーを検索
grep "Error" /var/log/helpdesk/app.log
```

### データベースログ

```bash
# PostgreSQLログ
tail -f /var/log/postgresql/postgresql-14-main.log
```

### システムログ

```bash
# systemdログ
journalctl -u helpdesk -f
```

---

## デバッグモード

### バックエンド

```bash
# .env
LOG_LEVEL=debug
NODE_ENV=development

# 再起動
npm run dev
```

### フロントエンド

```javascript
// ブラウザコンソールでデバッグ
localStorage.setItem('debug', 'helpdesk:*');
```

---

## パフォーマンス問題

### 遅いクエリの特定

```sql
-- スロークエリログ有効化
ALTER SYSTEM SET log_min_duration_statement = 1000; -- 1秒以上
SELECT pg_reload_conf();

-- スロークエリ確認
grep "duration:" /var/log/postgresql/postgresql-14-main.log
```

### インデックスの確認

```sql
-- 欠落インデックスの検出
SELECT schemaname, tablename, attname, n_distinct, correlation
FROM pg_stats
WHERE schemaname = 'public'
  AND tablename = 'tickets';
```

---

## エスカレーション

以下の場合、システム管理者にエスカレーション:

```
□ データベース破損
□ セキュリティインシデント
□ 複数サービスの同時障害
□ 外部ベンダー対応が必要
□ 原因不明の障害
```

---

## 緊急連絡先

| 役割 | 名前 | 連絡先 | 対応範囲 |
|-----|------|--------|---------|
| システム管理者 | 田中一郎 | 090-XXXX-XXXX | 全般 |
| DBアドミニストレーター | 鈴木二郎 | 090-XXXX-XXXX | データベース |
| ネットワーク管理者 | 佐藤三郎 | 090-XXXX-XXXX | ネットワーク |

---

## 関連ドキュメント

- [バックアップ・リストア](./バックアップ・リストア.md)
- [パフォーマンスチューニング](./パフォーマンスチューニング.md)
- [ログローテーション](./ログローテーション.md)
