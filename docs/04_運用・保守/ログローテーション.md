# ログローテーション

## ログ種別

| ログ種別 | パス | サイズ | 保持期間 |
|---------|------|--------|---------|
| アプリケーションログ | `/var/log/helpdesk/app.log` | 100MB | 30日 |
| アクセスログ | `/var/log/helpdesk/access.log` | 100MB | 30日 |
| エラーログ | `/var/log/helpdesk/error.log` | 50MB | 90日 |
| 監査ログ | `/var/log/helpdesk/audit.log` | 500MB | 2年 |

## logrotate設定

### 設定ファイル

```bash
# /etc/logrotate.d/helpdesk

/var/log/helpdesk/app.log {
    daily
    rotate 30
    compress
    delaycompress
    missingok
    notifempty
    create 0640 helpdesk helpdesk
    postrotate
        systemctl reload helpdesk
    endscript
}

/var/log/helpdesk/access.log {
    daily
    rotate 30
    compress
    delaycompress
    missingok
    notifempty
    create 0640 helpdesk helpdesk
}

/var/log/helpdesk/error.log {
    daily
    rotate 90
    compress
    delaycompress
    missingok
    notifempty
    create 0640 helpdesk helpdesk
}

/var/log/helpdesk/audit.log {
    monthly
    rotate 24
    compress
    delaycompress
    missingok
    notifempty
    create 0640 helpdesk helpdesk
    # 監査ログは削除せず、アーカイブに移動
    postrotate
        mv /var/log/helpdesk/audit.log.1.gz /archive/audit/
    endscript
}
```

### 手動実行

```bash
# テスト実行（実際には実行しない）
logrotate -d /etc/logrotate.d/helpdesk

# 強制実行
logrotate -f /etc/logrotate.d/helpdesk
```

## アプリケーション側設定

### Winston（Node.js）

```javascript
// backend/src/utils/logger.js
const winston = require('winston');
const path = require('path');

const logger = winston.createLogger({
  level: process.env.LOG_LEVEL || 'info',
  format: winston.format.combine(
    winston.format.timestamp(),
    winston.format.json()
  ),
  transports: [
    new winston.transports.File({
      filename: '/var/log/helpdesk/error.log',
      level: 'error',
      maxsize: 52428800, // 50MB
      maxFiles: 5
    }),
    new winston.transports.File({
      filename: '/var/log/helpdesk/app.log',
      maxsize: 104857600, // 100MB
      maxFiles: 30
    })
  ]
});

module.exports = logger;
```

## ログ監視

### リアルタイム監視

```bash
# エラーログを監視
tail -f /var/log/helpdesk/error.log

# アプリケーションログをフィルタ
tail -f /var/log/helpdesk/app.log | grep ERROR
```

### ログ分析

```bash
# エラー件数をカウント
grep ERROR /var/log/helpdesk/app.log | wc -l

# 日付別エラー集計
awk '/ERROR/ {print $1}' /var/log/helpdesk/app.log | uniq -c
```

## 関連ドキュメント

- [トラブルシューティング](./トラブルシューティング.md)
- [バックアップ・リストア](./バックアップ・リストア.md)
