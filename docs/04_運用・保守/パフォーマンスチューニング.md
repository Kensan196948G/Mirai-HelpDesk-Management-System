# パフォーマンスチューニング

## パフォーマンス目標

- **レスポンスタイム**: 平均 < 200ms
- **同時接続**: 100ユーザー
- **スループット**: 1000リクエスト/分

## データベースチューニング

### インデックス最適化

```sql
-- よく使われる検索条件にインデックスを作成
CREATE INDEX CONCURRENTLY idx_tickets_status ON tickets(status);
CREATE INDEX CONCURRENTLY idx_tickets_priority ON tickets(priority);
CREATE INDEX CONCURRENTLY idx_tickets_assignee ON tickets(assignee_id);
CREATE INDEX CONCURRENTLY idx_tickets_created ON tickets(created_at DESC);

-- 複合インデックス
CREATE INDEX CONCURRENTLY idx_tickets_status_priority
ON tickets(status, priority);

-- 不要なインデックスの削除
DROP INDEX IF EXISTS idx_old_index;
```

### クエリ最適化

```sql
-- EXPLAIN ANALYZE でクエリプランを確認
EXPLAIN ANALYZE
SELECT * FROM tickets
WHERE status = 'new'
  AND priority = 'P1'
ORDER BY created_at DESC
LIMIT 20;

-- 結果に基づいて最適化
-- 例: N+1問題を解決
SELECT t.*, u.display_name as assignee_name
FROM tickets t
LEFT JOIN users u ON t.assignee_id = u.user_id
WHERE t.status = 'new';
```

### 接続プール設定

```javascript
// backend/src/config/database.js
const { Pool } = require('pg');

const pool = new Pool({
  max: 20, // 最大接続数
  idleTimeoutMillis: 30000,
  connectionTimeoutMillis: 2000,
});

module.exports = pool;
```

### PostgreSQL設定

```ini
# /etc/postgresql/14/main/postgresql.conf

# メモリ設定
shared_buffers = 256MB
effective_cache_size = 1GB
work_mem = 16MB
maintenance_work_mem = 64MB

# 接続設定
max_connections = 100

# ロギング
log_min_duration_statement = 1000  # 1秒以上のクエリをログ
```

## アプリケーションチューニング

### キャッシング

```javascript
// Redis キャッシュ
const redis = require('redis');
const client = redis.createClient();

// ユーザー情報をキャッシュ
async function getUserCached(userId) {
  const cached = await client.get(`user:${userId}`);
  if (cached) {
    return JSON.parse(cached);
  }

  const user = await db.query('SELECT * FROM users WHERE user_id = $1', [userId]);
  await client.setex(`user:${userId}`, 3600, JSON.stringify(user.rows[0]));

  return user.rows[0];
}
```

### レスポンス圧縮

```javascript
const compression = require('compression');
app.use(compression());
```

### 静的ファイルキャッシュ

```javascript
app.use(express.static('public', {
  maxAge: '1d',
  etag: true
}));
```

## フロントエンドチューニング

### React最適化

```javascript
// メモ化
import { useMemo, useCallback } from 'react';

const TicketList = ({ tickets }) => {
  const sortedTickets = useMemo(() => {
    return tickets.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
  }, [tickets]);

  return <div>{/* ... */}</div>;
};
```

### コード分割

```javascript
// React.lazy で動的インポート
const TicketDetail = React.lazy(() => import('./pages/TicketDetail'));

<Suspense fallback={<Loading />}>
  <TicketDetail />
</Suspense>
```

### 画像最適化

```javascript
// 遅延ローディング
<img src={url} loading="lazy" alt="Attachment" />
```

## 監視とモニタリング

### アプリケーションメトリクス

```javascript
// Prometheus メトリクス
const promClient = require('prom-client');
const register = new promClient.Registry();

const httpRequestDuration = new promClient.Histogram({
  name: 'http_request_duration_seconds',
  help: 'Duration of HTTP requests in seconds',
  labelNames: ['method', 'route', 'status_code']
});

register.registerMetric(httpRequestDuration);
```

### データベースメトリクス

```sql
-- アクティブな接続数
SELECT count(*) FROM pg_stat_activity;

-- スロークエリ
SELECT query, mean_exec_time, calls
FROM pg_stat_statements
ORDER BY mean_exec_time DESC
LIMIT 10;

-- テーブルサイズ
SELECT schemaname, tablename,
       pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS size
FROM pg_tables
WHERE schemaname = 'public'
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;
```

## ロードテスト

### Apache Bench

```bash
# 100リクエスト、同時接続10
ab -n 100 -c 10 http://localhost:3000/api/tickets
```

### k6

```javascript
// load-test.js
import http from 'k6/http';
import { check } from 'k6';

export let options = {
  stages: [
    { duration: '30s', target: 10 },
    { duration: '1m', target: 50 },
    { duration: '30s', target: 0 },
  ],
};

export default function () {
  let response = http.get('http://localhost:3000/api/tickets');
  check(response, {
    'status is 200': (r) => r.status === 200,
    'response time < 200ms': (r) => r.timings.duration < 200,
  });
}
```

```bash
k6 run load-test.js
```

## チューニングチェックリスト

```
□ 適切なインデックスが作成されている
□ N+1クエリ問題が解決されている
□ 接続プールが適切に設定されている
□ キャッシュが有効化されている
□ レスポンス圧縮が有効
□ フロントエンドでコード分割を使用
□ 画像が最適化されている
□ モニタリングが設定されている
□ ロードテストを実施している
```

## 関連ドキュメント

- [トラブルシューティング](./トラブルシューティング.md)
- [バックアップ・リストア](./バックアップ・リストア.md)
