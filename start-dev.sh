#!/usr/bin/env bash

# ============================================================================
# Mirai HelpDesk Management System - é–‹ç™ºç’°å¢ƒåŒæ™‚èµ·å‹•ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
# ============================================================================
#
# ç”¨é€”: ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ï¼ˆExpressï¼‰ã¨ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ï¼ˆViteï¼‰ã‚’åŒæ™‚ã«èµ·å‹•
#
# ä½¿ã„æ–¹:
#   ./start-dev.sh
#
# åœæ­¢æ–¹æ³•:
#   Ctrl+C
#
# ============================================================================

set -e  # ã‚¨ãƒ©ãƒ¼æ™‚ã«å³åº§ã«çµ‚äº†

# è‰²ä»˜ããƒ­ã‚°
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

log_info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

log_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

log_warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
PROJECT_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
BACKEND_DIR="$PROJECT_ROOT/backend"
FRONTEND_DIR="$PROJECT_ROOT/frontend"

log_info "Mirai HelpDesk Management System - é–‹ç™ºç’°å¢ƒèµ·å‹•"
log_info "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆ: $PROJECT_ROOT"

# ============================================================================
# äº‹å‰ãƒã‚§ãƒƒã‚¯
# ============================================================================

log_info "äº‹å‰ãƒã‚§ãƒƒã‚¯ä¸­..."

# Node.js ã®ç¢ºèª
if ! command -v node &> /dev/null; then
    log_error "Node.js ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã›ã‚“"
    exit 1
fi

log_success "Node.js: $(node --version)"

# npm ã®ç¢ºèª
if ! command -v npm &> /dev/null; then
    log_error "npm ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã›ã‚“"
    exit 1
fi

log_success "npm: $(npm --version)"

# Redis ã®ç¢ºèª
if ! command -v redis-cli &> /dev/null; then
    log_warn "Redis ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã›ã‚“ï¼ˆAIæ©Ÿèƒ½ãŒåˆ¶é™ã•ã‚Œã¾ã™ï¼‰"
else
    if redis-cli ping &> /dev/null; then
        log_success "Redis: èµ·å‹•ä¸­"
    else
        log_warn "Redis: åœæ­¢ä¸­ï¼ˆAIæ©Ÿèƒ½ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒç„¡åŠ¹ã«ãªã‚Šã¾ã™ï¼‰"
    fi
fi

# PostgreSQL ã®ç¢ºèª
if ! command -v psql &> /dev/null; then
    log_warn "PostgreSQL ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã›ã‚“"
else
    if sudo -u postgres psql -d mirai_helpdesk -c "SELECT 1;" &> /dev/null; then
        log_success "PostgreSQL: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ mirai_helpdesk æŽ¥ç¶šå¯èƒ½"
    else
        log_warn "PostgreSQL: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ mirai_helpdesk ã«æŽ¥ç¶šã§ãã¾ã›ã‚“"
    fi
fi

# ============================================================================
# ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆå¿…è¦ãªå ´åˆï¼‰
# ============================================================================

# ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰
if [ ! -d "$BACKEND_DIR/node_modules" ]; then
    log_info "ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰: ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­..."
    cd "$BACKEND_DIR"
    npm install
    log_success "ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰: ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å®Œäº†"
else
    log_info "ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰: ä¾å­˜é–¢ä¿‚ã¯æ—¢ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿"
fi

# ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰
if [ ! -d "$FRONTEND_DIR/node_modules" ]; then
    log_info "ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰: ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­..."
    cd "$FRONTEND_DIR"
    npm install
    log_success "ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰: ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å®Œäº†"
else
    log_info "ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰: ä¾å­˜é–¢ä¿‚ã¯æ—¢ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿"
fi

# ============================================================================
# .env ãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
# ============================================================================

if [ ! -f "$BACKEND_DIR/.env" ]; then
    log_warn "backend/.env ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚.env.example ã‹ã‚‰ã‚³ãƒ”ãƒ¼ã—ã¾ã™..."
    cp "$BACKEND_DIR/.env.example" "$BACKEND_DIR/.env"
    log_warn "backend/.env ã‚’ç·¨é›†ã—ã¦ã€å¿…è¦ãªç’°å¢ƒå¤‰æ•°ã‚’è¨­å®šã—ã¦ãã ã•ã„"
fi

# ============================================================================
# ãƒ—ãƒ­ã‚»ã‚¹IDãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
# ============================================================================

rm -f "$BACKEND_DIR/backend.pid" "$FRONTEND_DIR/frontend.pid"

# ============================================================================
# ã‚µãƒ¼ãƒãƒ¼èµ·å‹•
# ============================================================================

log_info "ã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ä¸­..."

# ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰èµ·å‹•ï¼ˆãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ï¼‰
cd "$BACKEND_DIR"
log_info "ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰èµ·å‹•ä¸­ï¼ˆhttp://localhost:3000ï¼‰..."
npm run dev > "$PROJECT_ROOT/logs/backend-dev.log" 2>&1 &
BACKEND_PID=$!
echo $BACKEND_PID > backend.pid
log_success "ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰èµ·å‹•: PID=$BACKEND_PID"

# ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®èµ·å‹•ã‚’å¾…æ©Ÿ
sleep 5

# ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰èµ·å‹•ï¼ˆãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ï¼‰
cd "$FRONTEND_DIR"
log_info "ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰èµ·å‹•ä¸­ï¼ˆhttp://localhost:5173ï¼‰..."
npm run dev > "$PROJECT_ROOT/logs/frontend-dev.log" 2>&1 &
FRONTEND_PID=$!
echo $FRONTEND_PID > frontend.pid
log_success "ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰èµ·å‹•: PID=$FRONTEND_PID"

# ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®èµ·å‹•ã‚’å¾…æ©Ÿ
sleep 3

# ============================================================================
# èµ·å‹•ç¢ºèª
# ============================================================================

log_info "èµ·å‹•ç¢ºèªä¸­..."

# ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
if curl -f http://localhost:3000/health &> /dev/null; then
    log_success "ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰: æ­£å¸¸ã«èµ·å‹•ã—ã¾ã—ãŸï¼ˆhttp://localhost:3000ï¼‰"
else
    log_warn "ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰: ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å¤±æ•—ï¼ˆèµ·å‹•ä¸­ã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ï¼‰"
fi

# ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
if curl -f http://localhost:5173 &> /dev/null; then
    log_success "ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰: æ­£å¸¸ã«èµ·å‹•ã—ã¾ã—ãŸï¼ˆhttp://localhost:5173ï¼‰"
else
    log_warn "ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰: ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å¤±æ•—ï¼ˆèµ·å‹•ä¸­ã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ï¼‰"
fi

# ============================================================================
# æƒ…å ±è¡¨ç¤º
# ============================================================================

echo ""
echo "============================================================================"
echo -e "${GREEN}âœ… Mirai HelpDesk Management System ãŒèµ·å‹•ã—ã¾ã—ãŸ${NC}"
echo "============================================================================"
echo ""
echo -e "${BLUE}ðŸ“¡ ã‚¢ã‚¯ã‚»ã‚¹URL:${NC}"
echo "  - ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰: http://localhost:5173"
echo "  - ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰API: http://localhost:3000"
echo "  - API ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯: http://localhost:3000/health"
echo ""
echo -e "${BLUE}ðŸ“‹ ãƒ—ãƒ­ã‚»ã‚¹ID:${NC}"
echo "  - ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ PID: $BACKEND_PID"
echo "  - ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ PID: $FRONTEND_PID"
echo ""
echo -e "${BLUE}ðŸ“ ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«:${NC}"
echo "  - ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰: $PROJECT_ROOT/logs/backend-dev.log"
echo "  - ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰: $PROJECT_ROOT/logs/frontend-dev.log"
echo ""
echo -e "${YELLOW}âš ï¸  åœæ­¢æ–¹æ³•:${NC}"
echo "  Ctrl+C ã‚’æŠ¼ã™ã‹ã€ä»¥ä¸‹ã®ã‚³ãƒžãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„:"
echo "  ./stop-dev.sh"
echo ""
echo "============================================================================"
echo ""

# ============================================================================
# ã‚·ã‚°ãƒŠãƒ«ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ï¼ˆCtrl+C ã§ä¸¡æ–¹ã®ãƒ—ãƒ­ã‚»ã‚¹ã‚’åœæ­¢ï¼‰
# ============================================================================

cleanup() {
    echo ""
    log_info "ã‚µãƒ¼ãƒãƒ¼ã‚’åœæ­¢ä¸­..."

    # ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰åœæ­¢
    if [ -n "$BACKEND_PID" ] && kill -0 $BACKEND_PID 2>/dev/null; then
        log_info "ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚’åœæ­¢ä¸­ï¼ˆPID: $BACKEND_PIDï¼‰..."
        kill -TERM $BACKEND_PID 2>/dev/null || true
        wait $BACKEND_PID 2>/dev/null || true
        log_success "ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰åœæ­¢å®Œäº†"
    fi

    # ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰åœæ­¢
    if [ -n "$FRONTEND_PID" ] && kill -0 $FRONTEND_PID 2>/dev/null; then
        log_info "ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚’åœæ­¢ä¸­ï¼ˆPID: $FRONTEND_PIDï¼‰..."
        kill -TERM $FRONTEND_PID 2>/dev/null || true
        wait $FRONTEND_PID 2>/dev/null || true
        log_success "ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰åœæ­¢å®Œäº†"
    fi

    # PIDãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
    rm -f "$BACKEND_DIR/backend.pid" "$FRONTEND_DIR/frontend.pid"

    log_success "ã™ã¹ã¦ã®ã‚µãƒ¼ãƒãƒ¼ã‚’åœæ­¢ã—ã¾ã—ãŸ"
    exit 0
}

trap cleanup SIGINT SIGTERM

# ============================================================================
# ãƒ­ã‚°ã®è¡¨ç¤ºï¼ˆãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ï¼‰
# ============================================================================

log_info "ãƒ­ã‚°ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¡¨ç¤ºä¸­... (Ctrl+C ã§åœæ­¢)"
echo ""

# ä¸¡æ–¹ã®ãƒ­ã‚°ã‚’tailã§è¡¨ç¤º
tail -f "$PROJECT_ROOT/logs/backend-dev.log" "$PROJECT_ROOT/logs/frontend-dev.log" &
TAIL_PID=$!

# waitã§å¾…æ©Ÿï¼ˆãƒ—ãƒ­ã‚»ã‚¹ãŒçµ‚äº†ã™ã‚‹ã¾ã§ï¼‰
wait $BACKEND_PID $FRONTEND_PID 2>/dev/null || cleanup
