name: ğŸ”„ ç¶™ç¶šçš„ç›£è¦–ãƒ»ç„¡é™ãƒ«ãƒ¼ãƒ—ã‚·ã‚¹ãƒ†ãƒ 

on:
  # å®šæœŸå®Ÿè¡Œï¼ˆ5åˆ†ã”ã¨ï¼‰
  schedule:
    - cron: '*/5 * * * *'

  # æ‰‹å‹•å®Ÿè¡Œ
  workflow_dispatch:

  # ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Œäº†å¾Œã«è‡ªå‹•å†å®Ÿè¡Œ
  workflow_run:
    workflows: ["ğŸ¤– è‡ªå‹•ã‚¨ãƒ©ãƒ¼æ¤œçŸ¥ãƒ»ä¿®å¾©ã‚·ã‚¹ãƒ†ãƒ "]
    types:
      - completed

jobs:
  continuous-monitor:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: ğŸ” æœªè§£æ±ºIssueç¢ºèª
        id: check-issues
        uses: actions/github-script@v7
        with:
          script: |
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'auto-detected,needs-fix'
            });

            console.log(`ğŸ” æœªè§£æ±ºã‚¨ãƒ©ãƒ¼: ${issues.data.length}ä»¶`);
            core.setOutput('has_open_issues', issues.data.length > 0);
            core.setOutput('issue_count', issues.data.length);

            return issues.data.length;

      - name: â° å¾…æ©Ÿã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ç¢ºèª
        id: check-wait
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            // æœ€å¾Œã®å®Ÿè¡Œæ™‚åˆ»ã‚’ç¢ºèª
            const runs = await github.rest.actions.listWorkflowRuns({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'auto-error-detection.yml',
              per_page: 1
            });

            if (runs.data.workflow_runs.length === 0) {
              core.setOutput('should_trigger', 'true');
              return;
            }

            const lastRun = runs.data.workflow_runs[0];
            const lastRunTime = new Date(lastRun.created_at);
            const now = new Date();
            const minutesSinceLastRun = (now - lastRunTime) / 1000 / 60;

            console.log(`â° æœ€çµ‚å®Ÿè¡Œ: ${minutesSinceLastRun.toFixed(1)}åˆ†å‰`);

            // 30åˆ†çµŒéã—ã¦ã„ã‚Œã°å†å®Ÿè¡Œ
            const shouldTrigger = minutesSinceLastRun >= 30;
            core.setOutput('should_trigger', shouldTrigger);

      - name: ğŸš€ ã‚¨ãƒ©ãƒ¼æ¤œçŸ¥ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’ãƒˆãƒªã‚¬ãƒ¼
        if: |
          steps.check-issues.outputs.has_open_issues == 'true' &&
          steps.check-wait.outputs.should_trigger == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'auto-error-detection.yml',
              ref: 'main'
            });

            console.log('ğŸš€ ã‚¨ãƒ©ãƒ¼æ¤œçŸ¥ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’èµ·å‹•ã—ã¾ã—ãŸ');

      - name: ğŸ“Š ç›£è¦–çµ±è¨ˆè¡¨ç¤º
        run: |
          echo "ğŸ“Š ç¶™ç¶šçš„ç›£è¦–ã‚·ã‚¹ãƒ†ãƒ çµ±è¨ˆ"
          echo "  - æœªè§£æ±ºIssue: ${{ steps.check-issues.outputs.issue_count }}ä»¶"
          echo "  - æ¬¡å›å®Ÿè¡Œåˆ¤å®š: ${{ steps.check-wait.outputs.should_trigger }}"
          echo "  - å®Ÿè¡Œæ—¥æ™‚: $(date)"
          echo "  - ã‚·ã‚¹ãƒ†ãƒ : æ­£å¸¸ç¨¼åƒä¸­ âœ…"
