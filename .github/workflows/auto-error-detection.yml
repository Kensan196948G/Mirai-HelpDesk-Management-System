name: ğŸ¤– è‡ªå‹•ã‚¨ãƒ©ãƒ¼æ¤œçŸ¥ãƒ»ä¿®å¾©ã‚·ã‚¹ãƒ†ãƒ 

on:
  # å®šæœŸå®Ÿè¡Œï¼ˆæ¯æ™‚ï¼‰
  schedule:
    - cron: '0 * * * *'

  # æ‰‹å‹•å®Ÿè¡Œ
  workflow_dispatch:
    inputs:
      max_iterations:
        description: 'æœ€å¤§å®Ÿè¡Œå›æ•°ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 15ï¼‰'
        required: false
        default: '15'
      sleep_minutes:
        description: '15å›å®Ÿè¡Œå¾Œã®å¾…æ©Ÿæ™‚é–“ï¼ˆåˆ†ï¼‰'
        required: false
        default: '30'

  # Issueã‹ã‚‰ã®ãƒˆãƒªã‚¬ãƒ¼
  issues:
    types: [opened, labeled]

env:
  MAX_ITERATIONS: ${{ github.event.inputs.max_iterations || 15 }}
  SLEEP_MINUTES: ${{ github.event.inputs.sleep_minutes || 30 }}
  NODE_VERSION: '18'

jobs:
  detect-and-fix:
    runs-on: ubuntu-latest
    timeout-minutes: 120

    steps:
      - name: ğŸ“¥ ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ”§ Node.js ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: |
            backend/package-lock.json
            frontend/package-lock.json

      - name: ğŸ“¦ ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          cd backend
          npm ci

      - name: ğŸ“¦ ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          cd frontend
          npm ci

      - name: ğŸ” TypeScriptã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯ï¼ˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ï¼‰
        id: check-backend
        continue-on-error: true
        run: |
          cd backend
          npm run build 2>&1 | tee ../build-backend.log
          echo "status=$?" >> $GITHUB_OUTPUT

      - name: ğŸ” TypeScriptã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯ï¼ˆãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ï¼‰
        id: check-frontend
        continue-on-error: true
        run: |
          cd frontend
          npm run build 2>&1 | tee ../build-frontend.log
          echo "status=$?" >> $GITHUB_OUTPUT

      - name: ğŸ§ª ãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ï¼‰
        id: test-backend
        continue-on-error: true
        run: |
          cd backend
          npm test 2>&1 | tee ../test-backend.log || true
          echo "status=$?" >> $GITHUB_OUTPUT

      - name: ğŸ§ª ãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ï¼‰
        id: test-frontend
        continue-on-error: true
        run: |
          cd frontend
          npm test 2>&1 | tee ../test-frontend.log || true
          echo "status=$?" >> $GITHUB_OUTPUT

      - name: ğŸ“Š ã‚¨ãƒ©ãƒ¼è§£æ
        id: analyze-errors
        run: |
          echo "=== ã‚¨ãƒ©ãƒ¼è§£æ ===" > error-summary.txt

          # ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ“ãƒ«ãƒ‰ã‚¨ãƒ©ãƒ¼
          if [ "${{ steps.check-backend.outputs.status }}" != "0" ]; then
            echo "âŒ ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ“ãƒ«ãƒ‰ã‚¨ãƒ©ãƒ¼æ¤œå‡º" >> error-summary.txt
            echo "backend_build_error=true" >> $GITHUB_OUTPUT
            grep -A 5 "error TS" build-backend.log >> error-summary.txt || true
          else
            echo "âœ… ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ“ãƒ«ãƒ‰: OK" >> error-summary.txt
            echo "backend_build_error=false" >> $GITHUB_OUTPUT
          fi

          # ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ“ãƒ«ãƒ‰ã‚¨ãƒ©ãƒ¼
          if [ "${{ steps.check-frontend.outputs.status }}" != "0" ]; then
            echo "âŒ ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ“ãƒ«ãƒ‰ã‚¨ãƒ©ãƒ¼æ¤œå‡º" >> error-summary.txt
            echo "frontend_build_error=true" >> $GITHUB_OUTPUT
            grep -A 5 "error" build-frontend.log >> error-summary.txt || true
          else
            echo "âœ… ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ“ãƒ«ãƒ‰: OK" >> error-summary.txt
            echo "frontend_build_error=false" >> $GITHUB_OUTPUT
          fi

          # ã‚¨ãƒ©ãƒ¼ã®æœ‰ç„¡ã‚’åˆ¤å®š
          if [ "${{ steps.check-backend.outputs.status }}" != "0" ] || [ "${{ steps.check-frontend.outputs.status }}" != "0" ]; then
            echo "has_errors=true" >> $GITHUB_OUTPUT
          else
            echo "has_errors=false" >> $GITHUB_OUTPUT
          fi

          cat error-summary.txt

      - name: ğŸ› Issueä½œæˆï¼ˆã‚¨ãƒ©ãƒ¼æ¤œå‡ºæ™‚ï¼‰
        if: steps.analyze-errors.outputs.has_errors == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const errorSummary = fs.readFileSync('error-summary.txt', 'utf8');
            const backendLog = fs.existsSync('build-backend.log') ? fs.readFileSync('build-backend.log', 'utf8') : '';
            const frontendLog = fs.existsSync('build-frontend.log') ? fs.readFileSync('build-frontend.log', 'utf8') : '';

            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸ¤– è‡ªå‹•æ¤œçŸ¥: ãƒ“ãƒ«ãƒ‰ã‚¨ãƒ©ãƒ¼ (${new Date().toISOString()})`,
              labels: ['auto-detected', 'bug', 'needs-fix'],
              body: `## ğŸ” è‡ªå‹•ã‚¨ãƒ©ãƒ¼æ¤œçŸ¥ãƒ¬ãƒãƒ¼ãƒˆ

            **æ¤œçŸ¥æ—¥æ™‚:** ${new Date().toISOString()}
            **ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼:** ${context.workflow}
            **å®Ÿè¡ŒID:** ${context.runId}

            ### ğŸ“Š ã‚¨ãƒ©ãƒ¼ã‚µãƒãƒªãƒ¼

            \`\`\`
            ${errorSummary}
            \`\`\`

            ### ğŸ”§ ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ“ãƒ«ãƒ‰ãƒ­ã‚°

            <details>
            <summary>ã‚¯ãƒªãƒƒã‚¯ã—ã¦è¡¨ç¤º</summary>

            \`\`\`
            ${backendLog.slice(-2000)}
            \`\`\`

            </details>

            ### ğŸ¨ ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ“ãƒ«ãƒ‰ãƒ­ã‚°

            <details>
            <summary>ã‚¯ãƒªãƒƒã‚¯ã—ã¦è¡¨ç¤º</summary>

            \`\`\`
            ${frontendLog.slice(-2000)}
            \`\`\`

            </details>

            ---

            **è‡ªå‹•ä¿®å¾©ã‚’è©¦è¡Œã—ã¾ã™...**
            `
            });

            core.setOutput('issue_number', issue.data.number);

      - name: ğŸ”„ è‡ªå‹•ä¿®å¾©ãƒ«ãƒ¼ãƒ—ï¼ˆæœ€å¤§15å›ï¼‰
        if: steps.analyze-errors.outputs.has_errors == 'true'
        id: auto-fix-loop
        run: |
          ITERATION=1
          MAX_ITERATIONS=${{ env.MAX_ITERATIONS }}
          FIXED=false

          while [ $ITERATION -le $MAX_ITERATIONS ] && [ "$FIXED" = "false" ]; do
            echo "ğŸ”„ ä¿®å¾©è©¦è¡Œ $ITERATION / $MAX_ITERATIONS"

            # ESLintã¨Prettierã§è‡ªå‹•ä¿®æ­£
            echo "ğŸ”§ ESLintè‡ªå‹•ä¿®æ­£ã‚’å®Ÿè¡Œ..."
            cd backend && npm run lint:fix || true
            cd ../frontend && npm run lint:fix || true
            cd ..

            echo "ğŸ¨ Prettierè‡ªå‹•ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ..."
            cd backend && npm run format || true
            cd ../frontend && npm run format || true
            cd ..

            # å†ãƒ“ãƒ«ãƒ‰ã—ã¦ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯
            echo "ğŸ” å†ãƒ“ãƒ«ãƒ‰..."
            cd backend && npm run build > ../rebuild-backend.log 2>&1
            BACKEND_STATUS=$?
            cd ../frontend && npm run build > ../rebuild-frontend.log 2>&1
            FRONTEND_STATUS=$?
            cd ..

            if [ $BACKEND_STATUS -eq 0 ] && [ $FRONTEND_STATUS -eq 0 ]; then
              echo "âœ… ä¿®å¾©æˆåŠŸï¼ï¼ˆè©¦è¡Œå›æ•°: $ITERATIONï¼‰"
              FIXED=true
              echo "fixed=true" >> $GITHUB_OUTPUT
              echo "iterations=$ITERATION" >> $GITHUB_OUTPUT
              break
            fi

            echo "âŒ ä¿®å¾©å¤±æ•—ã€‚æ¬¡ã®è©¦è¡Œã¸..."
            ITERATION=$((ITERATION + 1))
            sleep 5
          done

          if [ "$FIXED" = "false" ]; then
            echo "âš ï¸ $MAX_ITERATIONS å›ã®è©¦è¡Œå¾Œã‚‚ä¿®å¾©ã§ãã¾ã›ã‚“ã§ã—ãŸ"
            echo "fixed=false" >> $GITHUB_OUTPUT
            echo "iterations=$ITERATION" >> $GITHUB_OUTPUT
          fi

      - name: âœ… Issueæ›´æ–°ï¼ˆä¿®å¾©æˆåŠŸï¼‰
        if: steps.auto-fix-loop.outputs.fixed == 'true'
        uses: actions/github-script@v7
        env:
          ISSUE_NUMBER: ${{ steps.detect-and-fix.outputs.issue_number }}
          ITERATIONS: ${{ steps.auto-fix-loop.outputs.iterations }}
        run: |
          await github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: process.env.ISSUE_NUMBER,
            body: `## âœ… è‡ªå‹•ä¿®å¾©æˆåŠŸï¼

            **ä¿®å¾©å®Œäº†:** ${new Date().toISOString()}
            **è©¦è¡Œå›æ•°:** ${process.env.ITERATIONS} / ${{ env.MAX_ITERATIONS }}

            ### ğŸ”§ å®Ÿæ–½ã—ãŸä¿®å¾©

            1. ESLintè‡ªå‹•ä¿®æ­£
            2. Prettierè‡ªå‹•ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
            3. TypeScriptãƒ“ãƒ«ãƒ‰ã®æ¤œè¨¼

            ãƒ“ãƒ«ãƒ‰ãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸã€‚ã“ã®Issueã‚’ã‚¯ãƒ­ãƒ¼ã‚ºã—ã¾ã™ã€‚
            `
          });

          await github.rest.issues.update({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: process.env.ISSUE_NUMBER,
            state: 'closed',
            labels: ['auto-fixed', 'resolved']
          });

      - name: âš ï¸ Issueæ›´æ–°ï¼ˆä¿®å¾©å¤±æ•—ï¼‰
        if: steps.auto-fix-loop.outputs.fixed == 'false'
        uses: actions/github-script@v7
        env:
          ISSUE_NUMBER: ${{ steps.detect-and-fix.outputs.issue_number }}
        run: |
          const fs = require('fs');
          const backendLog = fs.existsSync('rebuild-backend.log') ? fs.readFileSync('rebuild-backend.log', 'utf8') : '';
          const frontendLog = fs.existsSync('rebuild-frontend.log') ? fs.readFileSync('rebuild-frontend.log', 'utf8') : '';

          await github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: process.env.ISSUE_NUMBER,
            body: `## âš ï¸ è‡ªå‹•ä¿®å¾©å¤±æ•—

            **å¤±æ•—æ—¥æ™‚:** ${new Date().toISOString()}
            **è©¦è¡Œå›æ•°:** ${{ env.MAX_ITERATIONS }} å›

            ### âŒ æœ€çµ‚ãƒ“ãƒ«ãƒ‰ãƒ­ã‚°

            <details>
            <summary>ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰</summary>

            \`\`\`
            ${backendLog.slice(-2000)}
            \`\`\`

            </details>

            <details>
            <summary>ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰</summary>

            \`\`\`
            ${frontendLog.slice(-2000)}
            \`\`\`

            </details>

            ---

            **â° ${{ env.SLEEP_MINUTES }}åˆ†å¾Œã«å†è©¦è¡Œã—ã¾ã™...**
            `
          });

          await github.rest.issues.addLabels({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: process.env.ISSUE_NUMBER,
            labels: ['auto-fix-failed', 'needs-manual-review']
          });

      - name: ğŸ’¤ ã‚¹ãƒªãƒ¼ãƒ—ï¼ˆ15å›å¤±æ•—å¾Œï¼‰
        if: steps.auto-fix-loop.outputs.fixed == 'false'
        run: |
          echo "â° ${{ env.SLEEP_MINUTES }}åˆ†é–“å¾…æ©Ÿã—ã¾ã™..."
          sleep $((${{ env.SLEEP_MINUTES }} * 60))

      - name: ğŸ”„ å†å®Ÿè¡Œãƒˆãƒªã‚¬ãƒ¼ï¼ˆç„¡é™ãƒ«ãƒ¼ãƒ—ï¼‰
        if: steps.auto-fix-loop.outputs.fixed == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'auto-error-detection.yml',
              ref: 'main'
            });

            console.log('ğŸ”„ ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’å†ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã—ã¾ã—ãŸ');

      - name: ğŸ“ å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆï¼ˆä¿®å¾©æˆåŠŸæ™‚ï¼‰
        if: steps.auto-fix-loop.outputs.fixed == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          git add -A

          if git diff --staged --quiet; then
            echo "å¤‰æ›´ãªã—"
          else
            git commit -m "ğŸ¤– è‡ªå‹•ä¿®å¾©: ãƒ“ãƒ«ãƒ‰ã‚¨ãƒ©ãƒ¼ã‚’ä¿®æ­£

            - ESLintè‡ªå‹•ä¿®æ­£ã‚’é©ç”¨
            - Prettierãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’é©ç”¨
            - è©¦è¡Œå›æ•°: ${{ steps.auto-fix-loop.outputs.iterations }}/${{ env.MAX_ITERATIONS }}

            Issue: #${{ steps.detect-and-fix.outputs.issue_number }}

            Co-Authored-By: GitHub Actions <github-actions[bot]@users.noreply.github.com>"

            git push
            echo "âœ… å¤‰æ›´ã‚’ãƒ—ãƒƒã‚·ãƒ¥ã—ã¾ã—ãŸ"
          fi

      - name: ğŸ‰ æˆåŠŸé€šçŸ¥
        if: steps.analyze-errors.outputs.has_errors == 'false'
        run: |
          echo "âœ… ã‚¨ãƒ©ãƒ¼ã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ"
          echo "ğŸ‰ ã‚·ã‚¹ãƒ†ãƒ ã¯æ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã¾ã™"

  # å®šæœŸçš„ãªãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
  health-check:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'

    steps:
      - name: ğŸ“¥ ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: ğŸ¥ ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ
        run: |
          echo "ğŸ¥ ã‚·ã‚¹ãƒ†ãƒ ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯"
          echo "âœ… ãƒªãƒã‚¸ãƒˆãƒªã‚¢ã‚¯ã‚»ã‚¹: OK"
          echo "âœ… ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œ: OK"
          echo "ğŸ“… å®Ÿè¡Œæ—¥æ™‚: $(date)"

      - name: ğŸ“Š çµ±è¨ˆæƒ…å ±åé›†
        uses: actions/github-script@v7
        with:
          script: |
            // éå»24æ™‚é–“ã®Issueçµ±è¨ˆ
            const yesterday = new Date(Date.now() - 24 * 60 * 60 * 1000);

            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'all',
              since: yesterday.toISOString(),
              per_page: 100
            });

            const autoDetected = issues.data.filter(i =>
              i.labels.some(l => l.name === 'auto-detected')
            );

            const autoFixed = issues.data.filter(i =>
              i.labels.some(l => l.name === 'auto-fixed')
            );

            console.log('ğŸ“Š éå»24æ™‚é–“ã®çµ±è¨ˆ:');
            console.log(`  - æ¤œå‡ºã•ã‚ŒãŸã‚¨ãƒ©ãƒ¼: ${autoDetected.length}ä»¶`);
            console.log(`  - è‡ªå‹•ä¿®å¾©æˆåŠŸ: ${autoFixed.length}ä»¶`);
            console.log(`  - æˆåŠŸç‡: ${autoDetected.length > 0 ? Math.round(autoFixed.length / autoDetected.length * 100) : 0}%`);
